<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GameTracker</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
    .avatar-circle { border-radius: 50%; object-fit: cover; }
    .dragging { opacity: 0.5; border: 2px dashed #8b5cf6; }
    .drag-over-column { background-color: rgba(139, 92, 246, 0.1); }
    .drag-over-card { transform: scale(1.05); }

    .cropper-container {
        max-width: 100%;
    }
    .img-container {
        max-height: 50vh;
        margin-bottom: 1rem;
    }
    .img-container > img {
        max-width: 100%;
    }
    
    /* Liquid Eye Theme */
    .liquid-eye {
        --bg-color: #000000;
        --text-color: #ffffff;
        --primary-color: #ffffff;
        --secondary-color: #a0a0a0;
        --border-color: #444444;
        --card-bg: #101010;
        --header-bg: rgba(0, 0, 0, 0.7);
        --modal-bg: #111111;
        --button-bg: #ffffff;
        --button-text: #000000;
        --button-hover-bg: #e0e0e0;
        --input-bg: #222222;
    }
    
    .liquid-eye .bg-gradient-to-br, .liquid-eye .bg-gradient-to-r { background: var(--bg-color); }
    .liquid-eye body, .liquid-eye #root { background-color: var(--bg-color); color: var(--text-color); }
    .liquid-eye header { background-color: var(--header-bg) !important; border-bottom-color: var(--border-color) !important; }
    .liquid-eye .text-transparent { color: var(--text-color) !important; }
    .liquid-eye .bg-clip-text { -webkit-background-clip: unset !important; background-clip: unset !important; background: none !important; }
    .liquid-eye .border-purple-500\/30, .liquid-eye .border-blue-500\/30, .liquid-eye .border-green-500\/30, .liquid-eye .border-red-500\/30, .liquid-eye .border-orange-500\/30 { border-color: var(--border-color) !important; }
    .liquid-eye .bg-gray-900\/90, .liquid-eye .bg-gray-900, .liquid-eye .bg-gray-800, .liquid-eye .bg-gray-800\/90 { background-color: var(--card-bg) !important; }
    .liquid-eye .bg-gray-800\/95 { background-color: var(--modal-bg) !important; }
    .liquid-eye .from-purple-500\/20, .liquid-eye .to-pink-500\/20, .liquid-eye .from-blue-500\/20, .liquid-eye .from-green-500\/20, .liquid-eye .from-red-500\/20 { background: var(--card-bg) !important; }
    .liquid-eye input, .liquid-eye textarea, .liquid-eye select { background-color: var(--input-bg) !important; border-color: var(--border-color) !important; color: var(--text-color) !important; }
    .liquid-eye .text-purple-400, .liquid-eye .text-red-400, .liquid-eye .text-blue-400, .liquid-eye .text-green-400 { color: var(--primary-color) !important; }
    .liquid-eye .text-gray-300, .liquid-eye .text-gray-400 { color: var(--secondary-color) !important; }
    .liquid-eye button.bg-gradient-to-r { background: var(--button-bg) !important; color: var(--button-text) !important; }
    .liquid-eye button.bg-gradient-to-r:hover { background: var(--button-hover-bg) !important; }
    .liquid-eye .hover\:border-purple-500:hover { border-color: var(--primary-color) !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, Fragment, useCallback } = React;
    const API_URL = 'https://gametracker-backend-production.up.railway.app';
    const REACTION_EMOJIS = ['😍', '🔥', '👍', '😮', '😂', '👎', '❤️', '🤔', '😢', '🤯', '😴', '💯', '💀', '🤨', '🥳'];
    const GAMES_PER_COLUMN = 5;

    const Icon = ({ name, className = "w-5 h-5" }) => {
      const icons = {
        arrowLeft: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>,
        arrowRight: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>,
        youtube: <svg className={className} viewBox="0 0 24 24" fill="currentColor"><path d="M10,15L15.19,12L10,9V15M21.56,7.17C21.69,7.64 21.78,8.27 21.84,9.07C21.91,9.87 21.94,10.56 21.94,11.16L22,12C22,14.19 21.84,15.8 21.56,16.83C21.31,17.73 20.73,18.31 19.83,18.56C19.36,18.69 18.73,18.78 17.93,18.84C17.13,18.91 16.44,18.94 15.84,18.94L15,19C12.81,19 11.2,18.84 10.17,18.56C9.27,18.31 8.69,17.73 8.44,16.83C8.31,16.36 8.22,15.73 8.16,14.93C8.09,14.13 8.06,13.44 8.06,12.84L8,12C8,9.81 8.16,8.2 8.44,7.17C8.69,6.27 9.27,5.69 10.17,5.44C10.64,5.31 11.27,5.22 12.07,5.16C12.87,5.09 13.56,5.06 14.16,5.06L15,5C17.19,5 18.8,5.16 19.83,5.44C20.73,5.69 21.31,6.27 21.56,7.17Z"></path></svg>,
        bell: <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>,
        search: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>,
        user: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
        users: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
        settings: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
        logout: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>,
        star: <svg className={className} fill="currentColor" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
        trash: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
        x: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        loader: <svg className={className + " animate-spin"} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>,
        upload: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>,
        globe: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 1.53 0 0 1-4 10 15.3 1.53 0 0 1-4-10 15.3 1.53 0 0 1 4-10z"/></svg>,
        edit: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
        tag: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
        userPlus: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
        userCheck: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>,
        userClock: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><circle cx="18" cy="18" r="3" /><path d="M20.5 16.5 18 18l.5 2.5"/></svg>,
        check: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
      };
      return icons[name] || null;
    };

    const Avatar = ({ src, size = 'md', className = '' }) => {
      const sizes = { sm: 'w-8 h-8', md: 'w-12 h-12', lg: 'w-20 h-20', xl: 'w-32 h-32' };
      return src ? (
        <img src={src} className={`${sizes[size]} avatar-circle ${className}`} alt="avatar" />
      ) : (
        <div className={`${sizes[size]} avatar-circle bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold ${className}`}>
          <Icon name="user" className={size === 'sm' ? 'w-4 h-4' : 'w-6 h-6'} />
        </div>
      );
    };
    
    const AvatarCropModal = ({ src, onCancel, onComplete }) => {
        const imageRef = useRef(null);
        const [cropper, setCropper] = useState(null);

        useEffect(() => {
            if (imageRef.current) {
                const instance = new Cropper(imageRef.current, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    background: false,
                    autoCropArea: 0.8,
                });
                setCropper(instance);
            }
            return () => {
                if (cropper) {
                    cropper.destroy();
                }
            };
        }, [imageRef]);

        const handleCrop = () => {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({
                    width: 128,
                    height: 128,
                    imageSmoothingQuality: 'high',
                });
                onComplete(canvas.toDataURL('image/jpeg', 0.9));
            }
        };

        return (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-lg border border-purple-500/30">
                    <h2 className="text-2xl font-bold text-white mb-4">Обрезать аватар</h2>
                    <div className="img-container">
                        <img ref={imageRef} src={src} alt="Source" />
                    </div>
                    <div className="flex gap-2 mt-6">
                        <button onClick={handleCrop} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg hover:from-purple-600 hover:to-pink-600">Сохранить</button>
                        <button onClick={onCancel} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">Отмена</button>
                    </div>
                </div>
            </div>
        );
    };

    const ActivityFeed = ({ token }) => {
        const [activities, setActivities] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const fetchActivities = async () => {
                if (!token) return;
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/api/friends/activity`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setActivities(data.activities);
                    }
                } catch (err) {
                    console.error("Failed to fetch activities", err);
                } finally {
                    setLoading(false);
                }
            };
            fetchActivities();
            const interval = setInterval(fetchActivities, 60000); // Refresh every minute
            return () => clearInterval(interval);
        }, [token]);
        
        const boardTitles = {
            backlog: 'Беклог',
            playing: 'Играю',
            completed: 'Пройдено',
            dropped: 'Брошено'
        };

        const formatActivity = (act) => {
            const { username, action_type, details } = act;
            const gameName = <span className="font-bold text-purple-300">{details.gameName}</span>;
            switch (action_type) {
                case 'add_game':
                    return <>{username} добавил {gameName} в <span className="italic">{boardTitles[details.board]}</span></>;
                case 'move_game':
                    return <>{username} переместил {gameName} из <span className="italic">{boardTitles[details.fromBoard]}</span> в <span className="italic">{boardTitles[details.toBoard]}</span></>;
                case 'remove_game':
                     return <>{username} удалил {gameName}</>;
                case 'complete_game':
                    return <><span className="text-green-400 font-semibold">{username}</span> прошел игру {gameName}! 🎉</>;
                default:
                    return `${username} ${action_type}`;
            }
        };
        
        return (
            <div className="mt-8 md:mt-12">
                {loading ? (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-10 flex items-center justify-center">
                        <Icon name="loader" className="w-8 h-8 text-purple-400"/>
                    </div>
                ) : activities.length > 0 ? (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {activities.map(act => (
                                <div key={act.id} className="text-sm text-gray-300 p-4 bg-gray-800/80 rounded-lg border border-gray-700 hover:border-purple-500/50 transition-colors">
                                    <p>{formatActivity(act)}</p>
                                    <div className="text-xs text-gray-500 mt-2 text-right">{new Date(act.created_at).toLocaleString('ru-RU')}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                ) : (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-10 flex items-center justify-center text-gray-400 text-center">
                        Пока нет активности от ваших друзей.
                    </div>
                )}
            </div>
        );
    };

    const GameKanban = () => {
      const [user, setUser] = useState(null);
      const [showAuth, setShowAuth] = useState(true);
      const [authMode, setAuthMode] = useState('login');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [showSearch, setShowSearch] = useState(false);
      const [searching, setSearching] = useState(false);
      const [showProfile, setShowProfile] = useState(false);
      const [showUserHub, setShowUserHub] = useState(false);
      const [allUsers, setAllUsers] = useState([]);
      const [userSearchQuery, setUserSearchQuery] = useState('');
      const [friends, setFriends] = useState([]);
      const [friendRequests, setFriendRequests] = useState([]);
      const [sentRequests, setSentRequests] = useState([]);
      const [selectedGame, setSelectedGame] = useState(null);
      const [viewingUser, setViewingUser] = useState(null);
      const [friendshipStatus, setFriendshipStatus] = useState('none');
      const [userNickname, setUserNickname] = useState('');
      const [editingNickname, setEditingNickname] = useState(false);
      const [uploadingAvatar, setUploadingAvatar] = useState(false);
      const fileInputRef = useRef(null);
      const [theme, setTheme] = useState('default');
      const [confirmingDeleteFriend, setConfirmingDeleteFriend] = useState(null);
      const [confirmingAddFriend, setConfirmingAddFriend] = useState(null);
      const dragItem = useRef(null);
      const [expandedColumns, setExpandedColumns] = useState({});
      const [formData, setFormData] = useState({ username: '', email: '', password: '' });
      const [profileData, setProfileData] = useState({ username: '', bio: '', theme: 'default', currentPassword: '', newPassword: '' });
      const [imageForCrop, setImageForCrop] = useState(null);
      const [gameForReview, setGameForReview] = useState(null);

      const [boards, setBoards] = useState({
        backlog: { id: 'backlog', title: 'Беклог', emoji: '📋', color: 'from-blue-500/20 to-cyan-500/20', borderColor: 'border-blue-500/30', cards: [] },
        playing: { id: 'playing', title: 'Играю', emoji: '🎮', color: 'from-purple-500/20 to-pink-500/20', borderColor: 'border-purple-500/30', cards: [] },
        completed: { id: 'completed', title: 'Пройдено', emoji: '✅', color: 'from-green-500/20 to-emerald-500/20', borderColor: 'border-green-500/30', cards: [] },
        dropped: { id: 'dropped', title: 'Брошено', emoji: '❌', color: 'from-red-500/20 to-orange-500/20', borderColor: 'border-red-500/30', cards: [] }
      });

      const loadBoards = useCallback(async (token, userId = null) => {
        try {
          const url = userId ? `${API_URL}/api/user/${userId}/boards` : `${API_URL}/api/user/boards`;
          const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (response.ok) {
            const data = await response.json();
            if (userId) {
              setViewingUser(data.user);
              setFriendshipStatus(data.friendship);
              setUserNickname(data.nickname || '');
            } else {
               setViewingUser(null);
            }
            if (data.boards) {
              setBoards(prev => ({
                backlog: { ...prev.backlog, cards: data.boards.backlog || [] },
                playing: { ...prev.playing, cards: data.boards.playing || [] },
                completed: { ...prev.completed, cards: data.boards.completed || [] },
                dropped: { ...prev.dropped, cards: data.boards.dropped || [] }
              }));
            }
          }
        } catch (err) {
          console.error('Ошибка загрузки:', err);
        }
      }, []);

      useEffect(() => {
        const token = localStorage.getItem('token');
        const savedUser = localStorage.getItem('user');
        if (token && savedUser) {
          const parsedUser = JSON.parse(savedUser);
          setUser(parsedUser);
          setTheme(parsedUser.theme || 'default');
          setShowAuth(false);
          loadBoards(token);
        }
      }, [loadBoards]);
      
      useEffect(() => {
        document.body.className = theme;
      }, [theme]);

      const loadFriends = useCallback(async () => {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
          const response = await fetch(`${API_URL}/api/friends`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setFriends(data.friends || []);
            setFriendRequests(data.requests || []);
            setSentRequests(data.sentRequests || []);
          }
        } catch (err) {
          console.error('Ошибка загрузки друзей:', err);
        }
      }, []);
      
      useEffect(() => {
        loadFriends();
      }, [user, loadFriends])

      const loadAllUsers = useCallback(async (query = '') => {
        const token = localStorage.getItem('token');
        try {
          const url = query 
            ? `${API_URL}/api/users?q=${encodeURIComponent(query)}` 
            : `${API_URL}/api/users`;
          const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (response.ok) {
            const data = await response.json();
            setAllUsers(data.users || []);
          }
        } catch (err) {
          console.error('Ошибка загрузки пользователей:', err);
        }
      }, []);

      const handleAuth = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const endpoint = authMode === 'login' ? '/api/auth/login' : '/api/auth/register';
          const response = await fetch(`${API_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          const data = await response.json();
          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            setUser(data.user);
            setTheme(data.user.theme || 'default');
            setShowAuth(false);
            loadBoards(data.token);
            loadFriends(data.token);
          } else {
            setError(data.error || 'Ошибка авторизации');
          }
        } catch (err) {
          setError('Ошибка подключения к серверу');
        } finally {
          setLoading(false);
        }
      };

      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = () => {
                setImageForCrop(reader.result);
            };
            reader.readAsDataURL(file);
        }
      };
      
      const handleAvatarUpdate = async (croppedImage) => {
          setImageForCrop(null);
          setUploadingAvatar(true);
          try {
              const token = localStorage.getItem('token');
              const response = await fetch(`${API_URL}/api/profile/avatar`, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ avatar: croppedImage })
              });
              if (response.ok) {
                  const data = await response.json();
                  setUser(data.user);
                  localStorage.setItem('user', JSON.stringify(data.user));
                  alert('Аватар обновлен!');
              } else {
                  alert('Ошибка загрузки аватара');
              }
          } catch (err) {
              console.error('Ошибка загрузки аватара:', err);
              alert('Ошибка загрузки аватара');
          } finally {
              setUploadingAvatar(false);
          }
      };


      const handleSearch = async (query) => {
        setSearchQuery(query);
        if (query.length < 3) {
          setSearchResults([]);
          return;
        }
        setSearching(true);
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/games/search?q=${encodeURIComponent(query)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setSearchResults(data.games || []);
          }
        } catch (err) {
          console.error('Ошибка поиска:', err);
        } finally {
          setSearching(false);
        }
      };

      const addGameToBoard = async (game, boardId) => {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/user/boards/${boardId}/games`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ game })
          });
          
          if (response.ok) {
            await loadBoards(token);
            setShowSearch(false);
            setSearchQuery('');
            setSearchResults([]);
          } else {
            const data = await response.json();
            alert('Ошибка добавления игры: ' + (data.error || 'Неизвестная ошибка'));
          }
        } catch (err) {
          alert('Ошибка добавления игры');
        }
      };

      const deleteCard = async (e, cardId) => {
        e.stopPropagation();
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/user/games/${cardId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          loadBoards(token);
        } catch (err) {
          console.error('Ошибка удаления:', err);
        }
      };

      const updateGame = useCallback(async (gameId, updates) => {
        setBoards(prevBoards => {
            const newBoards = JSON.parse(JSON.stringify(prevBoards));
            for (const boardId in newBoards) {
                const cardIndex = newBoards[boardId].cards.findIndex(c => c.id === gameId);
                if (cardIndex > -1) {
                    newBoards[boardId].cards[cardIndex] = { ...newBoards[boardId].cards[cardIndex], ...updates };
                    break;
                }
            }
            return newBoards;
        });
        
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/user/games/${gameId}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(updates)
          });
        } catch (err) {
          console.error('Ошибка обновления:', err);
          loadBoards(localStorage.getItem('token'));
        }
      }, [loadBoards]);
      
      
      const updateBoardOrder = useCallback(async (boardId, orderedIds) => {
         const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/user/boards/reorder`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ boardId, orderedIds })
          });
        } catch (err) {
          console.error('Ошибка обновления порядка:', err);
          loadBoards(localStorage.getItem('token'));
        }
      }, [loadBoards]);
      
      const submitDeepReview = useCallback(async (gameId, answers) => {
          const token = localStorage.getItem('token');
          try {
             await fetch(`${API_URL}/api/games/${gameId}/deep-review`, {
                 method: 'POST',
                 headers: {
                     'Authorization': `Bearer ${token}`,
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify({ answers })
             });
             await loadBoards(token);
             setGameForReview(null);
          } catch(err) {
              console.error('Ошибка сохранения отзыва:', err);
              alert('Не удалось сохранить отзыв');
          }
      }, [loadBoards]);

      const handleDeleteReview = useCallback(async (gameId) => {
          if (!window.confirm("Вы уверены, что хотите удалить этот детальный отзыв?")) return;
          
          const token = localStorage.getItem('token');

          setBoards(prevBoards => {
              const newBoards = JSON.parse(JSON.stringify(prevBoards));
              const card = newBoards.completed.cards.find(c => c.id === gameId);
              if (card) card.deep_review_answers = null;
              return newBoards;
          });
          setSelectedGame(prev => ({...prev, deep_review_answers: null}));

          try {
             await fetch(`${API_URL}/api/games/${gameId}/deep-review`, {
                 method: 'DELETE',
                 headers: { 'Authorization': `Bearer ${token}` }
             });
          } catch(err) {
              console.error('Ошибка удаления отзыва:', err);
              alert('Не удалось удалить отзыв');
              loadBoards(token); // Revert on error
          }
      }, [loadBoards]);

      const addReaction = async (gameId, emoji) => {
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/games/${gameId}/reactions`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ emoji })
          });
          loadBoards(token, viewingUser?.id);
        } catch (err) {
          console.error('Ошибка реакции:', err);
        }
      };

      const friendAction = async (friendId, action) => {
        const token = localStorage.getItem('token');
        let endpoint = '';
        let method = 'POST';
        let body = { friendId: Number(friendId) }; 
        switch(action) {
            case 'request': endpoint = '/api/friends/request'; break;
            case 'accept': endpoint = '/api/friends/accept'; break;
            case 'reject': endpoint = '/api/friends/reject'; break;
            case 'remove': 
                endpoint = `/api/friends/${friendId}`; 
                method = 'DELETE'; 
                body = undefined;
                break;
            default: return;
        }

        try {
            const response = await fetch(`${API_URL}${endpoint}`, {
                method,
                headers: { 
                  'Authorization': `Bearer ${token}`, 
                  'Content-Type': 'application/json' 
                },
                body: body ? JSON.stringify(body) : null
            });
            if(!response.ok) {
              const err = await response.json();
              throw new Error(err.error || "Friend action failed")
            }
            await loadFriends();
            if (viewingUser && viewingUser.id == friendId) {
                await loadBoards(token, friendId);
            }
             if (showUserHub) {
                loadAllUsers(userSearchQuery);
            }
        } catch(err) {
            console.error(`Ошибка действия '${action}':`, err);
        }
      };
      
      const updateNickname = async (friendId, nickname) => {
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/friends/${friendId}/nickname`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nickname })
          });
          setUserNickname(nickname);
          setEditingNickname(false);
          loadFriends();
        } catch (err) {
          console.error('Ошибка обновления метки:', err);
        }
      };
      
      const handleDragStart = (e, card, boardId, index) => {
        dragItem.current = { card, sourceBoardId: boardId, sourceIndex: index };
        setTimeout(() => e.target.classList.add('dragging'), 0);
      };

      const handleDragOver = (e) => e.preventDefault();
      
      const handleDragEnterColumn = (e) => e.currentTarget.classList.add('drag-over-column');
      const handleDragLeaveColumn = (e) => e.currentTarget.classList.remove('drag-over-column');
      const handleDragEnterCard = (e) => e.currentTarget.classList.add('drag-over-card');
      const handleDragLeaveCard = (e) => e.currentTarget.classList.remove('drag-over-card');

      const handleDrop = (e, targetBoardId, targetIndex) => {
        e.preventDefault();
        e.stopPropagation();

        if (!dragItem.current) return;
        
        const { card: draggedCard, sourceBoardId, sourceIndex } = dragItem.current;
        
        if (sourceBoardId === targetBoardId && sourceIndex === targetIndex) {
            return;
        }

        setBoards(prevBoards => {
            const newBoards = JSON.parse(JSON.stringify(prevBoards));
            
            const [movedItem] = newBoards[sourceBoardId].cards.splice(sourceIndex, 1);
            
            if (targetIndex === undefined) {
                newBoards[targetBoardId].cards.push(movedItem);
            } else {
                newBoards[targetBoardId].cards.splice(targetIndex, 0, movedItem);
            }
            
            if(sourceBoardId === targetBoardId) {
                const orderedIds = newBoards[targetBoardId].cards.map(c => c.id);
                updateBoardOrder(targetBoardId, orderedIds);
            }

            return newBoards;
        });
        
        if (sourceBoardId !== targetBoardId) {
            updateGame(draggedCard.id, { board: targetBoardId });
        }

        dragItem.current = null;
      };

      const handleDragEnd = () => {
        document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
        document.querySelectorAll('.drag-over-column').forEach(el => el.classList.remove('drag-over-column'));
        document.querySelectorAll('.drag-over-card').forEach(el => el.classList.remove('drag-over-card'));
        dragItem.current = null;
      };


      const handleLogout = () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        setUser(null);
        setShowAuth(true);
        setViewingUser(null);
        setTheme('default');
      };

      const updateProfile = async () => {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/profile`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({...profileData, theme})
          });
          if (response.ok) {
            const data = await response.json();
            setUser(data.user);
            setTheme(data.user.theme);
            localStorage.setItem('user', JSON.stringify(data.user));
            if (data.token) {
              localStorage.setItem('token', data.token);
            }
            setShowProfile(false);
            setProfileData({ username: '', bio: '', currentPassword: '', newPassword: '' });
            alert('Профиль обновлен!');
          } else {
            const errorData = await response.json();
            alert(errorData.error || 'Ошибка обновления');
          }
        } catch (err) {
          alert('Ошибка обновления профиля');
        }
      };
      
      const FriendActionButton = ({ targetUser }) => {
        if (!user || user.id === targetUser.id) return null;
        if (friendshipStatus === 'friends') {
            return <button onClick={() => setConfirmingDeleteFriend(targetUser)} className="flex items-center gap-1 p-2 bg-green-500/20 hover:bg-red-500/20 rounded-lg border border-green-500/30 hover:border-red-500/30 transition-all"><Icon name="userCheck" className="w-4 h-4 md:w-5 md:h-5 text-green-400" /></button>;
        }
        if (friendshipStatus === 'request_sent') {
            return <button onClick={() => friendAction(targetUser.id, 'reject')} className="flex items-center gap-1 p-2 bg-yellow-500/20 rounded-lg border border-yellow-500/30"><Icon name="userClock" className="w-4 h-4 md:w-5 md:h-5 text-yellow-400" /></button>;
        }
        if (friendshipStatus === 'request_received') {
            return (
                <div className="flex gap-2">
                    <button onClick={() => setConfirmingAddFriend(targetUser)} className="flex items-center gap-1 p-2 bg-green-500/20 hover:bg-green-500/30 rounded-lg border border-green-500/30"><Icon name="check" className="w-4 h-4 md:w-5 md:h-5 text-green-400" /></button>
                    <button onClick={() => friendAction(targetUser.id, 'reject')} className="flex items-center gap-1 p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg border border-red-500/30"><Icon name="x" className="w-4 h-4 md:w-5 md:h-5 text-red-400" /></button>
                </div>
            );
        }
        return <button onClick={() => friendAction(targetUser.id, 'request')} className="flex items-center gap-1 p-2 bg-purple-500/20 hover:bg-purple-500/30 rounded-lg border border-purple-500/30 transition-all"><Icon name="userPlus" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" /></button>;
    };
    
    const UserListFriendButton = ({ targetUser }) => {
        const isFriend = friends.some(f => f.id === targetUser.id);
        const isRequestReceived = friendRequests.some(r => r.id === targetUser.id);
        const isRequestSent = sentRequests.includes(targetUser.id);

        if (isFriend) {
            return <button onClick={() => setConfirmingDeleteFriend(targetUser)} className="p-2 bg-green-500/20 hover:bg-red-500/20 rounded-lg transition-all"><Icon name="userCheck" className="w-5 h-5 text-green-400" /></button>;
        }
        if (isRequestReceived) {
            return (<div className="flex gap-2">
                <button onClick={() => setConfirmingAddFriend(targetUser)} className="p-2 bg-green-500/20 hover:bg-green-500/30 rounded-lg"><Icon name="check" className="w-5 h-5 text-green-400" /></button>
                <button onClick={() => friendAction(targetUser.id, 'reject')} className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg"><Icon name="x" className="w-5 h-5 text-red-400" /></button>
            </div>);
        }
        if (isRequestSent) {
            return <button onClick={() => friendAction(targetUser.id, 'reject')} className="p-2 bg-yellow-500/20 hover:bg-red-500/20 rounded-lg"><Icon name="userClock" className="w-5 h-5 text-yellow-400" /></button>;
        }
        return <button onClick={() => friendAction(targetUser.id, 'request')} className="p-2 bg-purple-500/20 hover:bg-purple-500/30 rounded-lg"><Icon name="userPlus" className="w-5 h-5 text-purple-400" /></button>;
    };

      const toggleColumnExpansion = (boardId) => {
        setExpandedColumns(prev => ({...prev, [boardId]: !prev[boardId]}));
      };

      if (showAuth) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
            <div className="bg-gray-900/90 backdrop-blur-xl rounded-2xl p-8 w-full max-w-md border border-purple-500/30 shadow-2xl">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4 animate-pulse">🎮</div>
                <h1 className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 mb-2">GameTracker</h1>
                <p className="text-gray-400 text-lg">Твой игровой прогресс</p>
              </div>
              <div className="flex gap-2 mb-6">
                <button onClick={() => { setAuthMode('login'); setError(''); }} className={`flex-1 py-3 rounded-lg font-semibold transition-all ${authMode === 'login' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>Вход</button>
                <button onClick={() => { setAuthMode('register'); setError(''); }} className={`flex-1 py-3 rounded-lg font-semibold transition-all ${authMode === 'register' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>Регистрация</button>
              </div>
              {error && <div className="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-sm">{error}</div>}
              <div className="space-y-4">
                <input type="text" placeholder="Логин" value={formData.username} onChange={(e) => setFormData({ ...formData, username: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />
                <input type="password" placeholder="Пароль" value={formData.password} onChange={(e) => setFormData({ ...formData, password: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />
                {authMode === 'register' && <input type="email" placeholder="Email" value={formData.email} onChange={(e) => setFormData({ ...formData, email: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />}
                <button onClick={handleAuth} disabled={loading} className="w-full py-3 bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 text-white font-bold rounded-lg hover:from-purple-600 hover:via-pink-600 hover:to-blue-600 transition-all transform hover:scale-105 shadow-xl disabled:opacity-50 flex items-center justify-center gap-2">
                  {loading ? <><Icon name="loader" className="w-5 h-5" />Загрузка...</> : (authMode === 'login' ? '🚀 Войти' : '✨ Зарегистрироваться')}
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className={`min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-blue-900 ${theme} flex flex-col`}>
          {imageForCrop && <AvatarCropModal src={imageForCrop} onCancel={() => setImageForCrop(null)} onComplete={handleAvatarUpdate} />}
          {gameForReview && <DeepReviewModal game={gameForReview} existingAnswers={gameForReview.deep_review_answers} onClose={() => setGameForReview(null)} onSubmit={submitDeepReview} />}
          <header className="bg-gray-900/50 backdrop-blur-xl border-b border-purple-500/30 sticky top-0 z-50 flex-shrink-0">
            <div className="container mx-auto px-4 py-4">
              <div className="flex items-center justify-between flex-wrap gap-4">
                <div className="flex items-center gap-4 flex-wrap">
                  <h1 onClick={() => { setViewingUser(null); loadBoards(localStorage.getItem('token')); }} className="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 cursor-pointer">🎮 GameTracker</h1>
                  {!viewingUser && (
                    <div className="relative">
                      <button onClick={() => setShowSearch(!showSearch)} className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 hover:from-purple-500/30 hover:to-pink-500/30 rounded-lg transition-all border border-purple-500/30">
                        <Icon name="search" className="w-4 h-4 text-purple-400" />
                        <span className="text-gray-300 font-semibold text-sm md:text-base">Добавить игру</span>
                      </button>
                      {showSearch && (
                        <div className="absolute top-full mt-2 left-0 w-80 md:w-96 bg-gray-800/95 backdrop-blur-xl rounded-lg shadow-2xl border border-purple-500/30 p-4 z-50">
                          <div className="flex items-center gap-2 mb-3">
                            <input type="text" value={searchQuery} onChange={(e) => handleSearch(e.target.value)} placeholder="Поиск игры..." className="flex-1 px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white text-sm" autoFocus />
                            <button onClick={() => { setShowSearch(false); setSearchQuery(''); setSearchResults([]); }} className="p-2 hover:bg-gray-700 rounded-lg">
                              <Icon name="x" className="w-5 h-5 text-gray-400" />
                            </button>
                          </div>
                          <div className="space-y-2 max-h-80 overflow-y-auto">
                            {searching ? (
                              <div className="flex items-center justify-center py-8">
                                <Icon name="loader" className="w-6 h-6 text-purple-400" />
                              </div>
                            ) : searchResults.length > 0 ? (
                              searchResults.map(game => (
                                <div key={game.id} className="flex items-center gap-3 p-2 hover:bg-gray-700 rounded-lg">
                                  {game.cover ? <img src={game.cover} alt={game.name} className="w-10 h-14 object-cover rounded" /> : <div className="w-10 h-14 bg-gray-700 rounded flex items-center justify-center text-xl">🎮</div>}
                                  <div className="flex-1 min-w-0">
                                    <p className="text-white font-semibold text-sm truncate">{game.name}</p>
                                    {game.genres && game.genres.length > 0 && <p className="text-xs text-gray-400 truncate">{game.genres.slice(0, 2).join(', ')}</p>}
                                  </div>
                                  <select onChange={(e) => e.target.value && addGameToBoard(game, e.target.value)} className="px-2 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white cursor-pointer" defaultValue="">
                                    <option value="" disabled>+</option>
                                    <option value="backlog">📋 Беклог</option>
                                    <option value="playing">🎮 Играю</option>
                                    <option value="completed">✅ Пройдено</option>
                                    <option value="dropped">❌ Брошено</option>
                                  </select>
                                </div>
                              ))
                            ) : searchQuery.length >= 3 ? (
                              <p className="text-gray-400 text-center py-4 text-sm">Не найдено</p>
                            ) : (
                              <p className="text-gray-400 text-center py-4 text-sm">Минимум 3 символа</p>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2 md:gap-3">
                  <div className="flex items-center gap-2 px-3 md:px-4 py-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg border border-purple-500/30">
                    <Avatar src={viewingUser ? viewingUser.avatar : user?.avatar} size="sm" />
                    <div>
                      <span className="text-white font-semibold text-sm md:text-base block">{viewingUser ? (userNickname || viewingUser.username) : user?.username}</span>
                      {viewingUser && userNickname && <span className="text-xs text-gray-400">@{viewingUser.username}</span>}
                    </div>
                  </div>
                  {viewingUser ? (
                    <Fragment>
                      {friendshipStatus === 'friends' && (
                        <button onClick={() => setEditingNickname(true)} className="p-2 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg border border-blue-500/30">
                          <Icon name="tag" className="w-4 h-4 md:w-5 md:h-5 text-blue-400" />
                        </button>
                      )}
                      <FriendActionButton targetUser={viewingUser} />
                      <button onClick={() => { setViewingUser(null); loadBoards(localStorage.getItem('token')); }} className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700">
                        <Icon name="x" className="w-4 h-4 md:w-5 md:h-5 text-gray-400" />
                      </button>
                    </Fragment>
                  ) : (
                    <Fragment>
                      <button onClick={() => { setShowUserHub(true); loadAllUsers(); }} className="p-2 hover:bg-gray-800 rounded-lg border border-purple-500/30 relative">
                        <Icon name="users" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" />
                        {friendRequests.length > 0 && <span className="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white"></span>}
                      </button>
                      <button onClick={() => setShowProfile(true)} className="p-2 hover:bg-gray-800 rounded-lg border border-purple-500/30">
                        <Icon name="settings" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" />
                      </button>
                    </Fragment>
                  )}
                  <button onClick={handleLogout} className="p-2 hover:bg-red-900/50 rounded-lg border border-red-500/30">
                    <Icon name="logout" className="w-4 h-4 md:w-5 md:h-5 text-red-400" />
                  </button>
                </div>
              </div>
            </div>
          </header>

          <main className="flex-grow">
              {showProfile && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 max-h-[90vh] overflow-y-auto">
                      <h2 className="text-2xl font-bold text-white mb-4">Настройки профиля</h2>
                      <div className="space-y-4">
                      <div className="flex flex-col items-center gap-3">
                          <Avatar src={user?.avatar} size="xl" />
                          <input type="file" ref={fileInputRef} onChange={handleFileSelect} accept="image/*" className="hidden" />
                          <button onClick={() => fileInputRef.current?.click()} disabled={uploadingAvatar} className="flex items-center gap-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-all disabled:opacity-50">
                          {uploadingAvatar ? <Icon name="loader" className="w-4 h-4" /> : <Icon name="upload" className="w-4 h-4" />}
                          {uploadingAvatar ? 'Загрузка...' : 'Загрузить аватар'}
                          </button>
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">Имя пользователя:</label>
                          <input type="text" value={profileData.username} onChange={(e) => setProfileData({ ...profileData, username: e.target.value })} placeholder={user?.username} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">О себе:</label>
                          <textarea value={profileData.bio} onChange={(e) => setProfileData({ ...profileData, bio: e.target.value })} placeholder={user?.bio || "Расскажи о себе..."} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" rows="3" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">Тема оформления:</label>
                          <div className="flex gap-2 mt-1">
                              <button onClick={() => setTheme('default')} className={`flex-1 py-2 rounded-lg text-sm ${theme === 'default' ? 'bg-purple-500 text-white' : 'bg-gray-800'}`}>Стандартная</button>
                              <button onClick={() => setTheme('liquid-eye')} className={`flex-1 py-2 rounded-lg text-sm ${theme === 'liquid-eye' ? 'bg-white text-black' : 'bg-gray-800'}`}>Liquid Eye</button>
                          </div>
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">Текущий пароль (для изменения):</label>
                          <input type="password" value={profileData.currentPassword} onChange={(e) => setProfileData({ ...profileData, currentPassword: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">Новый пароль:</label>
                          <input type="password" value={profileData.newPassword} onChange={(e) => setProfileData({ ...profileData, newPassword: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      <div className="flex gap-2 mt-6">
                          <button onClick={updateProfile} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg hover:from-purple-600 hover:to-pink-600">Сохранить</button>
                          <button onClick={() => setShowProfile(false)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">Отмена</button>
                      </div>
                      </div>
                  </div>
                  </div>
              )}
              
              {editingNickname && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30">
                      <h2 className="text-xl font-bold text-white mb-4">Изменить метку для {viewingUser?.username}</h2>
                      <input type="text" value={userNickname} onChange={(e) => setUserNickname(e.target.value)} placeholder="Например: Лучший друг, Коллега..." className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mb-4" />
                      <div className="flex gap-2">
                      <button onClick={() => updateNickname(viewingUser.id, userNickname)} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg">Сохранить</button>
                      <button onClick={() => setEditingNickname(false)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg">Отмена</button>
                      </div>
                  </div>
                  </div>
              )}

              {showUserHub && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-3xl border border-purple-500/30 max-h-[80vh] flex flex-col">
                      <div className="flex justify-between items-center mb-4 flex-shrink-0">
                      <h2 className="text-2xl font-bold text-white">Сообщество</h2>
                      <button onClick={() => setShowUserHub(false)} className="p-2 hover:bg-gray-800 rounded-lg"><Icon name="x" className="w-5 h-5 text-gray-400" /></button>
                      </div>
                      
                      <div className="overflow-y-auto">
                          {friendRequests.length > 0 && (
                              <div className="mb-6">
                                  <h3 className="text-lg font-bold text-white mb-3">Запросы в друзья ({friendRequests.length})</h3>
                                  <div className="space-y-3">
                                      {friendRequests.map(req => (
                                          <div key={req.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                                              <Avatar src={req.avatar} size="md" />
                                              <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), req.id); setShowUserHub(false); }}>
                                                  <p className="text-white font-semibold">{req.username}</p>
                                              </div>
                                              <UserListFriendButton targetUser={req} />
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          )}

                          {friends.length > 0 && (
                          <div className="mb-6">
                              <h3 className="text-lg font-bold text-white mb-3">Мои друзья ({friends.length})</h3>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {friends.map(friend => (
                                  <div key={friend.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg group">
                                  <Avatar src={friend.avatar} size="md" />
                                  <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), friend.id); setShowUserHub(false); }}>
                                      <p className="text-white font-semibold">{friend.nickname || friend.username}</p>
                                      {friend.nickname && <p className="text-xs text-gray-400">@{friend.username}</p>}
                                  </div>
                                  <button onClick={() => setConfirmingDeleteFriend(friend)} className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="x" className="w-5 h-5 text-red-400" /></button>
                                  </div>
                              ))}
                              </div>
                          </div>
                          )}

                          <div>
                          <h3 className="text-lg font-bold text-white mb-3">Все пользователи</h3>
                          <input type="text" value={userSearchQuery} onChange={(e) => { setUserSearchQuery(e.target.value); loadAllUsers(e.target.value); }} placeholder="Поиск пользователей..." className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mb-4" />
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {allUsers.map(u => (
                              <div key={u.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                                  <Avatar src={u.avatar} size="md" />
                                  <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), u.id); setShowUserHub(false); }}>
                                  <p className="text-white font-semibold">{u.username}</p>
                                  </div>
                                  <UserListFriendButton targetUser={u} />
                              </div>
                              ))}
                          </div>
                          </div>
                      </div>
                  </div>
                  </div>
              )}

              {selectedGame && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 max-h-[90vh] overflow-y-auto">
                      <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold text-white">{selectedGame.name}</h2>
                      <button onClick={() => setSelectedGame(null)} className="p-2 hover:bg-gray-800 rounded-lg"><Icon name="x" className="w-5 h-5 text-gray-400" /></button>
                      </div>
                      <div className="space-y-4">
                      {!viewingUser ? (
                          <Fragment>
                          <div>
                              <p className="text-gray-400 text-sm mb-2">Рейтинг:</p>
                              <div className="flex gap-2">
                              {[1, 2, 3, 4, 5].map(star => (
                                  <button key={star} onClick={() => updateGame(selectedGame.id, { rating: star })} className="transition-transform hover:scale-110">
                                  <Icon name="star" className={`w-8 h-8 ${star <= (selectedGame.rating || 0) ? 'text-yellow-400' : 'text-gray-600'}`} />
                                  </button>
                              ))}
                              </div>
                          </div>
                          <div>
                              <label className="text-gray-400 text-sm">Заметки:</label>
                              <textarea defaultValue={selectedGame.notes || ''} onBlur={(e) => updateGame(selectedGame.id, { notes: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" rows="3" placeholder="Твои впечатления..." />
                          </div>
                          </Fragment>
                      ) : (
                          <Fragment>
                              {selectedGame.rating && 
                                  <div>
                                      <p className="text-gray-400 text-sm mb-2">Рейтинг от {viewingUser.username}:</p>
                                      <div className="flex gap-1">
                                          {[...Array(5)].map((_, i) => (<Icon key={i} name="star" className={`w-6 h-6 ${i < selectedGame.rating ? 'text-yellow-400' : 'text-gray-600'}`} />))}
                                      </div>
                                  </div>
                              }
                              {selectedGame.notes &&
                                  <div>
                                      <p className="text-gray-400 text-sm mb-1">Заметки от {viewingUser.username}:</p>
                                      <p className="text-white bg-gray-800 p-3 rounded-lg border border-gray-700">{selectedGame.notes}</p>
                                  </div>
                              }
                              {(!selectedGame.notes && !selectedGame.rating) && <p className="text-gray-400">Пользователь не оставил отзыва.</p>}
                              <div className="pt-2">
                                <p className="text-gray-400 text-sm mb-2">Ваша реакция:</p>
                                <div className="flex flex-wrap gap-2">
                                  {REACTION_EMOJIS.map(emoji => (
                                      <button
                                          key={emoji}
                                          onClick={() => addReaction(selectedGame.id, emoji)}
                                          className={`text-2xl transform hover:scale-125 transition-transform p-1 rounded-full ${selectedGame.reactions.find(r => r.user_id === user.id && r.emoji === emoji) ? 'bg-purple-500/30' : ''}`}
                                          title={`React with ${emoji}`}
                                      >
                                          {emoji}
                                      </button>
                                  ))}
                                </div>
                              </div>
                          </Fragment>
                      )}
                      
                      {selectedGame.deep_review_answers && <DisplayDeepReview answers={selectedGame.deep_review_answers} />}
                      
                      {selectedGame.reactions && selectedGame.reactions.length > 0 && (
                          <div>
                          <p className="text-gray-400 text-sm mb-2">Все реакции:</p>
                          <div className="flex flex-wrap gap-2">
                              {selectedGame.reactions.map((reaction, idx) => (
                              <div key={idx} className="flex items-center gap-1 bg-gray-800 px-3 py-1 rounded-full">
                                  <span className="text-xl">{reaction.emoji}</span>
                                  <span className="text-xs text-gray-400">{reaction.username}</span>
                              </div>
                              ))}
                          </div>
                          </div>
                      )}
                      <div className="flex gap-2 mt-4">
                        <a 
                            href={selectedGame.videoId ? `https://www.youtube.com/watch?v=${selectedGame.videoId}` : `https://www.youtube.com/results?search_query=${encodeURIComponent(selectedGame.name + ' trailer')}`} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="flex-1 flex items-center justify-center gap-2 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">
                            <Icon name="youtube" className="w-6 h-6" />
                            Трейлер
                        </a>
                        {!viewingUser && selectedGame.deep_review_answers && (
                            <button 
                                onClick={() => handleDeleteReview(selectedGame.id)}
                                className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg"
                                title="Удалить детальный отзыв"
                            >
                                <Icon name="trash" className="w-5 h-5 text-red-400"/>
                            </button>
                        )}
                      </div>
                      </div>
                  </div>
                  </div>
              )}
              
              {confirmingDeleteFriend && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-red-500/30">
                      <h2 className="text-xl font-bold text-white mb-4">Подтверждение</h2>
                      <p className="text-gray-300 mb-6">
                      Вы уверены, что хотите удалить <span className="font-bold text-white">{confirmingDeleteFriend.username}</span> из друзей?
                      </p>
                      <div className="flex gap-2">
                      <button onClick={() => { friendAction(confirmingDeleteFriend.id, 'remove'); setConfirmingDeleteFriend(null); }}
                          className="flex-1 py-2 bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold rounded-lg hover:from-red-600 hover:to-orange-600">
                          Удалить
                      </button>
                      <button onClick={() => setConfirmingDeleteFriend(null)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">Отмена</button>
                      </div>
                  </div>
                  </div>
              )}

              {confirmingAddFriend && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-green-500/30">
                      <h2 className="text-xl font-bold text-white mb-4">Запрос в друзья</h2>
                      <p className="text-gray-300 mb-6">
                      Принять запрос в друзья от <span className="font-bold text-white">{confirmingAddFriend.username}</span>?
                      </p>
                      <div className="flex gap-2">
                      <button onClick={() => { friendAction(confirmingAddFriend.id, 'accept'); setConfirmingAddFriend(null); }}
                          className="flex-1 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-lg hover:from-green-600 hover:to-emerald-600">
                          Принять
                      </button>
                      <button onClick={() => {friendAction(confirmingAddFriend.id, 'reject'); setConfirmingAddFriend(null); }} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">Отклонить</button>
                      </div>
                  </div>
                  </div>
              )}

              <div className="container mx-auto px-4 py-6">
                  {viewingUser && (
                  <div className="mb-6 bg-gradient-to-r from-purple-900/50 to-blue-900/50 backdrop-blur-xl rounded-xl p-6 border border-purple-500/30">
                      <div className="flex items-center gap-4">
                      <Avatar src={viewingUser.avatar} size="lg" />
                      <div className="flex-1">
                          <h2 className="text-3xl font-bold text-white">{userNickname || viewingUser.username}</h2>
                          {userNickname && <p className="text-gray-400">@{viewingUser.username}</p>}
                          {viewingUser.bio && <p className="text-gray-300 mt-2">{viewingUser.bio}</p>}
                      </div>
                      </div>
                  </div>
                  )}

                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                  {Object.values(boards).map(board => {
                      const isExpanded = !!expandedColumns[board.id];
                      const visibleCards = isExpanded ? board.cards : board.cards.slice(0, GAMES_PER_COLUMN);

                      return (
                      <div key={board.id} 
                          onDragOver={handleDragOver}
                          onDragEnter={handleDragEnterColumn}
                          onDragLeave={handleDragLeaveColumn}
                          onDrop={(e) => !viewingUser && handleDrop(e, board.id, undefined)} 
                          className={`bg-gradient-to-br ${board.color} backdrop-blur-xl rounded-xl p-4 border ${board.borderColor} flex flex-col transition-colors`}>
                          <div className="flex items-center justify-between mb-4">
                          <h2 className="text-lg md:text-xl font-bold text-white flex items-center gap-2"><span className="text-xl md:text-2xl">{board.emoji}</span><span className="hidden sm:inline">{board.title}</span></h2>
                          <span className="bg-white/10 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-bold">{board.cards.length}</span>
                          </div>
                          
                          <div className="space-y-2 flex-grow min-h-[100px]">
                          {visibleCards.map((card, index) => (
                              <div key={card.id} 
                                  draggable={!viewingUser}
                                  onDragStart={(e) => handleDragStart(e, card, board.id, index)}
                                  onDragEnd={handleDragEnd}
                                  onDrop={(e) => !viewingUser && handleDrop(e, board.id, index)}
                                  onDragEnter={handleDragEnterCard}
                                  onDragLeave={handleDragLeaveCard}
                                  className="bg-gray-800/80 rounded-lg border border-gray-700 hover:border-purple-500 transition-all cursor-pointer flex gap-3 p-2 group relative" 
                                  onClick={() => setSelectedGame(card)}>
                              
                              {card.cover ? 
                                  <img src={card.cover} alt={card.name} className="w-14 h-20 object-cover rounded-md flex-shrink-0" /> : 
                                  <div className="w-14 h-20 bg-gray-700 rounded-md flex items-center justify-center text-2xl flex-shrink-0">🎮</div>
                              }
                              <div className="flex flex-col justify-between flex-grow min-w-0 py-1">
                                  <div>
                                      <h3 className="text-white font-semibold text-sm truncate">{card.name}</h3>
                                      {card.rating && !viewingUser && <div className="flex gap-0.5 mt-1">
                                          {[...Array(5)].map((_, i) => (<Icon key={i} name="star" className={`w-3 h-3 ${i < card.rating ? 'text-yellow-400' : 'text-gray-600'}`} />))}
                                      </div>}
                                  </div>
                                  <div className="flex items-end justify-between w-full">
                                    {card.reactions && card.reactions.length > 0 && (
                                        <div className="flex gap-1.5 mt-1 flex-wrap items-center">
                                        {card.reactions.slice(0, 4).map((r, i) => <span key={i} className="text-lg">{r.emoji}</span>)}
                                        {card.reactions.length > 4 && <span className="text-xs text-gray-400 self-center">+{card.reactions.length - 4}</span>}
                                        </div>
                                    )}
                                    {board.id === 'completed' && !viewingUser && (
                                        <button 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setGameForReview(card);
                                            }}
                                            className="p-1.5 bg-purple-500/80 hover:bg-purple-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity self-end flex-shrink-0 z-10"
                                            title={card.deep_review_answers ? "Редактировать отзыв" : "Оставить детальный отзыв"}
                                        >
                                            <Icon name="edit" className="w-3 h-3 text-white"/>
                                        </button>
                                    )}
                                   </div>
                              </div>
                              {!viewingUser && (
                                  <button onClick={(e) => deleteCard(e, card.id)} className="absolute top-1 right-1 p-1.5 bg-red-600/80 hover:bg-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity self-start flex-shrink-0 z-10">
                                      <Icon name="trash" className="w-3 h-3 text-white" />
                                  </button>
                                  )}
                              </div>
                          ))}
                          </div>

                          {board.cards.length > GAMES_PER_COLUMN && (
                              <button onClick={() => toggleColumnExpansion(board.id)} className="w-full text-center mt-3 py-1.5 text-xs font-semibold text-purple-300 bg-purple-500/10 hover:bg-purple-500/20 rounded-lg flex items-center justify-center gap-1">
                              {isExpanded ? 'Свернуть' : `Показать еще ${board.cards.length - GAMES_PER_COLUMN}`}
                              <Icon name={isExpanded ? 'chevronUp' : 'chevronDown'} className="w-3 h-3" />
                              </button>
                          )}
                      </div>
                      )})}
                  </div>
                  <div className="mt-6 md:mt-8 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                  <div className="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 backdrop-blur-xl rounded-xl p-4 md:p-6 border border-blue-500/30">
                      <div className="text-2xl md:text-4xl mb-2">📊</div>
                      <h3 className="text-xs md:text-sm font-semibold text-gray-300 mb-1">Всего</h3>
                      <p className="text-2xl md:text-3xl font-bold text-white">{Object.values(boards).reduce((acc, board) => acc + board.cards.length, 0)}</p>
                  </div>
                  <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-xl rounded-xl p-4 md:p-6 border border-green-500/30">
                      <div className="text-2xl md:text-4xl mb-2">✅</div>
                      <h3 className="text-xs md:text-sm font-semibold text-gray-300 mb-1">Пройдено</h3>
                      <p className="text-2xl md:text-3xl font-bold text-white">{boards.completed.cards.length}</p>
                  </div>
                  <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-xl rounded-xl p-4 md:p-6 border border-purple-500/30">
                      <div className="text-2xl md:text-4xl mb-2">🎮</div>
                      <h3 className="text-xs md:text-sm font-semibold text-gray-300 mb-1">Играю</h3>
                      <p className="text-2xl md:text-3xl font-bold text-white">{boards.playing.cards.length}</p>
                  </div>
                  <div className="bg-gradient-to-br from-orange-500/20 to-red-500/20 backdrop-blur-xl rounded-xl p-4 md:p-6 border border-orange-500/30">
                      <div className="text-2xl md:text-4xl mb-2">📋</div>
                      <h3 className="text-xs md:text-sm font-semibold text-gray-300 mb-1">Беклог</h3>
                      <p className="text-2xl md:text-3xl font-bold text-white">{boards.backlog.cards.length}</p>
                  </div>
                  </div>
                  
                  {!viewingUser && <ActivityFeed token={localStorage.getItem('token')} />}
              </div>
          </main>
        </div>
      );
    };

    const DEEP_REVIEW_QUESTIONS = [
        { block: 'Первое Впечатление и Сюжет', questions: [
            { id: 1, text: "Что вас больше всего зацепило в самом начале игры?", answers: ["Атмосфера и мир, в который сразу хочется погрузиться.", "Интригующая завязка сюжета, хотелось узнать, что будет дальше.", "Динамичный геймплей, который начался с первых минут.", "Визуальный стиль и графика, от которых было не оторвать глаз.", "Ничего особенного, игра разгонялась довольно медленно.", "Скучное и затянутое вступление, которое отбило желание играть."] },
            { id: 2, text: "Как бы вы описали сюжет игры?", answers: ["Глубокий и многослойный, заставляющий задуматься.", "Простой, но увлекательный и хорошо поданный.", "Эпичный и захватывающий, полный неожиданных поворотов.", "Довольно предсказуемый, но служит хорошим фоном для геймплея.", "Сюжет здесь для галочки, главное — игровой процесс.", "Слабый, нелогичный или попросту отсутствующий."] },
            { id: 3, text: "Насколько хорошо проработаны персонажи?", answers: ["Очень живые и запоминающиеся, им действительно сопереживаешь.", "Харизматичные, хоть и немного шаблонные.", "Персонажи — просто функции для продвижения сюжета.", "Главный герой/героиня — единственный интересный персонаж.", "Персонажей как таковых нет, или они не важны.", "Плоские и невыразительные, они скорее раздражали."] },
            { id: 4, text: "Запомнился ли вам мир игры (ло́р)?", answers: ["Да, это невероятно проработанная вселенная, которую хочется исследовать.", "Мир интересен, но многое остается за кадром.", "Он служит лишь красивой декорацией для основных событий.", "Мир игры довольно стандартный для своего жанра.", "В игре нет акцента на глубокую проработку мира.", "Пустой и безжизненный мир, который не вызвал никакого интереса."] },
        ]},
        { block: 'Геймплей и Механики', questions: [
            { id: 5, text: "Какое слово лучше всего описывает основной геймплей?", answers: ["Медитативный — игра позволяет расслабиться.", "Динамичный — постоянно держит в напряжении.", "Тактический — нужно думать над каждым шагом.", "Исследовательский — упор на изучение мира и секретов.", "Креативный — игра поощряет творческий подход.", "Однообразный — приходилось делать одно и то же."] },
            { id: 6, text: "Насколько оригинальны игровые механики?", answers: ["Игра предлагает что-то совершенно новое, чего я раньше не видел.", "В ней есть несколько уникальных идей поверх знакомых механик.", "Это отличная реализация уже проверенных временем механик.", "Все очень просто и интуитивно, без изысков.", "Механики кажутся устаревшими или слишком заимствованными.", "Сломанные или плохо реализованные механики, которые мешали играть."] },
            { id: 7, text: "Было ли управление в игре удобным?", answers: ["Да, абсолютно интуитивное и отзывчивое.", "В целом да, но к некоторым вещам пришлось привыкать.", "Управление простое, там негде было ошибиться.", "Спорное, некоторые действия выполнять было неудобно.", "Нет, управление часто вызывало раздражение.", "Ужасное, оно стало главной проблемой в игре."] },
            { id: 8, text: "Насколько разнообразен игровой процесс?", answers: ["Игра постоянно подкидывала новые задачи и ситуации.", "Геймплей довольно однообразен, но основной цикл затягивает.", "В середине игра начала повторяться.", "Разнообразие не требуется, игра сфокусирована на одной механике.", "К концу игры процесс стал откровенно рутинным.", "Игра наскучила уже в первый час из-за однообразия."] },
            { id: 9, text: "Что можно сказать о прогрессии (развитии персонажа/возможностей)?", answers: ["Прогрессия ощущается очень плавной и награждающей.", "Она есть, но не сильно влияет на геймплей.", "Новые способности открывались слишком быстро, обесценивая старые.", "В игре нет системы прогрессии.", "Слишком медленная, приходилось много гриндить.", "Несбалансированная, делала игру либо слишком легкой, либо сложной."] },
        ]},
        { block: 'Аудиовизуальное исполнение', questions: [
            { id: 10, text: "Как вы оцениваете визуальный стиль игры?", answers: ["Это настоящий шедевр, каждый кадр — произведение искусства.", "Очень приятный и стильный, отлично работает на атмосферу.", "Графика технологичная, но без особой \"души\".", "Визуальный ряд неплохой, но ничем не выделяется.", "Графика — самое слабое место игры.", "Устаревший или неприятный визуальный стиль."] },
            { id: 11, text: "Насколько качественным был саунд-дизайн?", answers: ["Музыка и звуки великолепны, они — половина атмосферы.", "Саундтрек хороший и запоминающийся.", "Звук просто выполняет свою функцию, не более.", "Я почти не обращал внимания на звук во время игры.", "Некоторые звуки или музыка со временем начинали раздражать.", "Звуковое сопровождение было откровенно плохим."] },
            { id: 12, text: "Запомнился ли вам какой-то конкретный аспект дизайна?", answers: ["Да, дизайн уровней/локаций просто восхитителен.", "Дизайн персонажей и врагов очень оригинален.", "Пользовательский интерфейс (UI) очень удобный и красивый.", "В целом все сделано качественно, но без вау-эффекта.", "Нет, ничего особенно не запомнилось.", "Отдельные элементы дизайна вызывали недоумение или были неудобны."] },
            { id: 13, text: "Как обстояли дела с технической стороной (баги, оптимизация)?", answers: ["Игра работала идеально, без единой проблемы.", "Были мелкие, некритичные баги.", "Технические проблемы периодически мешали прохождению.", "Игра была плохо оптимизирована и часто тормозила.", "Из-за багов прохождение превратилось в мучение.", "Игра часто вылетала или имела критические баги, ломающие прохождение."] },
        ]},
        { block: 'Сложность и Длительность', questions: [
            { id: 14, text: "Как бы вы описали сложность игры?", answers: ["Сбалансированная — бросает вызов, но не душит.", "Сложность можно гибко настроить под себя.", "Довольно простая, можно пройти, не напрягаясь.", "Очень сложная, для тех, кто любит хардкор.", "Несправедливая — сложность создается неудобными механиками.", "Сложность отсутствовала, никакого вызова игра не бросила."] },
            { id: 15, text: "Соответствовала ли продолжительность игры вашим ожиданиям?", answers: ["Идеальная длина, игра закончилась именно тогда, когда нужно.", "Хотелось бы, чтобы она была подлиннее.", "Это игра-сервис, у нее нет \"конца\".", "Очень короткая, закончилась слишком быстро.", "Игра показалась искусственно затянутой.", "Неоправданно длинная, ее стоило сократить вдвое."] },
            { id: 16, text: "Как в игре ощущается темп повествования и геймплея?", answers: ["Отличный, игра держит в напряжении от начала до конца.", "Спокойный и размеренный, дает время все изучить.", "Неровный: есть как очень динамичные, так и провисающие моменты.", "Слишком быстрый, не успеваешь проникнуться сюжетом и миром.", "Слишком медленный, местами было откровенно скучно.", "Рваный и нелогичный, повествование постоянно прерывалось."] },
        ]},
        { block: 'Итоговые Впечатления', questions: [
            { id: 17, text: "Какие эмоции игра вызывала у вас чаще всего?", answers: ["Восторг и удивление.", "Радость и веселье.", "Интерес и азарт.", "Спокойствие и умиротворение.", "Напряжение и даже страх.", "Скуку и разочарование."] },
            { id: 18, text: "Что вам запомнится больше всего после прохождения?", answers: ["Финал истории, который произвел сильное впечатление.", "Одна из игровых механик, которая была очень аддиктивной.", "Атмосфера и красота игрового мира.", "Победа над особенно сложным боссом.", "Время, проведенное в игре с друзьями.", "Чувство сожаления о потраченном времени."] },
            { id: 19, text: "Кому бы вы порекомендовали эту игру?", answers: ["Абсолютно всем, это маст-плей.", "Любителям жанра, они точно оценят.", "Тем, кто ищет глубокую историю и проработанный мир.", "Игрокам, которые хотят расслабиться и не напрягаться.", "Хардкорным геймерам, ищущим настоящий вызов.", "Никому, лучше пройти мимо."] },
            { id: 20, text: "Если описать игру одной фразой, то это...", answers: ["...незабываемое приключение.", "...увлекательная головоломка для ума.", "...чистое, незамутненное веселье.", "...произведение искусства.", "...крепкий середняк, который стоит своего времени.", "...полное разочарование."] },
        ]},
    ];
    
    const DeepReviewModal = ({ game, existingAnswers, onClose, onSubmit }) => {
        const [answers, setAnswers] = useState(() => {
            const initial = Array(20).fill(null);
            if (existingAnswers && Array.isArray(existingAnswers) && existingAnswers.length === 20) {
                return existingAnswers;
            }
            return initial;
        });
        const [currentStep, setCurrentStep] = useState(0);

        const handleAnswer = (qIndex, aIndex) => {
            const newAnswers = [...answers];
            newAnswers[qIndex] = aIndex;
            setAnswers(newAnswers);
        };

        const allQuestionsFlat = DEEP_REVIEW_QUESTIONS.flatMap(b => b.questions);
        const currentQuestion = allQuestionsFlat[currentStep];

        const answeredCount = answers.filter(a => a !== null).length;
        const allAnswered = answeredCount === 20;

        return (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-2xl border border-purple-500/30 max-h-[90vh] flex flex-col">
                    <h2 className="text-2xl font-bold text-white mb-2">Детальный отзыв о {game.name}</h2>
                    <p className="text-gray-400 mb-4 text-sm">Вопрос {currentStep + 1} из 20</p>
                    
                    <div className="w-full bg-gray-700 rounded-full h-2.5 mb-6">
                        <div className="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style={{ width: `${((currentStep + 1) / 20) * 100}%` }}></div>
                    </div>

                    <div className="flex-grow overflow-y-auto pr-2">
                        <p className="text-white text-lg mb-4">{currentQuestion.text}</p>
                        <div className="flex flex-col space-y-2">
                            {currentQuestion.answers.map((ans, aIndex) => (
                                <button 
                                    key={aIndex}
                                    onClick={() => handleAnswer(currentStep, aIndex)}
                                    className={`text-left p-3 rounded-lg text-sm transition-colors ${answers[currentStep] === aIndex ? 'bg-purple-500/50 text-white' : 'bg-gray-800 hover:bg-gray-700 text-gray-300'}`}
                                >
                                    {ans}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex justify-between items-center mt-6 pt-4 border-t border-gray-700">
                        <button onClick={() => setCurrentStep(s => s - 1)} disabled={currentStep === 0} className="py-2 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700 disabled:opacity-50 flex items-center gap-2">
                            <Icon name="arrowLeft" className="w-4 h-4" /> Назад
                        </button>
                        
                        {currentStep < 19 ? (
                            <button onClick={() => setCurrentStep(s => s + 1)} disabled={answers[currentStep] === null} className="py-2 px-4 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50 flex items-center gap-2">
                                Далее <Icon name="arrowRight" className="w-4 h-4" />
                            </button>
                        ) : (
                            <button onClick={() => onSubmit(game.id, answers)} disabled={!allAnswered} className="py-2 px-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-lg disabled:opacity-50">
                                {allAnswered ? 'Сохранить отзыв' : 'Завершить'}
                            </button>
                        )}
                        
                        <button onClick={onClose} className="py-2 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">Отмена</button>
                    </div>
                </div>
            </div>
        );
    };
    
    const generateReviewText = (answers) => {
        if (!answers || answers.length < 20) return null;

        const allQuestions = DEEP_REVIEW_QUESTIONS.flatMap(b => b.questions);
        const getAnswer = (qId) => {
            const answerIndex = answers[qId - 1];
            if (answerIndex === null) return { text: '', sentiment: 0 };
            const text = allQuestions[qId - 1].answers[answerIndex].split('—')[0].trim();
            // Simplified sentiment: 0,1,2 are positive, 3 is neutral, 4,5 are negative
            const sentiment = 2 - Math.floor(answerIndex / 2);
            return { text: text.toLowerCase(), sentiment };
        };

        let paragraphs = [];

        // Block 1: Story
        const p1_a1 = getAnswer(1);
        const p1_a2 = getAnswer(2);
        const p1_a3 = getAnswer(3);
        let para1 = '';
        if (p1_a1.sentiment < 0) {
            para1 = `Впечатления от старта игры оказались смазанными: вступление показалось мне ${p1_a1.text}. `;
        } else {
            para1 = `С самого начала игра увлекает, в первую очередь, своей ${p1_a1.text}. `;
        }
        if (p1_a2.sentiment > 0) {
            para1 += `Этот настрой подкрепляется сюжетом, который можно описать как ${p1_a2.text}. `;
        } else {
            para1 += `К сожалению, история не смогла удержать планку и показалась мне ${p1_a2.text}. `;
        }
        if (Math.abs(p1_a3.sentiment) > 0) {
             para1 += `Что касается персонажей, они были ${p1_a3.text}.`;
        }
        paragraphs.push(para1);

        // Block 2: Gameplay
        const p2_a5 = getAnswer(5);
        const p2_a6 = getAnswer(6);
        const p2_a7 = getAnswer(7);
        let para2 = `В основе своей игровой процесс ${p2_a5.text}. `;
        if (p2_a6.sentiment < 0) {
            para2 += `Однако, оригинальностью он не блещет, так как ${p2_a6.text}. `;
        } else if (p2_a6.sentiment > 0) {
            para2 += `Приятно удивило то, что ${p2_a6.text}. `;
        }
        if (p2_a7.sentiment < 1) {
            para2 += `Небольшим минусом стало управление, которое я бы назвал ${p2_a7.text}.`;
        }
        paragraphs.push(para2);

        // Block 3: Audiovisual
        const p3_a10 = getAnswer(10);
        const p3_a11 = getAnswer(11);
        const p3_a13 = getAnswer(13);
        let para3 = `Визуально игра выглядит ${p3_a10.text}. `;
        if (p3_a11.sentiment > 0 && p3_a10.sentiment > 0) {
            para3 += `Впечатление усиливает саунд-дизайн — ${p3_a11.text}. `;
        } else {
             para3 += `При этом саунд-дизайн был ${p3_a11.text}. `;
        }
        if (p3_a13.sentiment < 2) {
            para3 += `К сожалению, техническая сторона неидеальна: ${p3_a13.text}.`;
        }
        paragraphs.push(para3);

        // Block 4 & 5: Conclusion
        const p4_a14 = getAnswer(14);
        const p5_a19 = getAnswer(19);
        const p5_a20 = getAnswer(20);
        let para4 = `По сложности проект ${p4_a14.text}. `;
        if (p5_a19.sentiment > 0) {
             para4 += `Я бы порекомендовал эту игру ${p5_a19.text}. `;
        } else {
             para4 += `Советовать эту игру я бы не стал, разве что ${p5_a19.text}. `;
        }
        para4 += `Подводя итог, для меня это ${p5_a20.text}.`;
        paragraphs.push(para4);

        return paragraphs.join('\n\n');
    };
    
    const DisplayDeepReview = ({ answers }) => {
        const [isExpanded, setIsExpanded] = useState(false);
        const reviewText = generateReviewText(answers);
        if (!reviewText) return null;

        const snippet = reviewText.substring(0, 200);

        return (
            <div className="mt-4 pt-4 border-t border-gray-700">
                <h4 className="text-lg font-semibold text-purple-300 mb-2">Детальный отзыв</h4>
                <p className="text-gray-300 whitespace-pre-wrap">
                    {isExpanded ? reviewText : `${snippet}...`}
                </p>
                {reviewText.length > 200 && (
                    <button onClick={() => setIsExpanded(!isExpanded)} className="text-purple-400 hover:text-purple-300 mt-2">
                        {isExpanded ? 'Свернуть' : 'Показать полностью'}
                    </button>
                )}
            </div>
        );
    };

    ReactDOM.render(<GameKanban />, document.getElementById('root'));
  </script>
</body>
</html>

