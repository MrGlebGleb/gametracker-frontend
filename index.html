<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GameTracker</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
    .avatar-circle { border-radius: 50%; object-fit: cover; }
    .dragging { opacity: 0.5; border: 2px dashed #8b5cf6; }
    .drag-over-column { background-color: rgba(139, 92, 246, 0.1); }
    .drag-over-card { transform: scale(1.05); }

    .cropper-container {
        max-width: 100%;
    }
    .img-container {
        max-height: 50vh;
        margin-bottom: 1rem;
    }
    .img-container > img {
        max-width: 100%;
    }
    
    /* Liquid Eye Theme */
    .liquid-eye {
        --bg-color: #000000;
        --text-color: #ffffff;
        --primary-color: #ffffff;
        --secondary-color: #a0a0a0;
        --border-color: #444444;
        --card-bg: #101010;
        --header-bg: rgba(0, 0, 0, 0.7);
        --modal-bg: #111111;
        --button-bg: #ffffff;
        --button-text: #000000;
        --button-hover-bg: #e0e0e0;
        --input-bg: #222222;
    }
    
    .liquid-eye .bg-gradient-to-br, .liquid-eye .bg-gradient-to-r { background: var(--bg-color); }
    .liquid-eye body, .liquid-eye #root { background-color: var(--bg-color); color: var(--text-color); }
    .liquid-eye header { background-color: var(--header-bg) !important; border-bottom-color: var(--border-color) !important; }
    .liquid-eye .text-transparent { color: var(--text-color) !important; }
    .liquid-eye .bg-clip-text { -webkit-background-clip: unset !important; background-clip: unset !important; background: none !important; }
    .liquid-eye .border-purple-500\/30, .liquid-eye .border-blue-500\/30, .liquid-eye .border-green-500\/30, .liquid-eye .border-red-500\/30, .liquid-eye .border-orange-500\/30 { border-color: var(--border-color) !important; }
    .liquid-eye .bg-gray-900\/90, .liquid-eye .bg-gray-900, .liquid-eye .bg-gray-800, .liquid-eye .bg-gray-800\/90 { background-color: var(--card-bg) !important; }
    .liquid-eye .bg-gray-800\/95 { background-color: var(--modal-bg) !important; }
    .liquid-eye .from-purple-500\/20, .liquid-eye .to-pink-500\/20, .liquid-eye .from-blue-500\/20, .liquid-eye .from-green-500\/20, .liquid-eye .from-red-500\/20 { background: var(--card-bg) !important; }
    .liquid-eye input, .liquid-eye textarea, .liquid-eye select { background-color: var(--input-bg) !important; border-color: var(--border-color) !important; color: var(--text-color) !important; }
    .liquid-eye .text-purple-400, .liquid-eye .text-red-400, .liquid-eye .text-blue-400, .liquid-eye .text-green-400 { color: var(--primary-color) !important; }
    .liquid-eye .text-gray-300, .liquid-eye .text-gray-400 { color: var(--secondary-color) !important; }
    .liquid-eye button.bg-gradient-to-r { background: var(--button-bg) !important; color: var(--button-text) !important; }
    .liquid-eye button.bg-gradient-to-r:hover { background: var(--button-hover-bg) !important; }
    .liquid-eye .hover\:border-purple-500:hover { border-color: var(--primary-color) !important; }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ò–ì–†–´ */
    #game-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        text-align: center;
        z-index: 10;
        font-family: 'Inter', sans-serif;
    }
    #game-overlay h2 {
        font-size: 1.5em; 
        margin-bottom: 0.5em;
        text-shadow: 0 0 10px #8b5cf6;
    }
    #game-overlay p {
        font-size: 1em;
        margin: 0.2em 0;
    }
    #game-overlay button {
        margin-top: 1.5em;
        padding: 8px 18px; 
        font-size: 0.75em;
        font-weight: bold;
        color: #000;
        background: #ffffff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #game-overlay button:hover {
        background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, Fragment, useCallback } = React;
    const API_URL = 'https://gametracker-backend-production.up.railway.app';
    const REACTION_EMOJIS = ['üòç', 'üî•', 'üëç', 'üòÆ', 'üòÇ', 'üëé', '‚ù§Ô∏è', 'ü§î', 'üò¢', 'ü§Ø', 'üò¥', 'üíØ', 'üíÄ', 'ü§®', 'ü•≥'];
    const GAMES_PER_COLUMN = 5;

    const Icon = ({ name, className = "w-5 h-5" }) => {
      const icons = {
        arrowLeft: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>,
        arrowRight: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>,
        youtube: <svg className={className} viewBox="0 0 24 24" fill="currentColor"><path d="M10,15L15.19,12L10,9V15M21.56,7.17C21.69,7.64 21.78,8.27 21.84,9.07C21.91,9.87 21.94,10.56 21.94,11.16L22,12C22,14.19 21.84,15.8 21.56,16.83C21.31,17.73 20.73,18.31 19.83,18.56C19.36,18.69 18.73,18.78 17.93,18.84C17.13,18.91 16.44,18.94 15.84,18.94L15,19C12.81,19 11.2,18.84 10.17,18.56C9.27,18.31 8.69,17.73 8.44,16.83C8.31,16.36 8.22,15.73 8.16,14.93C8.09,14.13 8.06,13.44 8.06,12.84L8,12C8,9.81 8.16,8.2 8.44,7.17C8.69,6.27 9.27,5.69 10.17,5.44C10.64,5.31 11.27,5.22 12.07,5.16C12.87,5.09 13.56,5.06 14.16,5.06L15,5C17.19,5 18.8,5.16 19.83,5.44C20.73,5.69 21.31,6.27 21.56,7.17Z"></path></svg>,
        bell: <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>,
        search: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>,
        user: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
        users: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
        settings: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
        logout: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>,
        star: <svg className={className} fill="currentColor" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
        trash: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
        x: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        loader: <svg className={className + " animate-spin"} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>,
        upload: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>,
        globe: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 1.53 0 0 1-4 10 15.3 1.53 0 0 1-4-10 15.3 1.53 0 0 1 4-10z"/></svg>,
        edit: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
        tag: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
        userPlus: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
        userCheck: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>,
        userClock: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><circle cx="18" cy="18" r="3" /><path d="M20.5 16.5 18 18l.5 2.5"/></svg>,
        check: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
        chevronUp: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M5 15l7-7 7 7" /></svg>,
        chevronDown: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" /></svg>,
      };
      return icons[name] || null;
    };

    const Avatar = ({ src, size = 'md', className = '' }) => {
      const sizes = { sm: 'w-8 h-8', md: 'w-12 h-12', lg: 'w-20 h-20', xl: 'w-32 h-32' };
      return src ? (
        <img src={src} className={`${sizes[size]} avatar-circle ${className}`} alt="avatar" />
      ) : (
        <div className={`${sizes[size]} avatar-circle bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold ${className}`}>
          <Icon name="user" className={size === 'sm' ? 'w-4 h-4' : 'w-6 h-6'} />
        </div>
      );
    };
    
    const AvatarCropModal = ({ src, onCancel, onComplete }) => {
        const imageRef = useRef(null);
        const [cropper, setCropper] = useState(null);

        useEffect(() => {
            if (imageRef.current) {
                const instance = new Cropper(imageRef.current, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    background: false,
                    autoCropArea: 0.8,
                });
                setCropper(instance);
            }
            return () => {
                if (cropper) {
                    cropper.destroy();
                }
            };
        }, [imageRef]);

        const handleCrop = () => {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({
                    width: 128,
                    height: 128,
                    imageSmoothingQuality: 'high',
                });
                onComplete(canvas.toDataURL('image/jpeg', 0.9));
            }
        };

        return (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-lg border border-purple-500/30">
                    <h2 className="text-2xl font-bold text-white mb-4">–û–±—Ä–µ–∑–∞—Ç—å –∞–≤–∞—Ç–∞—Ä</h2>
                    <div className="img-container">
                        <img ref={imageRef} src={src} alt="Source" />
                    </div>
                    <div className="flex gap-2 mt-6">
                        <button onClick={handleCrop} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg hover:from-purple-600 hover:to-pink-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button onClick={onCancel} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        );
    };

    const ActivityFeed = ({ token }) => {
        const [activities, setActivities] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const fetchActivities = async () => {
                if (!token) return;
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/api/friends/activity`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setActivities(data.activities);
                    }
                } catch (err) {
                    console.error("Failed to fetch activities", err);
                } finally {
                    setLoading(false);
                }
            };
            fetchActivities();
            const interval = setInterval(fetchActivities, 60000);
            return () => clearInterval(interval);
        }, [token]);
        
        const boardTitles = {
            backlog: '–ë–µ–∫–ª–æ–≥',
            playing: '–ò–≥—Ä–∞—é',
            completed: '–ü—Ä–æ–π–¥–µ–Ω–æ',
            dropped: '–ë—Ä–æ—à–µ–Ω–æ'
        };

        const formatActivity = (act) => {
            const { username, action_type, details } = act;
            const gameName = <span className="font-bold text-purple-300">{details.gameName}</span>;
            switch (action_type) {
                case 'add_game':
                    return <>{username} –¥–æ–±–∞–≤–∏–ª {gameName} –≤ <span className="italic">{boardTitles[details.board]}</span></>;
                case 'move_game':
                    return <>{username} –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª {gameName} –∏–∑ <span className="italic">{boardTitles[details.fromBoard]}</span> –≤ <span className="italic">{boardTitles[details.toBoard]}</span></>;
                case 'remove_game':
                     return <>{username} —É–¥–∞–ª–∏–ª {gameName}</>;
                case 'complete_game':
                    return <><span className="text-green-400 font-semibold">{username}</span> –ø—Ä–æ—à–µ–ª –∏–≥—Ä—É {gameName}! üéâ</>;
                default:
                    return `${username} ${action_type}`;
            }
        };
        
        return (
            <div className="mt-8 md:mt-12">
                {loading ? (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-10 flex items-center justify-center">
                        <Icon name="loader" className="w-8 h-8 text-purple-400"/>
                    </div>
                ) : activities.length > 0 ? (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {activities.map(act => (
                                <div key={act.id} className="text-sm text-gray-300 p-4 bg-gray-800/80 rounded-lg border border-gray-700 hover:border-purple-500/50 transition-colors">
                                    <p>{formatActivity(act)}</p>
                                    <div className="text-xs text-gray-500 mt-2 text-right">{new Date(act.created_at).toLocaleString('ru-RU')}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                ) : (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-10 flex items-center justify-center text-gray-400 text-center">
                        –ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–∏—Ö –¥—Ä—É–∑–µ–π.
                    </div>
                )}
            </div>
        );
    };

    const GameKanban = () => {
      const [user, setUser] = useState(null);
      const [showAuth, setShowAuth] = useState(true);
      const [authMode, setAuthMode] = useState('login');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [showSearch, setShowSearch] = useState(false);
      const [searching, setSearching] = useState(false);
      const [showProfile, setShowProfile] = useState(false);
      const [showUserHub, setShowUserHub] = useState(false);
      const [allUsers, setAllUsers] = useState([]);
      const [userSearchQuery, setUserSearchQuery] = useState('');
      const [friends, setFriends] = useState([]);
      const [friendRequests, setFriendRequests] = useState([]);
      const [sentRequests, setSentRequests] = useState([]);
      const [selectedGame, setSelectedGame] = useState(null);
      const [viewingUser, setViewingUser] = useState(null);
      const [friendshipStatus, setFriendshipStatus] = useState('none');
      const [userNickname, setUserNickname] = useState('');
      const [editingNickname, setEditingNickname] = useState(false);
      const [uploadingAvatar, setUploadingAvatar] = useState(false);
      const fileInputRef = useRef(null);
      const [theme, setTheme] = useState('default');
      const [confirmingDeleteFriend, setConfirmingDeleteFriend] = useState(null);
      const [confirmingAddFriend, setConfirmingAddFriend] = useState(null);
      const dragItem = useRef(null);
      const [expandedColumns, setExpandedColumns] = useState({});
      const [formData, setFormData] = useState({ username: '', email: '', password: '' });
      const [profileData, setProfileData] = useState({ username: '', bio: '', theme: 'default', currentPassword: '', newPassword: '' });
      const [imageForCrop, setImageForCrop] = useState(null);
      const [gameForReview, setGameForReview] = useState(null);

      const [boards, setBoards] = useState({
        backlog: { id: 'backlog', title: '–ë–µ–∫–ª–æ–≥', emoji: 'üìã', color: 'from-blue-500/20 to-cyan-500/20', borderColor: 'border-blue-500/30', cards: [] },
        playing: { id: 'playing', title: '–ò–≥—Ä–∞—é', emoji: 'üéÆ', color: 'from-purple-500/20 to-pink-500/20', borderColor: 'border-purple-500/30', cards: [] },
        completed: { id: 'completed', title: '–ü—Ä–æ–π–¥–µ–Ω–æ', emoji: '‚úÖ', color: 'from-green-500/20 to-emerald-500/20', borderColor: 'border-green-500/30', cards: [] },
        dropped: { id: 'dropped', title: '–ë—Ä–æ—à–µ–Ω–æ', emoji: '‚ùå', color: 'from-red-500/20 to-orange-500/20', borderColor: 'border-red-500/30', cards: [] }
      });

      const loadBoards = useCallback(async (token, userId = null) => {
        try {
          const url = userId ? `${API_URL}/api/user/${userId}/boards` : `${API_URL}/api/user/boards`;
          const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (response.ok) {
            const data = await response.json();
            if (userId) {
              setViewingUser(data.user);
              setFriendshipStatus(data.friendship);
              setUserNickname(data.nickname || '');
            } else {
               setViewingUser(null);
            }
            if (data.boards) {
              setBoards(prev => ({
                backlog: { ...prev.backlog, cards: data.boards.backlog || [] },
                playing: { ...prev.playing, cards: data.boards.playing || [] },
                completed: { ...prev.completed, cards: data.boards.completed || [] },
                dropped: { ...prev.dropped, cards: data.boards.dropped || [] }
              }));
            }
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
        }
      }, []);

      useEffect(() => {
        const token = localStorage.getItem('token');
        const savedUser = localStorage.getItem('user');
        if (token && savedUser) {
          const parsedUser = JSON.parse(savedUser);
          setUser(parsedUser);
          setTheme(parsedUser.theme || 'default');
          setShowAuth(false);
          loadBoards(token);
        }
      }, [loadBoards]);
      
      useEffect(() => {
        document.body.className = theme;
      }, [theme]);

      const loadFriends = useCallback(async () => {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
          const response = await fetch(`${API_URL}/api/friends`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setFriends(data.friends || []);
            setFriendRequests(data.requests || []);
            setSentRequests(data.sentRequests || []);
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', err);
        }
      }, []);
      
      useEffect(() => {
        loadFriends();
      }, [user, loadFriends])

      const loadAllUsers = useCallback(async (query = '') => {
        const token = localStorage.getItem('token');
        try {
          const url = query 
            ? `${API_URL}/api/users?q=${encodeURIComponent(query)}` 
            : `${API_URL}/api/users`;
          const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (response.ok) {
            const data = await response.json();
            setAllUsers(data.users || []);
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err);
        }
      }, []);

      const handleAuth = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const endpoint = authMode === 'login' ? '/api/auth/login' : '/api/auth/register';
          const response = await fetch(`${API_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          const data = await response.json();
          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            setUser(data.user);
            setTheme(data.user.theme || 'default');
            setShowAuth(false);
            loadBoards(data.token);
            loadFriends(data.token);
          } else {
            setError(data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
          }
        } catch (err) {
          setError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
        } finally {
          setLoading(false);
        }
      };

      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = () => {
                setImageForCrop(reader.result);
            };
            reader.readAsDataURL(file);
        }
      };
      
      const handleAvatarUpdate = async (croppedImage) => {
          setImageForCrop(null);
          setUploadingAvatar(true);
          try {
              const token = localStorage.getItem('token');
              const response = await fetch(`${API_URL}/api/profile/avatar`, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ avatar: croppedImage })
              });
              if (response.ok) {
                  const data = await response.json();
                  setUser(data.user);
                  localStorage.setItem('user', JSON.stringify(data.user));
                  alert('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!');
              } else {
                  alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞');
              }
          } catch (err) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', err);
              alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞');
          } finally {
              setUploadingAvatar(false);
          }
      };


      const handleSearch = async (query) => {
        setSearchQuery(query);
        if (query.length < 3) {
          setSearchResults([]);
          return;
        }
        setSearching(true);
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/games/search?q=${encodeURIComponent(query)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setSearchResults(data.games || []);
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
        } finally {
          setSearching(false);
        }
      };

      const addGameToBoard = async (game, boardId) => {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/user/boards/${boardId}/games`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ game })
          });
          
          if (response.ok) {
            await loadBoards(token);
            setShowSearch(false);
            setSearchQuery('');
            setSearchResults([]);
          } else {
            const data = await response.json();
            alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä—ã: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } catch (err) {
          alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä—ã');
        }
      };

      const deleteCard = async (e, cardId) => {
        e.stopPropagation();
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/user/games/${cardId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          loadBoards(token);
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
        }
      };

      const updateGame = useCallback(async (gameId, updates) => {
        setBoards(prevBoards => {
            const newBoards = JSON.parse(JSON.stringify(prevBoards));
            for (const boardId in newBoards) {
                const cardIndex = newBoards[boardId].cards.findIndex(c => c.id === gameId);
                if (cardIndex > -1) {
                    newBoards[boardId].cards[cardIndex] = { ...newBoards[boardId].cards[cardIndex], ...updates };
                    break;
                }
            }
            return newBoards;
        });
        
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/user/games/${gameId}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(updates)
          });
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err);
          loadBoards(localStorage.getItem('token'));
        }
      }, [loadBoards]);
      
      
      const updateBoardOrder = useCallback(async (boardId, orderedIds) => {
         const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/user/boards/reorder`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ boardId, orderedIds })
          });
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞:', err);
          loadBoards(localStorage.getItem('token'));
        }
      }, [loadBoards]);
      
      const submitDeepReview = useCallback(async (gameId, answers) => {
          const token = localStorage.getItem('token');
          try {
             await fetch(`${API_URL}/api/games/${gameId}/deep-review`, {
                 method: 'POST',
                 headers: {
                     'Authorization': `Bearer ${token}`,
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify({ answers })
             });
             await loadBoards(token);
             setGameForReview(null);
          } catch(err) {
              console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞:', err);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤');
          }
      }, [loadBoards]);

      const handleDeleteReview = useCallback(async (gameId) => {
          if (!window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤?")) return;
          
          const token = localStorage.getItem('token');

          setBoards(prevBoards => {
              const newBoards = JSON.parse(JSON.stringify(prevBoards));
              const card = newBoards.completed.cards.find(c => c.id === gameId);
              if (card) card.deep_review_answers = null;
              return newBoards;
          });
          setSelectedGame(prev => ({...prev, deep_review_answers: null}));

          try {
             await fetch(`${API_URL}/api/games/${gameId}/deep-review`, {
                 method: 'DELETE',
                 headers: { 'Authorization': `Bearer ${token}` }
             });
          } catch(err) {
              console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞:', err);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤');
              loadBoards(token);
          }
      }, [loadBoards]);

      const addReaction = async (gameId, emoji) => {
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/games/${gameId}/reactions`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ emoji })
          });
          loadBoards(token, viewingUser?.id);
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏:', err);
        }
      };

      const friendAction = async (friendId, action) => {
        const token = localStorage.getItem('token');
        let endpoint = '';
        let method = 'POST';
        let body = { friendId: Number(friendId) }; 
        switch(action) {
            case 'request': endpoint = '/api/friends/request'; break;
            case 'accept': endpoint = '/api/friends/accept'; break;
            case 'reject': endpoint = '/api/friends/reject'; break;
            case 'remove': 
                endpoint = `/api/friends/${friendId}`; 
                method = 'DELETE'; 
                body = undefined;
                break;
            default: return;
        }

        try {
            const response = await fetch(`${API_URL}${endpoint}`, {
                method,
                headers: { 
                  'Authorization': `Bearer ${token}`, 
                  'Content-Type': 'application/json' 
                },
                body: body ? JSON.stringify(body) : null
            });
            if(!response.ok) {
              const err = await response.json();
              throw new Error(err.error || "Friend action failed")
            }
            await loadFriends();
            if (viewingUser && viewingUser.id == friendId) {
                await loadBoards(token, friendId);
            }
             if (showUserHub) {
                loadAllUsers(userSearchQuery);
            }
        } catch(err) {
            console.error(`–û—à–∏–±–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è '${action}':`, err);
        }
      };
      
      const updateNickname = async (friendId, nickname) => {
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/friends/${friendId}/nickname`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nickname })
          });
          setUserNickname(nickname);
          setEditingNickname(false);
          loadFriends();
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏:', err);
        }
      };
      
      const handleDragStart = (e, card, boardId, index) => {
        dragItem.current = { card, sourceBoardId: boardId, sourceIndex: index };
        setTimeout(() => e.target.classList.add('dragging'), 0);
      };

      const handleDragOver = (e) => e.preventDefault();
      
      const handleDragEnterColumn = (e) => e.currentTarget.classList.add('drag-over-column');
      const handleDragLeaveColumn = (e) => e.currentTarget.classList.remove('drag-over-column');
      const handleDragEnterCard = (e) => e.currentTarget.classList.add('drag-over-card');
      const handleDragLeaveCard = (e) => e.currentTarget.classList.remove('drag-over-card');

      const handleDrop = (e, targetBoardId, targetIndex) => {
        e.preventDefault();
        e.stopPropagation();

        if (!dragItem.current) return;
        
        const { card: draggedCard, sourceBoardId, sourceIndex } = dragItem.current;
        
        if (sourceBoardId === targetBoardId && sourceIndex === targetIndex) {
            return;
        }

        setBoards(prevBoards => {
            const newBoards = JSON.parse(JSON.stringify(prevBoards));
            
            const [movedItem] = newBoards[sourceBoardId].cards.splice(sourceIndex, 1);
            
            if (targetIndex === undefined) {
                newBoards[targetBoardId].cards.push(movedItem);
            } else {
                newBoards[targetBoardId].cards.splice(targetIndex, 0, movedItem);
            }
            
            if(sourceBoardId === targetBoardId) {
                const orderedIds = newBoards[targetBoardId].cards.map(c => c.id);
                updateBoardOrder(targetBoardId, orderedIds);
            }

            return newBoards;
        });
        
        if (sourceBoardId !== targetBoardId) {
            updateGame(draggedCard.id, { board: targetBoardId });
        }

        dragItem.current = null;
      };

      const handleDragEnd = () => {
        document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
        document.querySelectorAll('.drag-over-column').forEach(el => el.classList.remove('drag-over-column'));
        document.querySelectorAll('.drag-over-card').forEach(el => el.classList.remove('drag-over-card'));
        dragItem.current = null;
      };


      const handleLogout = () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        setUser(null);
        setShowAuth(true);
        setViewingUser(null);
        setTheme('default');
      };

      const updateProfile = async () => {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/profile`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({...profileData, theme})
          });
          if (response.ok) {
            const data = await response.json();
            setUser(data.user);
            setTheme(data.user.theme);
            localStorage.setItem('user', JSON.stringify(data.user));
            if (data.token) {
              localStorage.setItem('token', data.token);
            }
            setShowProfile(false);
            setProfileData({ username: '', bio: '', currentPassword: '', newPassword: '' });
            alert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
          } else {
            const errorData = await response.json();
            alert(errorData.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
          }
        } catch (err) {
          alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
        }
      };
      
      const FriendActionButton = ({ targetUser }) => {
        if (!user || user.id === targetUser.id) return null;
        if (friendshipStatus === 'friends') {
            return <button onClick={() => setConfirmingDeleteFriend(targetUser)} className="flex items-center gap-1 p-2 bg-green-500/20 hover:bg-red-500/20 rounded-lg border border-green-500/30 hover:border-red-500/30 transition-all"><Icon name="userCheck" className="w-4 h-4 md:w-5 md:h-5 text-green-400" /></button>;
        }
        if (friendshipStatus === 'request_sent') {
            return <button onClick={() => friendAction(targetUser.id, 'reject')} className="flex items-center gap-1 p-2 bg-yellow-500/20 rounded-lg border border-yellow-500/30"><Icon name="userClock" className="w-4 h-4 md:w-5 md:h-5 text-yellow-400" /></button>;
        }
        if (friendshipStatus === 'request_received') {
            return (
                <div className="flex gap-2">
                    <button onClick={() => setConfirmingAddFriend(targetUser)} className="flex items-center gap-1 p-2 bg-green-500/20 hover:bg-green-500/30 rounded-lg border border-green-500/30"><Icon name="check" className="w-4 h-4 md:w-5 md:h-5 text-green-400" /></button>
                    <button onClick={() => friendAction(targetUser.id, 'reject')} className="flex items-center gap-1 p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg border border-red-500/30"><Icon name="x" className="w-4 h-4 md:w-5 md:h-5 text-red-400" /></button>
                </div>
            );
        }
        return <button onClick={() => friendAction(targetUser.id, 'request')} className="flex items-center gap-1 p-2 bg-purple-500/20 hover:bg-purple-500/30 rounded-lg border border-purple-500/30 transition-all"><Icon name="userPlus" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" /></button>;
    };
    
    const UserListFriendButton = ({ targetUser }) => {
        const isFriend = friends.some(f => f.id === targetUser.id);
        const isRequestReceived = friendRequests.some(r => r.id === targetUser.id);
        const isRequestSent = sentRequests.includes(targetUser.id);

        if (isFriend) {
            return <button onClick={() => setConfirmingDeleteFriend(targetUser)} className="p-2 bg-green-500/20 hover:bg-red-500/20 rounded-lg transition-all"><Icon name="userCheck" className="w-5 h-5 text-green-400" /></button>;
        }
        if (isRequestReceived) {
            return (<div className="flex gap-2">
                <button onClick={() => setConfirmingAddFriend(targetUser)} className="p-2 bg-green-500/20 hover:bg-green-500/30 rounded-lg"><Icon name="check" className="w-5 h-5 text-green-400" /></button>
                <button onClick={() => friendAction(targetUser.id, 'reject')} className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg"><Icon name="x" className="w-5 h-5 text-red-400" /></button>
            </div>);
        }
        if (isRequestSent) {
            return <button onClick={() => friendAction(targetUser.id, 'reject')} className="p-2 bg-yellow-500/20 hover:bg-red-500/20 rounded-lg"><Icon name="userClock" className="w-5 h-5 text-yellow-400" /></button>;
        }
        return <button onClick={() => friendAction(targetUser.id, 'request')} className="p-2 bg-purple-500/20 hover:bg-purple-500/30 rounded-lg"><Icon name="userPlus" className="w-5 h-5 text-purple-400" /></button>;
    };

      const toggleColumnExpansion = (boardId) => {
        setExpandedColumns(prev => ({...prev, [boardId]: !prev[boardId]}));
      };

      if (showAuth) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
            <div className="bg-gray-900/90 backdrop-blur-xl rounded-2xl p-8 w-full max-w-md border border-purple-500/30 shadow-2xl">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4 animate-pulse">üéÆ</div>
                <h1 className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 mb-2">GameTracker</h1>
                <p className="text-gray-400 text-lg">–¢–≤–æ–π –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
              </div>
              <div className="flex gap-2 mb-6">
                <button onClick={() => { setAuthMode('login'); setError(''); }} className={`flex-1 py-3 rounded-lg font-semibold transition-all ${authMode === 'login' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>–í—Ö–æ–¥</button>
                <button onClick={() => { setAuthMode('register'); setError(''); }} className={`flex-1 py-3 rounded-lg font-semibold transition-all ${authMode === 'register' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
              </div>
              {error && <div className="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-sm">{error}</div>}
              <div className="space-y-4">
                <input type="text" placeholder="–õ–æ–≥–∏–Ω" value={formData.username} onChange={(e) => setFormData({ ...formData, username: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />
                <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" value={formData.password} onChange={(e) => setFormData({ ...formData, password: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />
                {authMode === 'register' && <input type="email" placeholder="Email" value={formData.email} onChange={(e) => setFormData({ ...formData, email: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />}
                <button onClick={handleAuth} disabled={loading} className="w-full py-3 bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 text-white font-bold rounded-lg hover:from-purple-600 hover:via-pink-600 hover:to-blue-600 transition-all transform hover:scale-105 shadow-xl disabled:opacity-50 flex items-center justify-center gap-2">
                  {loading ? <><Icon name="loader" className="w-5 h-5" />–ó–∞–≥—Ä—É–∑–∫–∞...</> : (authMode === 'login' ? 'üöÄ –í–æ–π—Ç–∏' : '‚ú® –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è')}
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className={`min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-blue-900 ${theme} flex flex-col`}>
          {imageForCrop && <AvatarCropModal src={imageForCrop} onCancel={() => setImageForCrop(null)} onComplete={handleAvatarUpdate} />}
          {gameForReview && <DeepReviewModal game={gameForReview} existingAnswers={gameForReview.deep_review_answers} onClose={() => setGameForReview(null)} onSubmit={submitDeepReview} />}
          <header className="bg-gray-900/50 backdrop-blur-xl border-b border-purple-500/30 sticky top-0 z-50 flex-shrink-0">
            <div className="container mx-auto px-4 py-4">
              <div className="flex items-center justify-between flex-wrap gap-4">
                <div className="flex items-center gap-4 flex-wrap">
                  <h1 onClick={() => { setViewingUser(null); loadBoards(localStorage.getItem('token')); }} className="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 cursor-pointer">üéÆ GameTracker</h1>
                  {!viewingUser && (
                    <div className="relative">
                      <button onClick={() => setShowSearch(!showSearch)} className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 hover:from-purple-500/30 hover:to-pink-500/30 rounded-lg transition-all border border-purple-500/30">
                        <Icon name="search" className="w-4 h-4 text-purple-400" />
                        <span className="text-gray-300 font-semibold text-sm md:text-base">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É</span>
                      </button>
                      {showSearch && (
                        <div className="absolute top-full mt-2 left-0 w-80 md:w-96 bg-gray-800/95 backdrop-blur-xl rounded-lg shadow-2xl border border-purple-500/30 p-4 z-50">
                          <div className="flex items-center gap-2 mb-3">
                            <input type="text" value={searchQuery} onChange={(e) => handleSearch(e.target.value)} placeholder="–ü–æ–∏—Å–∫ –∏–≥—Ä—ã..." className="flex-1 px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white text-sm" autoFocus />
                            <button onClick={() => { setShowSearch(false); setSearchQuery(''); setSearchResults([]); }} className="p-2 hover:bg-gray-700 rounded-lg">
                              <Icon name="x" className="w-5 h-5 text-gray-400" />
                            </button>
                          </div>
                          <div className="space-y-2 max-h-80 overflow-y-auto">
                            {searching ? (
                              <div className="flex items-center justify-center py-8">
                                <Icon name="loader" className="w-6 h-6 text-purple-400" />
                              </div>
                            ) : searchResults.length > 0 ? (
                              searchResults.map(game => (
                                <div key={game.id} className="flex items-center gap-3 p-2 hover:bg-gray-700 rounded-lg">
                                  {game.cover ? <img src={game.cover} alt={game.name} className="w-10 h-14 object-cover rounded" /> : <div className="w-10 h-14 bg-gray-700 rounded flex items-center justify-center text-xl">üéÆ</div>}
                                  <div className="flex-1 min-w-0">
                                    <p className="text-white font-semibold text-sm truncate">{game.name}</p>
                                    {game.genres && game.genres.length > 0 && <p className="text-xs text-gray-400 truncate">{game.genres.slice(0, 2).join(', ')}</p>}
                                  </div>
                                  <select onChange={(e) => e.target.value && addGameToBoard(game, e.target.value)} className="px-2 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white cursor-pointer" defaultValue="">
                                    <option value="" disabled>+</option>
                                    <option value="backlog">üìã –ë–µ–∫–ª–æ–≥</option>
                                    <option value="playing">üéÆ –ò–≥—Ä–∞—é</option>
                                    <option value="completed">‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ</option>
                                    <option value="dropped">‚ùå –ë—Ä–æ—à–µ–Ω–æ</option>
                                  </select>
                                </div>
                              ))
                            ) : searchQuery.length >= 3 ? (
                              <p className="text-gray-400 text-center py-4 text-sm">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                            ) : (
                              <p className="text-gray-400 text-center py-4 text-sm">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</p>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2 md:gap-3">
                  <div className="flex items-center gap-2 px-3 md:px-4 py-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg border border-purple-500/30">
                    <Avatar src={viewingUser ? viewingUser.avatar : user?.avatar} size="sm" />
                    <div>
                      <span className="text-white font-semibold text-sm md:text-base block">{viewingUser ? (userNickname || viewingUser.username) : user?.username}</span>
                      {viewingUser && userNickname && <span className="text-xs text-gray-400">@{viewingUser.username}</span>}
                    </div>
                  </div>
                  {viewingUser ? (
                    <Fragment>
                      {friendshipStatus === 'friends' && (
                        <button onClick={() => setEditingNickname(true)} className="p-2 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg border border-blue-500/30">
                          <Icon name="tag" className="w-4 h-4 md:w-5 md:h-5 text-blue-400" />
                        </button>
                      )}
                      <FriendActionButton targetUser={viewingUser} />
                      <button onClick={() => { setViewingUser(null); loadBoards(localStorage.getItem('token')); }} className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700">
                        <Icon name="x" className="w-4 h-4 md:w-5 md:h-5 text-gray-400" />
                      </button>
                    </Fragment>
                  ) : (
                    <Fragment>
                      <button onClick={() => { setShowUserHub(true); loadAllUsers(); }} className="p-2 hover:bg-gray-800 rounded-lg border border-purple-500/30 relative">
                        <Icon name="users" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" />
                        {friendRequests.length > 0 && <span className="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white"></span>}
                      </button>
                      <button onClick={() => setShowProfile(true)} className="p-2 hover:bg-gray-800 rounded-lg border border-purple-500/30">
                        <Icon name="settings" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" />
                      </button>
                    </Fragment>
                  )}
                  <button onClick={handleLogout} className="p-2 hover:bg-red-900/50 rounded-lg border border-red-500/30">
                    <Icon name="logout" className="w-4 h-4 md:w-5 md:h-5 text-red-400" />
                  </button>
                </div>
              </div>
            </div>
          </header>

          <main className="flex-grow">
              {showProfile && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 max-h-[90vh] overflow-y-auto">
                      <h2 className="text-2xl font-bold text-white mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                      <div className="space-y-4">
                      <div className="flex flex-col items-center gap-3">
                          <Avatar src={user?.avatar} size="xl" />
                          <input type="file" ref={fileInputRef} onChange={handleFileSelect} accept="image/*" className="hidden" />
                          <button onClick={() => fileInputRef.current?.click()} disabled={uploadingAvatar} className="flex items-center gap-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-all disabled:opacity-50">
                          {uploadingAvatar ? <Icon name="loader" className="w-4 h-4" /> : <Icon name="upload" className="w-4 h-4" />}
                          {uploadingAvatar ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä'}
                          </button>
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                          <input type="text" value={profileData.username} onChange={(e) => setProfileData({ ...profileData, username: e.target.value })} placeholder={user?.username} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–û —Å–µ–±–µ:</label>
                          <textarea value={profileData.bio} onChange={(e) => setProfileData({ ...profileData, bio: e.target.value })} placeholder={user?.bio || "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" rows="3" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:</label>
                          <div className="flex gap-2 mt-1">
                              <button onClick={() => setTheme('default')} className={`flex-1 py-2 rounded-lg text-sm ${theme === 'default' ? 'bg-purple-500 text-white' : 'bg-gray-800'}`}>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                              <button onClick={() => setTheme('liquid-eye')} className={`flex-1 py-2 rounded-lg text-sm ${theme === 'liquid-eye' ? 'bg-white text-black' : 'bg-gray-800'}`}>Liquid Eye</button>
                          </div>
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å (–¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è):</label>
                          <input type="password" value={profileData.currentPassword} onChange={(e) => setProfileData({ ...profileData, currentPassword: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                          <input type="password" value={profileData.newPassword} onChange={(e) => setProfileData({ ...profileData, newPassword: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      <div className="flex gap-2 mt-6">
                          <button onClick={updateProfile} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg hover:from-purple-600 hover:to-pink-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                          <button onClick={() => setShowProfile(false)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                      </div>
                      </div>
                  </div>
                  </div>
              )}
              
              {editingNickname && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30">
                      <h2 className="text-xl font-bold text-white mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–∫—É –¥–ª—è {viewingUser?.username}</h2>
                      <input type="text" value={userNickname} onChange={(e) => setUserNickname(e.target.value)} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ—É—á—à–∏–π –¥—Ä—É–≥, –ö–æ–ª–ª–µ–≥–∞..." className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mb-4" />
                      <div className="flex gap-2">
                      <button onClick={() => updateNickname(viewingUser.id, userNickname)} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                      <button onClick={() => setEditingNickname(false)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg">–û—Ç–º–µ–Ω–∞</button>
                      </div>
                  </div>
                  </div>
              )}

              {showUserHub && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-3xl border border-purple-500/30 max-h-[80vh] flex flex-col">
                      <div className="flex justify-between items-center mb-4 flex-shrink-0">
                      <h2 className="text-2xl font-bold text-white">–°–æ–æ–±—â–µ—Å—Ç–≤–æ</h2>
                      <button onClick={() => setShowUserHub(false)} className="p-2 hover:bg-gray-800 rounded-lg"><Icon name="x" className="w-5 h-5 text-gray-400" /></button>
                      </div>
                      
                      <div className="overflow-y-auto">
                          {friendRequests.length > 0 && (
                              <div className="mb-6">
                                  <h3 className="text-lg font-bold text-white mb-3">–ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è ({friendRequests.length})</h3>
                                  <div className="space-y-3">
                                      {friendRequests.map(req => (
                                          <div key={req.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                                              <Avatar src={req.avatar} size="md" />
                                              <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), req.id); setShowUserHub(false); }}>
                                                  <p className="text-white font-semibold">{req.username}</p>
                                              </div>
                                              <UserListFriendButton targetUser={req} />
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          )}

                          {friends.length > 0 && (
                          <div className="mb-6">
                              <h3 className="text-lg font-bold text-white mb-3">–ú–æ–∏ –¥—Ä—É–∑—å—è ({friends.length})</h3>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {friends.map(friend => (
                                  <div key={friend.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg group">
                                  <Avatar src={friend.avatar} size="md" />
                                  <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), friend.id); setShowUserHub(false); }}>
                                      <p className="text-white font-semibold">{friend.nickname || friend.username}</p>
                                      {friend.nickname && <p className="text-xs text-gray-400">@{friend.username}</p>}
                                  </div>
                                  <button onClick={() => setConfirmingDeleteFriend(friend)} className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="x" className="w-5 h-5 text-red-400" /></button>
                                  </div>
                              ))}
                              </div>
                          </div>
                          )}

                          <div>
                          <h3 className="text-lg font-bold text-white mb-3">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                          <input type="text" value={userSearchQuery} onChange={(e) => { setUserSearchQuery(e.target.value); loadAllUsers(e.target.value); }} placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mb-4" />
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {allUsers.map(u => (
                              <div key={u.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                                  <Avatar src={u.avatar} size="md" />
                                  <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), u.id); setShowUserHub(false); }}>
                                  <p className="text-white font-semibold">{u.username}</p>
                                  </div>
                                  <UserListFriendButton targetUser={u} />
                              </div>
                              ))}
                          </div>
                          </div>
                      </div>
                  </div>
                  </div>
              )}

              {selectedGame && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 max-h-[90vh] overflow-y-auto">
                      <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold text-white">{selectedGame.name}</h2>
                      <button onClick={() => setSelectedGame(null)} className="p-2 hover:bg-gray-800 rounded-lg"><Icon name="x" className="w-5 h-5 text-gray-400" /></button>
                      </div>
                      <div className="space-y-4">
                      {!viewingUser ? (
                          <Fragment>
                          <div>
                              <p className="text-gray-400 text-sm mb-2">–†–µ–π—Ç–∏–Ω–≥:</p>
                              <div className="flex gap-2">
                              {[1, 2, 3, 4, 5].map(star => (
                                  <button key={star} onClick={() => updateGame(selectedGame.id, { rating: star })} className="transition-transform hover:scale-110">
                                  <Icon name="star" className={`w-8 h-8 ${star <= (selectedGame.rating || 0) ? 'text-yellow-400' : 'text-gray-600'}`} />
                                  </button>
                              ))}
                              </div>
                          </div>
                          <div>
                              <label className="text-gray-400 text-sm">–ó–∞–º–µ—Ç–∫–∏:</label>
                              <textarea defaultValue={selectedGame.notes || ''} onBlur={(e) => updateGame(selectedGame.id, { notes: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" rows="3" placeholder="–¢–≤–æ–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è..." />
                          </div>
                          </Fragment>
                      ) : (
                          <Fragment>
                              {selectedGame.rating && 
                                  <div>
                                      <p className="text-gray-400 text-sm mb-2">–†–µ–π—Ç–∏–Ω–≥ –æ—Ç {viewingUser.username}:</p>
                                      <div className="flex gap-1">
                                          {[...Array(5)].map((_, i) => (<Icon key={i} name="star" className={`w-6 h-6 ${i < selectedGame.rating ? 'text-yellow-400' : 'text-gray-600'}`} />))}
                                      </div>
                                  </div>
                              }
                              {selectedGame.notes &&
                                  <div>
                                      <p className="text-gray-400 text-sm mb-1">–ó–∞–º–µ—Ç–∫–∏ –æ—Ç {viewingUser.username}:</p>
                                      <p className="text-white bg-gray-800 p-3 rounded-lg border border-gray-700">{selectedGame.notes}</p>
                                  </div>
                              }
                              {(!selectedGame.notes && !selectedGame.rating) && <p className="text-gray-400">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Å—Ç–∞–≤–∏–ª –æ—Ç–∑—ã–≤–∞.</p>}
                              <div className="pt-2">
                                <p className="text-gray-400 text-sm mb-2">–í–∞—à–∞ —Ä–µ–∞–∫—Ü–∏—è:</p>
                                <div className="flex flex-wrap gap-2">
                                  {REACTION_EMOJIS.map(emoji => (
                                      <button
                                          key={emoji}
                                          onClick={() => addReaction(selectedGame.id, emoji)}
                                          className={`text-2xl transform hover:scale-125 transition-transform p-1 rounded-full ${selectedGame.reactions.find(r => r.user_id === user.id && r.emoji === emoji) ? 'bg-purple-500/30' : ''}`}
                                          title={`React with ${emoji}`}
                                      >
                                          {emoji}
                                      </button>
                                  ))}
                                </div>
                              </div>
                          </Fragment>
                      )}
                      
                      {selectedGame.deep_review_answers && <DisplayDeepReview answers={selectedGame.deep_review_answers} />}
                      
                      {selectedGame.reactions && selectedGame.reactions.length > 0 && (
                          <div>
                          <p className="text-gray-400 text-sm mb-2">–í—Å–µ —Ä–µ–∞–∫—Ü–∏–∏:</p>
                          <div className="flex flex-wrap gap-2">
                              {selectedGame.reactions.map((reaction, idx) => (
                              <div key={idx} className="flex items-center gap-1 bg-gray-800 px-3 py-1 rounded-full">
                                  <span className="text-xl">{reaction.emoji}</span>
                                  <span className="text-xs text-gray-400">{reaction.username}</span>
                              </div>
                              ))}
                          </div>
                          </div>
                      )}
                      <div className="flex gap-2 mt-4">
                        <a 
                            href={selectedGame.videoId ? `https://www.youtube.com/watch?v=${selectedGame.videoId}` : `https://www.youtube.com/results?search_query=${encodeURIComponent(selectedGame.name + ' trailer')}`} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="flex-1 flex items-center justify-center gap-2 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">
                            <Icon name="youtube" className="w-6 h-6" />
                            –¢—Ä–µ–π–ª–µ—Ä
                        </a>
                        {!viewingUser && selectedGame.deep_review_answers && (
                            <button 
                                onClick={() => handleDeleteReview(selectedGame.id)}
                                className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg"
                                title="–£–¥–∞–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤"
                            >
                                <Icon name="trash" className="w-5 h-5 text-red-400"/>
                            </button>
                        )}
                      </div>
                      </div>
                  </div>
                  </div>
              )}
              
              {confirmingDeleteFriend && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-red-500/30">
                      <h2 className="text-xl font-bold text-white mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
                      <p className="text-gray-300 mb-6">
                      –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <span className="font-bold text-white">{confirmingDeleteFriend.username}</span> –∏–∑ –¥—Ä—É–∑–µ–π?
                      </p>
                      <div className="flex gap-2">
                      <button onClick={() => { friendAction(confirmingDeleteFriend.id, 'remove'); setConfirmingDeleteFriend(null); }}
                          className="flex-1 py-2 bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold rounded-lg hover:from-red-600 hover:to-orange-600">
                          –£–¥–∞–ª–∏—Ç—å
                      </button>
                      <button onClick={() => setConfirmingDeleteFriend(null)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                      </div>
                  </div>
                  </div>
              )}

              {confirmingAddFriend && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-green-500/30">
                      <h2 className="text-xl font-bold text-white mb-4">–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è</h2>
                      <p className="text-gray-300 mb-6">
                      –ü—Ä–∏–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç <span className="font-bold text-white">{confirmingAddFriend.username}</span>?
                      </p>
                      <div className="flex gap-2">
                      <button onClick={() => { friendAction(confirmingAddFriend.id, 'accept'); setConfirmingAddFriend(null); }}
                          className="flex-1 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-lg hover:from-green-600 hover:to-emerald-600">
                          –ü—Ä–∏–Ω—è—Ç—å
                      </button>
                      <button onClick={() => {friendAction(confirmingAddFriend.id, 'reject'); setConfirmingAddFriend(null); }} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                      </div>
                  </div>
                  </div>
              )}

              <div className="container mx-auto px-4 py-6">
                  {viewingUser && (
                  <div className="mb-6 bg-gradient-to-r from-purple-900/50 to-blue-900/50 backdrop-blur-xl rounded-xl p-6 border border-purple-500/30">
                      <div className="flex items-center gap-4">
                      <Avatar src={viewingUser.avatar} size="lg" />
                      <div className="flex-1">
                          <h2 className="text-3xl font-bold text-white">{userNickname || viewingUser.username}</h2>
                          {userNickname && <p className="text-gray-400">@{viewingUser.username}</p>}
                          {viewingUser.bio && <p className="text-gray-300 mt-2">{viewingUser.bio}</p>}
                      </div>
                      </div>
                  </div>
                  )}

                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                  {Object.values(boards).map(board => {
                      const isExpanded = !!expandedColumns[board.id];
                      const visibleCards = isExpanded ? board.cards : board.cards.slice(0, GAMES_PER_COLUMN);

                      return (
                      <div key={board.id} 
                          onDragOver={handleDragOver}
                          onDragEnter={handleDragEnterColumn}
                          onDragLeave={handleDragLeaveColumn}
                          onDrop={(e) => !viewingUser && handleDrop(e, board.id, undefined)} 
                          className={`bg-gradient-to-br ${board.color} backdrop-blur-xl rounded-xl p-4 border ${board.borderColor} flex flex-col transition-colors`}>
                          <div className="flex items-center justify-between mb-4">
                          <h2 className="text-lg md:text-xl font-bold text-white flex items-center gap-2"><span className="text-xl md:text-2xl">{board.emoji}</span><span className="hidden sm:inline">{board.title}</span></h2>
                          <span className="bg-white/10 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-bold">{board.cards.length}</span>
                          </div>
                          
                          <div className="space-y-2 flex-grow min-h-[100px]">
                          {visibleCards.map((card, index) => (
                              <div key={card.id} 
                                  draggable={!viewingUser}
                                  onDragStart={(e) => handleDragStart(e, card, board.id, index)}
                                  onDragEnd={handleDragEnd}
                                  onDrop={(e) => !viewingUser && handleDrop(e, board.id, index)}
                                  onDragEnter={handleDragEnterCard}
                                  onDragLeave={handleDragLeaveCard}
                                  className="bg-gray-800/80 rounded-lg border border-gray-700 hover:border-purple-500 transition-all cursor-pointer flex gap-3 p-2 group relative" 
                                  onClick={() => setSelectedGame(card)}>
                              
                              {card.cover ? 
                                  <img src={card.cover} alt={card.name} className="w-14 h-20 object-cover rounded-md flex-shrink-0" /> : 
                                  <div className="w-14 h-20 bg-gray-700 rounded-md flex items-center justify-center text-2xl flex-shrink-0">üéÆ</div>
                              }
                              <div className="flex flex-col justify-between flex-grow min-w-0 py-1">
                                  <div>
                                      <h3 className="text-white font-semibold text-sm truncate">{card.name}</h3>
                                      {card.rating && !viewingUser && <div className="flex gap-0.5 mt-1">
                                          {[...Array(5)].map((_, i) => (<Icon key={i} name="star" className={`w-3 h-3 ${i < card.rating ? 'text-yellow-400' : 'text-gray-600'}`} />))}
                                      </div>}
                                  </div>
                                  <div className="flex items-end justify-between w-full">
                                    {card.reactions && card.reactions.length > 0 && (
                                        <div className="flex gap-1.5 mt-1 flex-wrap items-center">
                                        {card.reactions.slice(0, 4).map((r, i) => <span key={i} className="text-lg">{r.emoji}</span>)}
                                        {card.reactions.length > 4 && <span className="text-xs text-gray-400 self-center">+{card.reactions.length - 4}</span>}
                                        </div>
                                    )}
                                    {board.id === 'completed' && !viewingUser && (
                                        <button 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setGameForReview(card);
                                            }}
                                            className="p-1.5 bg-purple-500/80 hover:bg-purple-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity self-end flex-shrink-0 z-10"
                                            title={card.deep_review_answers ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤" : "–û—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤"}
                                        >
                                            <Icon name="edit" className="w-3 h-3 text-white"/>
                                        </button>
                                    )}
                                   </div>
                              </div>
                              {!viewingUser && (
                                  <button onClick={(e) => deleteCard(e, card.id)} className="absolute top-1 right-1 p-1.5 bg-red-600/80 hover:bg-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity self-start flex-shrink-0 z-10">
                                      <Icon name="trash" className="w-3 h-3 text-white" />
                                  </button>
                                  )}
                              </div>
                          ))}
                          </div>

                          {board.cards.length > GAMES_PER_COLUMN && (
                              <button onClick={() => toggleColumnExpansion(board.id)} className="w-full text-center mt-3 py-1.5 text-xs font-semibold text-purple-300 bg-purple-500/10 hover:bg-purple-500/20 rounded-lg flex items-center justify-center gap-1">
                              {isExpanded ? '–°–≤–µ—Ä–Ω—É—Ç—å' : `–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ ${board.cards.length - GAMES_PER_COLUMN}`}
                              <Icon name={isExpanded ? 'chevronUp' : 'chevronDown'} className="w-3 h-3" />
                              </button>
                          )}
                      </div>
                      )})}
                  </div>
                  <div className="mt-6 md:mt-8 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                  <div className="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 backdrop-blur-xl rounded-xl p-4 md:p-6 border border-blue-500/30">
                      <div className="text-2xl md:text-4xl mb-2">üìä</div>
                      <h3 className="text-xs md:text-sm font-semibold text-gray-300 mb-1">–í—Å–µ–≥–æ</h3>
                      <p className="text-2xl md:text-3xl font-bold text-white">{Object.values(boards).reduce((acc, board) => acc + board.cards.length, 0)}</p>
                  </div>
                  <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-xl rounded-xl p-4 md:p-6 border border-green-500/30">
                      <div className="text-2xl md:text-4xl mb-2">‚úÖ</div>
                      <h3 className="text-xs md:text-sm font-semibold text-gray-300 mb-1">–ü—Ä–æ–π–¥–µ–Ω–æ</h3>
                      <p className="text-2xl md:text-3xl font-bold text-white">{boards.completed.cards.length}</p>
                  </div>
                  <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-xl rounded-xl p-4 md:p-6 border border-purple-500/30">
                      <div className="text-2xl md:text-4xl mb-2">üéÆ</div>
                      <h3 className="text-xs md:text-sm font-semibold text-gray-300 mb-1">–ò–≥—Ä–∞—é</h3>
                      <p className="text-2xl md:text-3xl font-bold text-white">{boards.playing.cards.length}</p>
                  </div>
                  <div className="bg-gradient-to-br from-orange-500/20 to-red-500/20 backdrop-blur-xl rounded-xl p-4 md:p-6 border border-orange-500/30">
                      <div className="text-2xl md:text-4xl mb-2">üìã</div>
                      <h3 className="text-xs md:text-sm font-semibold text-gray-300 mb-1">–ë–µ–∫–ª–æ–≥</h3>
                      <p className="text-2xl md:text-3xl font-bold text-white">{boards.backlog.cards.length}</p>
                  </div>
                  </div>
                  
                  {!viewingUser && <ActivityFeed token={localStorage.getItem('token')} />}

                  {/* V-- –ë–õ–û–ö –° –ò–ì–†–û–ô --V */}
                  {!viewingUser && (
                    <div className="mt-8">
                      <div id="game-container" style={{
                          border: '2px solid #8b5cf6',
                          borderRadius: '12px',
                          overflow: 'hidden',
                          boxShadow: '0 0 20px rgba(139, 92, 246, 0.5)',
                          background: '#111',
                          position: 'relative',
                          width: '100%',
                          maxWidth: '900px',
                          margin: '0 auto'
                      }}>
                          <canvas id="gameCanvas" style={{ width: '100%', display: 'block' }}></canvas>
                          <div id="game-overlay" style={{ display: 'none' }}>
                              <h2 id="overlay-title"></h2>
                              <p id="final-score"></p>
                              <div id="high-scores" style={{ marginTop: '20px', display: 'none' }}>
                                   <p id="friend-record"><strong>–†–µ–∫–æ—Ä–¥ –¥—Ä—É–∑–µ–π:</strong> –ó–∞–≥—Ä—É–∑–∫–∞...</p>
                                   <p id="global-record"><strong>–û–±—â–∏–π —Ä–µ–∫–æ—Ä–¥:</strong> –ó–∞–≥—Ä—É–∑–∫–∞...</p>
                              </div>
                              <button id="restart-button"></button>
                          </div>
                      </div>
                    </div>
                  )}
                  {/* A-- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ò–ì–†–´ --A */}

              </div>
          </main>
        </div>
      );
    };

    const DEEP_REVIEW_QUESTIONS = [
        { block: '–ü–µ—Ä–≤–æ–µ –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –∏ –°—é–∂–µ—Ç', questions: [
            { id: 1, text: "–ß—Ç–æ –≤–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∑–∞—Ü–µ–ø–∏–ª–æ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã?", answers: ["–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ –º–∏—Ä, –≤ –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–∑—É —Ö–æ—á–µ—Ç—Å—è –ø–æ–≥—Ä—É–∑–∏—Ç—å—Å—è", "–∏–Ω—Ç—Ä–∏–≥—É—é—â–∞—è –∑–∞–≤—è–∑–∫–∞ —Å—é–∂–µ—Ç–∞", "–¥–∏–Ω–∞–º–∏—á–Ω—ã–π –≥–µ–π–º–ø–ª–µ–π —Å –ø–µ—Ä–≤—ã—Ö –º–∏–Ω—É—Ç", "–ø–æ—Ç—Ä—è—Å–∞—é—â–∏–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏ –≥—Ä–∞—Ñ–∏–∫–∞", "–Ω–∏—á–µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ, –∏–≥—Ä–∞ —Ä–∞–∑–≥–æ–Ω—è–ª–∞—Å—å –º–µ–¥–ª–µ–Ω–Ω–æ", "—Å–∫—É—á–Ω–æ–µ –∏ –∑–∞—Ç—è–Ω—É—Ç–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ"] },
            { id: 2, text: "–ö–∞–∫ –±—ã –≤—ã –æ–ø–∏—Å–∞–ª–∏ —Å—é–∂–µ—Ç –∏–≥—Ä—ã?", answers: ["–≥–ª—É–±–æ–∫–∏–º –∏ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—ã–º, –∑–∞—Å—Ç–∞–≤–ª—è—é—â–∏–º –∑–∞–¥—É–º–∞—Ç—å—Å—è", "–ø—Ä–æ—Å—Ç—ã–º, –Ω–æ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º –∏ —Ö–æ—Ä–æ—à–æ –ø–æ–¥–∞–Ω–Ω—ã–º", "—ç–ø–∏—á–Ω—ã–º –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–º, —Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏", "–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º, –Ω–æ —Å–ª—É–∂–∞—â–∏–º —Ö–æ—Ä–æ—à–∏–º —Ñ–æ–Ω–æ–º", "–≤—Ç–æ—Ä–∏—á–Ω—ã–º, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ª–∏—à—å –¥–ª—è –≥–∞–ª–æ—á–∫–∏", "—Å–ª–∞–±—ã–º, –Ω–µ–ª–æ–≥–∏—á–Ω—ã–º –∏–ª–∏ –ø–æ–ø—Ä–æ—Å—Ç—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º"] },
            { id: 3, text: "–ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∏?", answers: ["–æ—á–µ–Ω—å –∂–∏–≤—ã–º–∏ –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º–∏—Å—è, –∏–º —Å–æ–ø–µ—Ä–µ–∂–∏–≤–∞–µ—à—å", "—Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–º–∏, —Ö–æ—Ç—å –∏ –Ω–µ–º–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–Ω—ã–º–∏", "–ø—Ä–æ—Å—Ç—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è —Å—é–∂–µ—Ç–∞", "—Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π/–≥–µ—Ä–æ–∏–Ω—è –±—ã–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏", "–Ω–µ–≤–∞–∂–Ω—ã–º–∏ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏", "–ø–ª–æ—Å–∫–∏–º–∏ –∏ –Ω–µ–≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–º–∏, —Å–∫–æ—Ä–µ–µ —Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–∏–º–∏"] },
            { id: 4, text: "–ó–∞–ø–æ–º–Ω–∏–ª—Å—è –ª–∏ –≤–∞–º –º–∏—Ä –∏–≥—Ä—ã (–ª–æÃÅ—Ä)?", answers: ["–¥–∞, —ç—Ç–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –≤—Å–µ–ª–µ–Ω–Ω–∞—è", "–º–∏—Ä –±—ã–ª –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω, –Ω–æ –º–Ω–æ–≥–æ–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞ –∫–∞–¥—Ä–æ–º", "–æ–Ω —Å–ª—É–∂–∏–ª –ª–∏—à—å –∫—Ä–∞—Å–∏–≤–æ–π –¥–µ–∫–æ—Ä–∞—Ü–∏–µ–π", "–º–∏—Ä –¥–æ–≤–æ–ª—å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–ª—è —Å–≤–æ–µ–≥–æ –∂–∞–Ω—Ä–∞", "–≤ –∏–≥—Ä–µ –Ω–µ –±—ã–ª–æ –∞–∫—Ü–µ–Ω—Ç–∞ –Ω–∞ –≥–ª—É–±–æ–∫–∏–π –ª–æ—Ä", "–º–∏—Ä –ø–æ–∫–∞–∑–∞–ª—Å—è –ø—É—Å—Ç—ã–º –∏ –±–µ–∑–∂–∏–∑–Ω–µ–Ω–Ω—ã–º"] },
        ]},
        { block: '–ì–µ–π–º–ø–ª–µ–π –∏ –ú–µ—Ö–∞–Ω–∏–∫–∏', questions: [
            { id: 5, text: "–ö–∞–∫–æ–µ —Å–ª–æ–≤–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –≥–µ–π–º–ø–ª–µ–π?", answers: ["–º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã–º", "–¥–∏–Ω–∞–º–∏—á–Ω—ã–º", "—Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–º", "–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º", "–∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º", "–æ–¥–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º"] },
            { id: 6, text: "–ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã –∏–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏?", answers: ["–ø—Ä–µ–¥–ª–∞–≥–∞–ª–∏ —á—Ç–æ-—Ç–æ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–æ–≤–æ–µ", "—Å–æ—á–µ—Ç–∞–ª–∏ –∑–Ω–∞–∫–æ–º—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏–¥–µ—è–º–∏", "–±—ã–ª–∏ –æ—Ç–ª–∏—á–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–µ–º –∏–¥–µ–π", "–±—ã–ª–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–º–∏, –±–µ–∑ –∏–∑—ã—Å–∫–æ–≤", "–∫–∞–∑–∞–ª–∏—Å—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –∏–ª–∏ –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–º–∏", "–±—ã–ª–∏ —Å–ª–æ–º–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ –ø–ª–æ—Ö–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏"] },
            { id: 7, text: "–ë—ã–ª–æ –ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–≥—Ä–µ —É–¥–æ–±–Ω—ã–º?", answers: ["–∞–±—Å–æ–ª—é—Ç–Ω–æ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–º –∏ –æ—Ç–∑—ã–≤—á–∏–≤—ã–º", "–≤ —Ü–µ–ª–æ–º —É–¥–æ–±–Ω—ã–º, –Ω–æ —Ç—Ä–µ–±–æ–≤–∞–ª–æ –ø—Ä–∏–≤—ã–∫–∞–Ω–∏—è", "–ø—Ä–æ—Å—Ç—ã–º, —Ç–∞–º –Ω–µ–≥–¥–µ –±—ã–ª–æ –æ—à–∏–±–∏—Ç—å—Å—è", "—Å–ø–æ—Ä–Ω—ã–º, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –±—ã–ª–æ –Ω–µ—É–¥–æ–±–Ω–æ", "—á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ", "—É–∂–∞—Å–Ω—ã–º, –∏ —ç—Ç–æ —Å—Ç–∞–ª–æ –≥–ª–∞–≤–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π"] },
            { id: 8, text: "–ù–∞—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–µ–Ω –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å?", answers: ["–ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–¥–∫–∏–¥—ã–≤–∞–ª –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Å–∏—Ç—É–∞—Ü–∏–∏", "–±—ã–ª –æ–¥–Ω–æ–æ–±—Ä–∞–∑–µ–Ω, –Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∑–∞—Ç—è–≥–∏–≤–∞–ª", "–≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –Ω–∞—á–∞–ª –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è", "–Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è, —Ç–∞–∫ –∫–∞–∫ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ–¥–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∫–µ", "–∫ –∫–æ–Ω—Ü—É —Å—Ç–∞–ª –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ —Ä—É—Ç–∏–Ω–Ω—ã–º", "–Ω–∞—Å–∫—É—á–∏–ª —É–∂–µ –≤ –ø–µ—Ä–≤—ã–π —á–∞—Å –∏–∑-–∑–∞ –æ–¥–Ω–æ–æ–±—Ä–∞–∑–∏—è"] },
            { id: 9, text: "–ß—Ç–æ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ (—Ä–∞–∑–≤–∏—Ç–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π)?", answers: ["–ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è –æ—â—É—â–∞–ª–∞—Å—å –ø–ª–∞–≤–Ω–æ–π –∏ –Ω–∞–≥—Ä–∞–∂–¥–∞—é—â–µ–π", "–æ–Ω–∞ –±—ã–ª–∞, –Ω–æ –Ω–µ —Å–∏–ª—å–Ω–æ –≤–ª–∏—è–ª–∞ –Ω–∞ –≥–µ–π–º–ø–ª–µ–π", "–Ω–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ", "–≤ –∏–≥—Ä–µ –Ω–µ –±—ã–ª–æ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏", "–ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è –±—ã–ª–∞ —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ–π –∏ —Ç—Ä–µ–±–æ–≤–∞–ª–∞ –≥—Ä–∏–Ω–¥–∞", "–±—ã–ª–∞ –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π"] },
        ]},
        { block: '–ê—É–¥–∏–æ–≤–∏–∑—É–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ', questions: [
            { id: 10, text: "–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏–≥—Ä—ã?", answers: ["–Ω–∞—Å—Ç–æ—è—â–∏–º —à–µ–¥–µ–≤—Ä–æ–º, –≥–¥–µ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä ‚Äî –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞", "–æ—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω—ã–º –∏ —Å—Ç–∏–ª—å–Ω—ã–º, –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–º –Ω–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É", "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–º, –Ω–æ –±–µ–∑ –æ—Å–æ–±–æ–π ¬´–¥—É—à–∏¬ª", "–Ω–µ–ø–ª–æ—Ö–∏–º, –Ω–æ –Ω–∏—á–µ–º –Ω–µ –≤—ã–¥–µ–ª—è—é—â–∏–º—Å—è", "—Å–ª–∞–±—ã–º –º–µ—Å—Ç–æ–º –∏–≥—Ä—ã", "—É—Å—Ç–∞—Ä–µ–≤—à–∏–º –∏–ª–∏ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–º"] },
            { id: 11, text: "–ù–∞—Å–∫–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –±—ã–ª —Å–∞—É–Ω–¥-–¥–∏–∑–∞–π–Ω?", answers: ["–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω—ã–º, –º—É–∑—ã–∫–∞ –∏ –∑–≤—É–∫–∏ ‚Äî –ø–æ–ª–æ–≤–∏–Ω–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã", "—Ö–æ—Ä–æ—à–∏–º –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º—Å—è", "–ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è–ª —Å–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é, –Ω–µ –±–æ–ª–µ–µ", "—è –ø–æ—á—Ç–∏ –Ω–µ –æ–±—Ä–∞—â–∞–ª –Ω–∞ –Ω–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è", "—Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–∏–º —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º", "–æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ –ø–ª–æ—Ö–∏–º"] },
            { id: 12, text: "–ó–∞–ø–æ–º–Ω–∏–ª—Å—è –ª–∏ –≤–∞–º –∫–∞–∫–æ–π-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞—Å–ø–µ–∫—Ç –¥–∏–∑–∞–π–Ω–∞?", answers: ["–≤–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω —É—Ä–æ–≤–Ω–µ–π/–ª–æ–∫–∞—Ü–∏–π", "–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –≤—Ä–∞–≥–æ–≤", "—É–¥–æ–±–Ω—ã–π –∏ –∫—Ä–∞—Å–∏–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å", "–≤ —Ü–µ–ª–æ–º –≤—Å–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–æ –±–µ–∑ –≤–∞—É-—ç—Ñ—Ñ–µ–∫—Ç–∞", "–Ω–µ—Ç, –Ω–∏—á–µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–µ –∑–∞–ø–æ–º–Ω–∏–ª–æ—Å—å", "–Ω–µ—É–¥–æ–±–Ω—ã–µ –∏–ª–∏ –≤—ã–∑—ã–≤–∞—é—â–∏–µ –Ω–µ–¥–æ—É–º–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–∏–∑–∞–π–Ω–∞"] },
            { id: 13, text: "–ö–∞–∫ –æ–±—Å—Ç–æ—è–ª–∏ –¥–µ–ª–∞ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π (–±–∞–≥–∏, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)?", answers: ["–∏–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –∏–¥–µ–∞–ª—å–Ω–æ", "–±—ã–ª–∏ –º–µ–ª–∫–∏–µ, –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥–∏", "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –º–µ—à–∞–ª–∏", "–∏–≥—Ä–∞ –±—ã–ª–∞ –ø–ª–æ—Ö–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞", "–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–æ—Å—å –≤ –º—É—á–µ–Ω–∏–µ –∏–∑-–∑–∞ –±–∞–≥–æ–≤", "–∏–≥—Ä–∞ —á–∞—Å—Ç–æ –≤—ã–ª–µ—Ç–∞–ª–∞ –∏–ª–∏ –∏–º–µ–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏"] },
        ]},
        { block: '–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', questions: [
            { id: 14, text: "–ö–∞–∫ –±—ã –≤—ã –æ–ø–∏—Å–∞–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏–≥—Ä—ã?", answers: ["—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π ‚Äî –±—Ä–æ—Å–∞—é—â–µ–π –≤—ã–∑–æ–≤, –Ω–æ –Ω–µ –¥—É—à–∞—â–µ–π", "–≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π –ø–æ–¥ —Å–µ–±—è", "–¥–æ–≤–æ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π, –º–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏, –Ω–µ –Ω–∞–ø—Ä—è–≥–∞—è—Å—å", "–æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–π, –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π —Ö–∞—Ä–¥–∫–æ—Ä–∞", "–Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π –∏–∑-–∑–∞ –Ω–µ—É–¥–æ–±–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∫", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π, –Ω–∏–∫–∞–∫–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∏–≥—Ä–∞ –Ω–µ –±—Ä–æ—Å–∏–ª–∞"] },
            { id: 15, text: "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–≥—Ä—ã –≤–∞—à–∏–º –æ–∂–∏–¥–∞–Ω–∏—è–º?", answers: ["–∏–¥–µ–∞–ª—å–Ω–æ–π, –∏–≥—Ä–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –≤–æ–≤—Ä–µ–º—è", "—Ö–æ—Ç–µ–ª–æ—Å—å –±—ã, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –ø–æ–¥–ª–∏–Ω–Ω–µ–µ", "—ç—Ç–æ –∏–≥—Ä–∞-—Å–µ—Ä–≤–∏—Å –±–µ–∑ —á–µ—Ç–∫–æ–≥–æ –∫–æ–Ω—Ü–∞", "–æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–π, –æ–Ω–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ", "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞—Ç—è–Ω—É—Ç–æ–π", "–Ω–µ–æ–ø—Ä–∞–≤–¥–∞–Ω–Ω–æ –¥–ª–∏–Ω–Ω–æ–π"] },
            { id: 16, text: "–ö–∞–∫ –≤ –∏–≥—Ä–µ –æ—â—É—â–∞–µ—Ç—Å—è —Ç–µ–º–ø –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –≥–µ–π–º–ø–ª–µ—è?", answers: ["–æ—Ç–ª–∏—á–Ω—ã–º, –∏–≥—Ä–∞ –¥–µ—Ä–∂–∏—Ç –≤ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–∏ –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞", "—Å–ø–æ–∫–æ–π–Ω—ã–º –∏ —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω—ã–º", "–Ω–µ—Ä–æ–≤–Ω—ã–º, —Å –¥–∏–Ω–∞–º–∏—á–Ω—ã–º–∏ –∏ –ø—Ä–æ–≤–∏—Å–∞—é—â–∏–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏", "—Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä—ã–º, –Ω–µ –¥–∞—é—â–∏–º –ø—Ä–æ–Ω–∏–∫–Ω—É—Ç—å—Å—è —Å—é–∂–µ—Ç–æ–º", "—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω—ã–º, –º–µ—Å—Ç–∞–º–∏ –±—ã–ª–æ —Å–∫—É—á–Ω–æ", "—Ä–≤–∞–Ω—ã–º –∏ –Ω–µ–ª–æ–≥–∏—á–Ω—ã–º"] },
        ]},
        { block: '–ò—Ç–æ–≥–æ–≤—ã–µ –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è', questions: [
            { id: 17, text: "–ö–∞–∫–∏–µ —ç–º–æ—Ü–∏–∏ –∏–≥—Ä–∞ –≤—ã–∑—ã–≤–∞–ª–∞ —É –≤–∞—Å —á–∞—â–µ –≤—Å–µ–≥–æ?", answers: ["–≤–æ—Å—Ç–æ—Ä–≥ –∏ —É–¥–∏–≤–ª–µ–Ω–∏–µ", "—Ä–∞–¥–æ—Å—Ç—å –∏ –≤–µ—Å–µ–ª—å–µ", "–∏–Ω—Ç–µ—Ä–µ—Å –∏ –∞–∑–∞—Ä—Ç", "—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ —É–º–∏—Ä–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ", "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏ –¥–∞–∂–µ —Å—Ç—Ä–∞—Ö", "—Å–∫—É–∫—É –∏ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ"] },
            { id: 18, text: "–ß—Ç–æ –≤–∞–º –∑–∞–ø–æ–º–Ω–∏—Ç—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è?", answers: ["—Ñ–∏–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏", "–æ–¥–Ω–∞ –∏–∑ –∏–≥—Ä–æ–≤—ã—Ö –º–µ—Ö–∞–Ω–∏–∫", "–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ –∫—Ä–∞—Å–æ—Ç–∞ –º–∏—Ä–∞", "–ø–æ–±–µ–¥–∞ –Ω–∞–¥ —Å–ª–æ–∂–Ω—ã–º –±–æ—Å—Å–æ–º", "–≤—Ä–µ–º—è, –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–µ —Å –¥—Ä—É–∑—å—è–º–∏", "—Å–æ–∂–∞–ª–µ–Ω–∏–µ –æ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"] },
            { id: 19, text: "–ö–æ–º—É –±—ã –≤—ã –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª–∏ —ç—Ç—É –∏–≥—Ä—É?", answers: ["–∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ–º, —ç—Ç–æ –º–∞—Å—Ç-–ø–ª–µ–π", "–ª—é–±–∏—Ç–µ–ª—è–º –∂–∞–Ω—Ä–∞", "–∏—Å–∫–∞—Ç–µ–ª—è–º –≥–ª—É–±–æ–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏", "–∏–≥—Ä–æ–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è", "—Ö–∞—Ä–¥–∫–æ—Ä–Ω—ã–º –≥–µ–π–º–µ—Ä–∞–º, –∏—â—É—â–∏–º –≤—ã–∑–æ–≤", "–Ω–∏–∫–æ–º—É, –ª—É—á—à–µ –ø—Ä–æ–π—Ç–∏ –º–∏–º–æ"] },
            { id: 20, text: "–ï—Å–ª–∏ –æ–ø–∏—Å–∞—Ç—å –∏–≥—Ä—É –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π, —Ç–æ —ç—Ç–æ...", answers: ["...–Ω–µ–∑–∞–±—ã–≤–∞–µ–º–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ.", "...—É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ –¥–ª—è —É–º–∞.", "...—á–∏—Å—Ç–æ–µ, –Ω–µ–∑–∞–º—É—Ç–Ω–µ–Ω–Ω–æ–µ –≤–µ—Å–µ–ª—å–µ.", "...–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞.", "...–∫—Ä–µ–ø–∫–∏–π —Å–µ—Ä–µ–¥–Ω—è–∫, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ–∏—Ç —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.", "...–ø–æ–ª–Ω–æ–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ."] },
        ]},
    ];
    
    const DeepReviewModal = ({ game, existingAnswers, onClose, onSubmit }) => {
        const [answers, setAnswers] = useState(() => {
            const initial = Array(20).fill(null);
            if (existingAnswers && Array.isArray(existingAnswers) && existingAnswers.length === 20) {
                return existingAnswers;
            }
            return initial;
        });
        const [currentStep, setCurrentStep] = useState(0);

        const handleAnswer = (qIndex, aIndex) => {
            const newAnswers = [...answers];
            newAnswers[qIndex] = aIndex;
            setAnswers(newAnswers);
        };

        const allQuestionsFlat = DEEP_REVIEW_QUESTIONS.flatMap(b => b.questions);
        const currentQuestion = allQuestionsFlat[currentStep];

        const answeredCount = answers.filter(a => a !== null).length;
        const allAnswered = answeredCount === 20;

        return (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-2xl border border-purple-500/30 max-h-[90vh] flex flex-col">
                    <h2 className="text-2xl font-bold text-white mb-2">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ –æ {game.name}</h2>
                    <p className="text-gray-400 mb-4 text-sm">–í–æ–ø—Ä–æ—Å {currentStep + 1} –∏–∑ 20</p>
                    
                    <div className="w-full bg-gray-700 rounded-full h-2.5 mb-6">
                        <div className="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style={{ width: `${((currentStep + 1) / 20) * 100}%` }}></div>
                    </div>

                    <div className="flex-grow overflow-y-auto pr-2">
                        <p className="text-white text-lg mb-4">{currentQuestion.text}</p>
                        <div className="flex flex-col space-y-2">
                            {currentQuestion.answers.map((ans, aIndex) => (
                                <button 
                                    key={aIndex}
                                    onClick={() => handleAnswer(currentStep, aIndex)}
                                    className={`text-left p-3 rounded-lg text-sm transition-colors ${answers[currentStep] === aIndex ? 'bg-purple-500/50 text-white' : 'bg-gray-800 hover:bg-gray-700 text-gray-300'}`}
                                >
                                    {ans}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex justify-between items-center mt-6 pt-4 border-t border-gray-700">
                        <button onClick={() => setCurrentStep(s => s - 1)} disabled={currentStep === 0} className="py-2 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700 disabled:opacity-50 flex items-center gap-2">
                            <Icon name="arrowLeft" className="w-4 h-4" /> –ù–∞–∑–∞–¥
                        </button>
                        
                        {currentStep < 19 ? (
                            <button onClick={() => setCurrentStep(s => s + 1)} disabled={answers[currentStep] === null} className="py-2 px-4 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50 flex items-center gap-2">
                                –î–∞–ª–µ–µ <Icon name="arrowRight" className="w-4 h-4" />
                            </button>
                        ) : (
                            <button onClick={() => onSubmit(game.id, answers)} disabled={!allAnswered} className="py-2 px-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-lg disabled:opacity-50">
                                {allAnswered ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å'}
                            </button>
                        )}
                        
                        <button onClick={onClose} className="py-2 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        );
    };
    
    const generateReviewText = (answers) => {
        if (!answers || answers.length < 20) return null;

        const allQuestions = DEEP_REVIEW_QUESTIONS.flatMap(b => b.questions);
        
        const getAnswer = (qId) => {
            const answerIndex = answers[qId - 1];
            if (answerIndex === null) return { text: '', sentiment: 0 };
            
            const text = allQuestions[qId - 1].answers[answerIndex];
            let sentiment = 0;
            if (answerIndex <= 2) sentiment = 1;
            else if (answerIndex >= 4) sentiment = -1;
            
            return { text, sentiment };
        };

        let paragraphs = [];

        const intro = getAnswer(1);
        const plot = getAnswer(2);
        const chars = getAnswer(3);
        let p1 = `–° —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä–∞ —É–≤–ª–µ–∫–∞–µ—Ç, –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å, —Å–≤–æ–µ–π ${intro.text}. `;
        if (intro.sentiment < 0) {
            p1 = `–í–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –æ—Ç —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã –æ–∫–∞–∑–∞–ª–∏—Å—å —Å–º–∞–∑–∞–Ω–Ω—ã–º–∏: –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å ${intro.text}. `;
        }
        
        if (plot.sentiment > 0) {
            p1 += `–°—é–∂–µ—Ç –º–æ–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å –∫–∞–∫ ${plot.text}.`;
        } else {
            p1 += `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∏—Å—Ç–æ—Ä–∏—è –æ–∫–∞–∑–∞–ª–∞—Å—å ${plot.text}.`;
        }

        if (chars.text === "—Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π/–≥–µ—Ä–æ–∏–Ω—è –±—ã–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏") {
             p1 += ` –ß—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Ç–æ –≤—ã–¥–µ–ª–∏—Ç—å –º–æ–∂–Ω–æ –±—ã–ª–æ –ª–∏—à—å –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è.`;
        } else {
             p1 += ` –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –æ—â—É—â–∞–ª–∏—Å—å –∫–∞–∫ ${chars.text}.`;
        }
        paragraphs.push(p1);

        const gameplay = getAnswer(5);
        const mechanics = getAnswer(6);
        const controls = getAnswer(7);
        let p2 = `–í –æ—Å–Ω–æ–≤–µ —Å–≤–æ–µ–π –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å ${gameplay.text}. `;
        
        if (mechanics.sentiment > 0) {
            p2 += `–ü—Ä–∏—è—Ç–Ω–æ —É–¥–∏–≤–∏–ª–æ —Ç–æ, —á—Ç–æ –∏–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ ${mechanics.text}. `;
        } else if (mechanics.sentiment < 0) {
            p2 += `–û–¥–Ω–∞–∫–æ, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –æ–Ω –Ω–µ –±–ª–µ—â–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –º–µ—Ö–∞–Ω–∏–∫–∏ ${mechanics.text}. `;
        }
        
        if (controls.sentiment < 0) {
            p2 += `–ù–µ–∫–æ—Ç–æ—Ä—ã–º –º–∏–Ω—É—Å–æ–º —Å—Ç–∞–ª–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ ${controls.text}.`;
        }
        paragraphs.push(p2);
        
        const visual = getAnswer(10);
        const sound = getAnswer(11);
        const tech = getAnswer(13);
        let p3 = `–í–∏–∑—É–∞–ª—å–Ω–æ –∏–≥—Ä–∞ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ ${visual.text}. `;

        if (sound.sentiment > 0) {
            p3 += `–≠—Ç–æ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω—è–µ—Ç ${sound.text} —Å–∞—É–Ω–¥-–¥–∏–∑–∞–π–Ω. `;
        } else {
            p3 += `–ü—Ä–∏ —ç—Ç–æ–º –∑–≤—É–∫ –≤ –∏–≥—Ä–µ –±—ã–ª ${sound.text}. `;
        }
        
        if (tech.sentiment < 1) {
            p3 += `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –Ω–µ–∏–¥–µ–∞–ª—å–Ω–∞: ${tech.text}.`;
        }
        paragraphs.push(p3);

        const difficulty = getAnswer(14);
        const recommendation = getAnswer(19);
        const summary = getAnswer(20);
        let p4 = `–ü–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç ${difficulty.text}. `;
        
        if (recommendation.sentiment > 0) {
            p4 += `–Ø –±—ã –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞–ª —ç—Ç—É –∏–≥—Ä—É ${recommendation.text}. `;
        } else {
            p4 += `–°–æ–≤–µ—Ç–æ–≤–∞—Ç—å —ç—Ç—É –∏–≥—Ä—É —è –±—ã –Ω–µ —Å—Ç–∞–ª, —Ä–∞–∑–≤–µ —á—Ç–æ ${recommendation.text}. `;
        }
        p4 += `–ü–æ–¥–≤–æ–¥—è –∏—Ç–æ–≥, –¥–ª—è –º–µ–Ω—è —ç—Ç–æ ${summary.text}`;
        paragraphs.push(p4);

        return paragraphs.join('\n\n');
    };
    
    const DisplayDeepReview = ({ answers }) => {
        const [isExpanded, setIsExpanded] = useState(false);
        const reviewText = generateReviewText(answers);
        if (!reviewText) return null;

        const snippet = reviewText.substring(0, 200);

        return (
            <div className="mt-4 pt-4 border-t border-gray-700">
                <h4 className="text-lg font-semibold text-purple-300 mb-2">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤</h4>
                <p className="text-gray-300 whitespace-pre-wrap">
                    {isExpanded ? reviewText : `${snippet}...`}
                </p>
                {reviewText.length > 200 && (
                    <button onClick={() => setIsExpanded(!isExpanded)} className="text-purple-400 hover:text-purple-300 mt-2">
                        {isExpanded ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é'}
                    </button>
                )}
            </div>
        );
    };

    ReactDOM.render(<GameKanban />, document.getElementById('root'));
  </script>
  
  <script src="game.js"></script>
</body>
</html>
