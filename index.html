<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Omnilogue - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–≥—Ä –∏ —Ñ–∏–ª—å–º–æ–≤</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Omnilogue - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–≥—Ä, —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤. –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π, –¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏ –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.">
  <meta name="keywords" content="–∏–≥—Ä—ã, —Ñ–∏–ª—å–º—ã, —Å–µ—Ä–∏–∞–ª—ã, —Ç—Ä–µ–∫–µ—Ä, –∫–æ–ª–ª–µ–∫—Ü–∏—è, –¥—Ä—É–∑—å—è, —Ä–µ–π—Ç–∏–Ω–≥–∏, –æ—Ç–∑—ã–≤—ã">
  <meta name="author" content="Omnilogue">
  <meta name="robots" content="index, follow">
  
  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: http:; connect-src 'self' https://gametracker-backend-production.up.railway.app https://api.themoviedb.org https://id.twitch.tv https://unpkg.com; frame-src 'none'; object-src 'none'; base-uri 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Omnilogue - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–≥—Ä –∏ —Ñ–∏–ª—å–º–æ–≤">
  <meta property="og:description" content="–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–≥—Ä, —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤. –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π, –¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://gametracker-backend-production.up.railway.app">
  <meta property="og:image" content="https://gametracker-backend-production.up.railway.app/favicon.ico">
  <meta property="og:site_name" content="Omnilogue">
  <meta property="og:locale" content="ru_RU">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Omnilogue - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–≥—Ä –∏ —Ñ–∏–ª—å–º–æ–≤">
  <meta name="twitter:description" content="–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–≥—Ä, —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤.">
  <meta name="twitter:image" content="https://gametracker-backend-production.up.railway.app/favicon.ico">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
    .avatar-circle { border-radius: 50%; object-fit: cover; }
    .dragging { opacity: 0.5; border: 2px dashed #8b5cf6; transform: rotate(2deg); }
    .drag-over-column { background-color: rgba(139, 92, 246, 0.1); }
    .drag-over-card { transform: scale(1.05); }
    
    /* Line clamp utilities */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* Elevation system */
    .elevation-0 { box-shadow: none; }
    .elevation-1 { box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
    .elevation-2 { box-shadow: 0 4px 6px rgba(0,0,0,0.16); }
    .elevation-3 { box-shadow: 0 10px 20px rgba(0,0,0,0.24); }
    .elevation-4 { box-shadow: 0 15px 30px rgba(0,0,0,0.32); }
    
    /* Shadow transitions */
    .shadow-transition { transition: box-shadow 200ms ease; }
    
    /* Drag & Drop optimizations */
    .dragging-card {
      opacity: 0.8;
      transform: rotate(2deg) scale(1.05);
      z-index: 1000;
      pointer-events: none;
      transition: all 200ms ease;
    }
    
    .drag-ghost {
      opacity: 0.3;
      transform: scale(0.95);
      transition: none;
    }
    
    .drag-over-column {
      background-color: rgba(139, 92, 246, 0.1);
      transform: scale(1.02);
      transition: all 200ms ease;
    }
    
    /* Prevent layout shifts during drag */
    .board-column {
      min-height: 200px;
      transition: all 200ms ease;
    }
    
    .game-card {
      will-change: transform, opacity;
      backface-visibility: hidden;
      transform-style: preserve-3d;
    }
    
    /* Tooltip styles */
    .tooltip {
      position: absolute;
      z-index: 1000;
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      max-width: 300px;
      pointer-events: none;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.2s ease;
    }
    
    .tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .tooltip::after {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid rgba(139, 92, 246, 0.3);
    }

    .cropper-container {
        max-width: 100%;
    }
    .img-container {
        max-height: 50vh;
        margin-bottom: 1rem;
    }
    .img-container > img {
        max-width: 100%;
    }
    
    /* Modal Transitions */
    .modal-enter {
        opacity: 0;
        transform: scale(0.9);
    }
    .modal-enter-active {
        opacity: 1;
        transform: scale(1);
        transition: opacity 200ms ease-out, transform 200ms ease-out;
    }
    .modal-exit {
        opacity: 1;
        transform: scale(1);
    }
    .modal-exit-active {
        opacity: 0;
        transform: scale(0.9);
        transition: opacity 200ms ease-in, transform 200ms ease-in;
    }
    
    /* Toast Notifications */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 300ms ease-out;
    }
    .toast.show {
        transform: translateX(0);
    }
    .toast.success {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    .toast.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    .toast.info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }
    
    /* Loading Button States */
    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.7;
    }
    .btn-loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .mobile-fullscreen-modal {
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        max-height: 100% !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      .accordion-column {
        border-bottom: 1px solid rgba(139, 92, 246, 0.3);
      }
      
      .accordion-column.collapsed .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      
      .accordion-column.expanded .accordion-content {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
      }
      
      .accordion-header {
        cursor: pointer;
        user-select: none;
      }
    }
    
    /* Swipe gesture styles */
      .swipe-indicator {
        width: 40px;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        margin: 8px auto;
      }

      @keyframes bounce {
        0%, 20%, 53%, 80%, 100% {
          transform: translate3d(0, 0, 0);
        }
        40%, 43% {
          transform: translate3d(0, -10px, 0);
        }
        70% {
          transform: translate3d(0, -5px, 0);
        }
        90% {
          transform: translate3d(0, -2px, 0);
        }
      }

      .animate-bounce {
        animation: bounce 0.6s ease-in-out;
      }

      .reaction-highlight {
        position: relative;
        overflow: hidden;
      }

      .reaction-highlight::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
        animation: shimmer 1.5s ease-in-out;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }
    
    /* Liquid Eye Theme */
    .liquid-eye {
        --bg-color: #000000;
        --text-color: #ffffff;
        --primary-color: #ffffff;
        --secondary-color: #a0a0a0;
        --border-color: #444444;
        --card-bg: #101010;
        --header-bg: rgba(0, 0, 0, 0.7);
        --modal-bg: #111111;
        --button-bg: #ffffff;
        --button-text: #000000;
        --button-hover-bg: #e0e0e0;
        --input-bg: #222222;
    }
    
    .liquid-eye .bg-gradient-to-br, .liquid-eye .bg-gradient-to-r { background: var(--bg-color); }
    .liquid-eye body, .liquid-eye #root { background-color: var(--bg-color); color: var(--text-color); }
    .liquid-eye header { background-color: var(--header-bg) !important; border-bottom-color: var(--border-color) !important; }
    .liquid-eye .text-transparent { color: var(--text-color) !important; }
    .liquid-eye .bg-clip-text { -webkit-background-clip: unset !important; background-clip: unset !important; background: none !important; }
    .liquid-eye .border-purple-500\/30, .liquid-eye .border-blue-500\/30, .liquid-eye .border-green-500\/30, .liquid-eye .border-red-500\/30, .liquid-eye .border-orange-500\/30 { border-color: var(--border-color) !important; }
    .liquid-eye .bg-gray-900\/90, .liquid-eye .bg-gray-900, .liquid-eye .bg-gray-800, .liquid-eye .bg-gray-800\/90 { background-color: var(--card-bg) !important; }
    .liquid-eye .bg-gray-800\/95 { background-color: var(--modal-bg) !important; }
    .liquid-eye .from-purple-500\/20, .liquid-eye .to-pink-500\/20, .liquid-eye .from-blue-500\/20, .liquid-eye .from-green-500\/20, .liquid-eye .from-red-500\/20 { background: var(--card-bg) !important; }
    .liquid-eye input, .liquid-eye textarea, .liquid-eye select { background-color: var(--input-bg) !important; border-color: var(--border-color) !important; color: var(--text-color) !important; }
    .liquid-eye .text-purple-400, .liquid-eye .text-red-400, .liquid-eye .text-blue-400, .liquid-eye .text-green-400 { color: var(--primary-color) !important; }
    .liquid-eye .text-gray-300, .liquid-eye .text-gray-400 { color: var(--secondary-color) !important; }
    .liquid-eye button.bg-gradient-to-r { background: var(--button-bg) !important; color: var(--button-text) !important; }
    .liquid-eye button.bg-gradient-to-r:hover { background: var(--button-hover-bg) !important; }
    .liquid-eye .hover\:border-purple-500:hover { border-color: var(--primary-color) !important; }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ò–ì–†–´ */
    #game-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        text-align: center;
        font-family: 'Inter', sans-serif;
    }
    #game-overlay h2 {
        font-size: 1.5em; 
        margin-bottom: 0.5em;
        text-shadow: 0 0 10px #8b5cf6;
    }
    #game-overlay p {
        font-size: 1em;
        margin: 0.2em 0;
    }
    #game-overlay button {
        margin-top: 1.5em;
        padding: 8px 18px; 
        font-size: 0.75em;
        font-weight: bold;
        color: #000;
        background: #ffffff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #game-overlay button:hover {
        background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, Fragment, useCallback } = React;
    
    // –û–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API URL –¥–ª—è –±–∞–∑–æ–≤–æ–π –∑–∞—â–∏—Ç—ã
    const getApiUrl = () => {
      const encoded = 'aHR0cHM6Ly9nYW1ldHJhY2tlci1iYWNrZW5kLXByb2R1Y3Rpb24udXAucmFpbHdheS5hcHA=';
      return atob(encoded);
    };
    const API_URL = getApiUrl();
    const REACTION_EMOJIS = ['üòç', 'üî•', 'üëç', 'üòÆ', 'üòÇ', 'üëé', '‚ù§Ô∏è', 'ü§î', 'üò¢', 'ü§Ø', 'üò¥', 'üíØ', 'üíÄ', 'ü§®', 'ü•≥'];
    const GAMES_PER_COLUMN = 5;

    // –§—É–Ω–∫—Ü–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Ä–µ–∞–∫—Ü–∏–π
    const groupReactions = (reactions) => {
      if (!reactions || reactions.length === 0) return {};
      return reactions.reduce((acc, r) => {
        if (!acc[r.emoji]) {
          acc[r.emoji] = { count: 0, users: [] };
        }
        acc[r.emoji].count++;
        acc[r.emoji].users.push(r.username || r.user?.username || '–ê–Ω–æ–Ω–∏–º');
        return acc;
      }, {});
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π
    const ReactionGroup = ({ emoji, count, users, onReactionClick }) => {
      const [isAnimating, setIsAnimating] = useState(false);
      const [showShimmer, setShowShimmer] = useState(false);
      
      const handleClick = () => {
        if (onReactionClick) {
          setIsAnimating(true);
          setShowShimmer(true);
          setTimeout(() => {
            setIsAnimating(false);
            setShowShimmer(false);
          }, 600);
          onReactionClick(emoji);
        }
      };

      return (
        <div className="relative group">
          <button
            onClick={handleClick}
            className={`relative inline-flex items-center gap-1 px-2 py-1 rounded-full transition-all duration-200 hover:scale-105 bg-gray-700/50 hover:bg-gray-600/50 border border-gray-600/30 ${isAnimating ? 'animate-bounce scale-110' : ''} ${showShimmer ? 'reaction-highlight' : ''}`}
            title={`${users.join(', ')}`}
          >
            <span className="text-base">{emoji}</span>
            {count > 1 && (
              <span className="text-xs text-gray-300 font-medium">{count}</span>
            )}
          </button>
          
          {/* Tooltip —Å –∏–º–µ–Ω–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */}
          <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 rounded-lg text-sm text-white whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 shadow-lg">
            {users.join(', ')}
            <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
          </div>
        </div>
      );
    };

    const Icon = ({ name, className = "w-5 h-5" }) => {
      const icons = {
        plus: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>,
        arrowLeft: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>,
        arrowRight: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>,
        youtube: <svg className={className} fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>,
        bell: <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>,
        search: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>,
        user: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
        users: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
        settings: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
        logout: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>,
        star: <svg className={className} fill="currentColor" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
        trash: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
        tag: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
        x: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        loader: <svg className={className + " animate-spin"} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>,
        upload: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>,
        globe: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 1.53 0 0 1-4 10 15.3 1.53 0 0 1-4-10 15.3 1.53 0 0 1 4-10z"/></svg>,
        edit: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
        userPlus: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
        userCheck: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>,
        userClock: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><circle cx="18" cy="18" r="3" /><path d="M20.5 16.5 18 18l.5 2.5"/></svg>,
        check: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
        chevronUp: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M5 15l7-7 7 7" /></svg>,
        clock: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        shield: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
        activity: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
        info: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
        chevronDown: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" /></svg>,
        menu: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>,
        moreVertical: <svg className={className} fill="currentColor" viewBox="0 0 16 16"><circle cx="8" cy="3" r="1.5"/><circle cx="8" cy="8" r="1.5"/><circle cx="8" cy="13" r="1.5"/></svg>,
        barChart: <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 3v18h18M8 16l4-4 4 4 4-8"/></svg>,
      };
      return icons[name] || null;
    };

    // Hook –¥–ª—è swipe –∂–µ—Å—Ç–∞
    const useSwipeToClose = (onClose) => {
      const [touchStart, setTouchStart] = useState(0);
      const [touchOffset, setTouchOffset] = useState(0);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

      useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      const handleTouchStart = (e) => {
        if (!isMobile) return;
        setTouchStart(e.touches[0].clientY);
      };

      const handleTouchMove = (e) => {
        if (!isMobile) return;
        const currentTouch = e.touches[0].clientY;
        const offset = currentTouch - touchStart;
        if (offset > 0) {
          setTouchOffset(offset);
        }
      };

      const handleTouchEnd = () => {
        if (!isMobile) return;
        if (touchOffset > 100) {
          onClose();
        }
        setTouchOffset(0);
      };

      return { touchOffset, isMobile, handleTouchStart, handleTouchMove, handleTouchEnd };
    };

    // Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const Toast = ({ message, type = 'info', isVisible, onClose }) => {
      useEffect(() => {
        if (isVisible) {
          const timer = setTimeout(() => {
            onClose();
          }, 3000);
          return () => clearTimeout(timer);
        }
      }, [isVisible, onClose]);

      if (!isVisible) return null;

      return (
        <div className={`toast ${type} ${isVisible ? 'show' : ''}`}>
          <div className="flex items-center gap-2">
            {type === 'success' && <Icon name="check" className="w-4 h-4" />}
            {type === 'error' && <Icon name="x" className="w-4 h-4" />}
            {type === 'info' && <Icon name="info" className="w-4 h-4" />}
            <span>{message}</span>
          </div>
        </div>
      );
    };

    const Avatar = ({ src, size = 'md', className = '' }) => {
      const sizes = { sm: 'w-8 h-8', md: 'w-12 h-12', lg: 'w-20 h-20', xl: 'w-32 h-32' };
      return src ? (
        <img src={src} className={`${sizes[size]} avatar-circle ${className}`} alt="avatar" />
      ) : (
        <div className={`${sizes[size]} avatar-circle bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold ${className}`}>
          <Icon name="user" className={size === 'sm' ? 'w-4 h-4' : 'w-6 h-6'} />
        </div>
      );
    };
    
    const AvatarCropModal = ({ src, onCancel, onComplete }) => {
        const imageRef = useRef(null);
        const [cropper, setCropper] = useState(null);

        useEffect(() => {
            if (imageRef.current) {
                const instance = new Cropper(imageRef.current, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    background: false,
                    autoCropArea: 0.8,
                });
                setCropper(instance);
            }
            return () => {
                if (cropper) {
                    cropper.destroy();
                }
            };
        }, [imageRef]);

        const handleCrop = () => {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({
                    width: 128,
                    height: 128,
                    imageSmoothingQuality: 'high',
                });
                onComplete(canvas.toDataURL('image/jpeg', 0.9));
            }
        };

        return (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-lg border border-purple-500/30">
                    <h2 className="text-2xl font-bold text-white mb-4">–û–±—Ä–µ–∑–∞—Ç—å –∞–≤–∞—Ç–∞—Ä</h2>
                    <div className="img-container">
                        <img ref={imageRef} src={src} alt="Source" />
                    </div>
                    <div className="flex gap-2 mt-6">
                        <button onClick={handleCrop} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg hover:from-purple-600 hover:to-pink-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button onClick={onCancel} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        );
    };

    const ActivityFeed = ({ token, boardType = 'games', onNavigateToUser }) => {
        const [activities, setActivities] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const fetchActivities = async () => {
                if (!token) return;
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/api/friends/activity?type=${boardType}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setActivities(data.activities);
                    }
                } catch (err) {
                    console.error("Failed to fetch activities", err);
                } finally {
                    setLoading(false);
                }
            };
            fetchActivities();
            const interval = setInterval(fetchActivities, 60000);
            return () => clearInterval(interval);
        }, [token, boardType]);
        
        const boardTitles = {
            backlog: '–ë–µ–∫–ª–æ–≥',
            playing: '–ò–≥—Ä–∞—é',
            completed: '–ü—Ä–æ—à—ë–ª',
            dropped: '–ë—Ä–æ—Å–∏–ª'
        };

        const formatActivity = (act) => {
            const { username, action_type, details, user_id } = act;
            const gameName = <span className="font-bold text-purple-300">{details.gameName}</span>;
            const clickableUsername = (
                <button 
                    onClick={() => onNavigateToUser && onNavigateToUser(user_id)}
                    className="text-blue-400 hover:text-blue-300 underline cursor-pointer font-semibold"
                >
                    {username}
                </button>
            );
            
            switch (action_type) {
                case 'add_game':
                    return <>{clickableUsername} –¥–æ–±–∞–≤–∏–ª {gameName} –≤ <span className="italic">{boardTitles[details.board]}</span></>;
                case 'move_game':
                    return <>{clickableUsername} –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª {gameName} –∏–∑ <span className="italic">{boardTitles[details.fromBoard]}</span> –≤ <span className="italic">{boardTitles[details.toBoard]}</span></>;
                case 'remove_game':
                     return <>{clickableUsername} —É–¥–∞–ª–∏–ª {gameName}</>;
                case 'complete_game':
                    return <><span className="text-green-400 font-semibold">{clickableUsername}</span> –ø—Ä–æ—à–µ–ª –∏–≥—Ä—É {gameName}! üéâ</>;
                case 'add_review':
                    return <>{clickableUsername} –æ—Å—Ç–∞–≤–∏–ª –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ –Ω–∞ {gameName} üìù</>;
                default:
                    return <>{clickableUsername} {action_type}</>;
            }
        };
        
        return (
            <div className="mt-8 md:mt-12">
                {loading ? (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-10 flex items-center justify-center">
                        <Icon name="loader" className="w-8 h-8 text-purple-400"/>
                    </div>
                ) : activities.length > 0 ? (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {activities.map(act => (
                                <div key={act.id} className="text-sm text-gray-300 p-4 bg-gray-800/80 rounded-lg border border-gray-700 hover:border-purple-500/50 transition-colors">
                                    <p>{formatActivity(act)}</p>
                                    <div className="text-xs text-gray-500 mt-2 text-right">{new Date(act.created_at).toLocaleString('ru-RU')}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                ) : (
                    <div className="w-full bg-gray-900/50 backdrop-blur-xl rounded-xl border border-purple-500/30 p-10 flex items-center justify-center text-gray-400 text-center">
                        –ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–∏—Ö –¥—Ä—É–∑–µ–π.
                    </div>
                )}
            </div>
        );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∫–µ–ª–µ—Ç–æ–Ω–æ–≤
    const CardSkeleton = () => (
      <div className="bg-gray-700 rounded-lg p-3 animate-pulse">
        <div className="flex items-start gap-3">
          <div className="w-12 h-16 bg-gray-600 rounded-lg flex-shrink-0"></div>
          <div className="flex-1 min-w-0">
            <div className="h-4 bg-gray-600 rounded mb-2"></div>
            <div className="h-3 bg-gray-600 rounded w-3/4 mb-1"></div>
            <div className="h-3 bg-gray-600 rounded w-1/2"></div>
          </div>
        </div>
      </div>
    );

    const ColumnSkeleton = () => (
      <div className="bg-gradient-to-br from-gray-600/20 to-gray-700/20 backdrop-blur-xl rounded-xl p-4 border border-gray-600/30 flex flex-col">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <div className="w-6 h-6 bg-gray-600 rounded animate-pulse"></div>
            <div className="h-5 bg-gray-600 rounded w-20 animate-pulse"></div>
          </div>
          <div className="w-8 h-6 bg-gray-600 rounded-full animate-pulse"></div>
        </div>
        <div className="space-y-2 flex-grow min-h-[100px]">
          {[1, 2, 3, 4].map(i => <CardSkeleton key={i} />)}
        </div>
      </div>
    );

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    let updateNotificationsCallback = null;
    const setUpdateNotificationsCallback = (callback) => {
      updateNotificationsCallback = callback;
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const NotificationsPanel = ({ token, onNavigateToUser, onNavigateToGame }) => {
      const [notifications, setNotifications] = useState([]);
      const [unreadCount, setUnreadCount] = useState(0);
      const [showPanel, setShowPanel] = useState(false);
      const [loading, setLoading] = useState(false);

      // –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      const fetchNotifications = useCallback(async () => {
        if (!token) return;
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/notifications`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setNotifications(data.notifications || []);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
        } finally {
          setLoading(false);
        }
      }, [token]);

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
      const fetchUnreadCount = useCallback(async () => {
        if (!token) return;
        try {
          const response = await fetch(`${API_URL}/api/notifications/unread-count`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setUnreadCount(data.count || 0);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç—á–∏–∫–∞:', error);
        }
      }, [token]);

      // –û—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
      const markAsRead = async (notificationId) => {
        try {
          const response = await fetch(`${API_URL}/api/notifications/${notificationId}/read`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            setNotifications(prev => 
              prev.map(n => n.id === notificationId ? { ...n, is_read: true } : n)
            );
            setUnreadCount(prev => Math.max(0, prev - 1));
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
        }
      };

      // –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
      const markAllAsRead = async () => {
        try {
          const response = await fetch(`${API_URL}/api/notifications/mark-all-read`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            setNotifications(prev => 
              prev.map(n => ({ ...n, is_read: true }))
            );
            setUnreadCount(0);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
        }
      };

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é
      const handleNotificationClick = (notification) => {
        // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
        if (!notification.is_read) {
          markAsRead(notification.id);
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        switch (notification.type) {
          case 'friend_request':
          case 'friend_accepted':
            if (onNavigateToUser && notification.from_user_id) {
              onNavigateToUser(notification.from_user_id);
            }
            break;
          case 'game_completed':
          case 'review_added':
            if (onNavigateToGame && notification.reference_id) {
              onNavigateToGame(notification.reference_id);
            }
            break;
          default:
            break;
        }
      };

      // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
      useEffect(() => {
        fetchNotifications();
        fetchUnreadCount();
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        setUpdateNotificationsCallback(() => {
          fetchUnreadCount();
        });
        
        return () => {
          setUpdateNotificationsCallback(null);
        };
      }, [fetchNotifications, fetchUnreadCount]);

      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
      useEffect(() => {
        const interval = setInterval(fetchUnreadCount, 30000);
        return () => clearInterval(interval);
      }, [fetchUnreadCount]);

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
      const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}–º –Ω–∞–∑–∞–¥`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}—á –Ω–∞–∑–∞–¥`;
        return date.toLocaleDateString('ru-RU');
      };

      return (
        <div className="relative">
          {/* –ö–Ω–æ–ø–∫–∞ —Å –∏–∫–æ–Ω–∫–æ–π –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞ */}
          <button
            onClick={() => setShowPanel(!showPanel)}
            className="p-2 hover:bg-gray-800 rounded-lg border border-purple-500/30 relative"
            title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
          >
            <Icon name="bell" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" />
            {unreadCount > 0 && (
              <span className="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white"></span>
            )}
          </button>

          {/* –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é */}
          {showPanel && (
            <div className="absolute right-0 top-full mt-2 w-80 bg-gray-800 rounded-lg border border-gray-700 z-50 elevation-4">
              <div className="p-4 border-b border-gray-700">
                <div className="flex items-center justify-between">
                  <h3 className="text-lg font-semibold text-white">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                  <button
                    onClick={() => setShowPanel(false)}
                    className="text-gray-400 hover:text-white"
                  >
                    <Icon name="x" className="w-5 h-5" />
                  </button>
                </div>
              </div>

              <div className="max-h-96 overflow-y-auto">
                {loading ? (
                  <div className="p-4 text-center text-gray-400">
                    <Icon name="loader" className="w-6 h-6 animate-spin mx-auto mb-2" />
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                  </div>
                ) : notifications.length === 0 ? (
                  <div className="p-4 text-center text-gray-400">
                    <Icon name="bell" className="w-8 h-8 mx-auto mb-2 opacity-50" />
                    <p>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                  </div>
                ) : (
                  notifications.map(notification => (
                    <div
                      key={notification.id}
                      onClick={() => handleNotificationClick(notification)}
                      className={`p-4 border-b border-gray-700 hover:bg-gray-700/50 transition-colors cursor-pointer ${
                        !notification.is_read ? 'bg-red-500/10 border-l-4 border-l-red-500' : 'bg-gray-500/5'
                      }`}
                    >
                      <div className="flex items-start gap-3">
                        <img
                          src={notification.from_user_avatar || '/default-avatar.png'}
                          alt=""
                          className="w-8 h-8 rounded-full object-cover"
                          onError={(e) => { e.target.src = '/default-avatar.png'; }}
                        />
                        <div className="flex-1 min-w-0">
                          <p className={`text-sm ${!notification.is_read ? 'text-white font-medium' : 'text-gray-300'}`}>
                            {notification.message}
                          </p>
                          <p className="text-gray-400 text-xs mt-1">{formatTime(notification.created_at)}</p>
                          {!notification.is_read && (
                            <div className="flex items-center gap-2 mt-2">
                              <span className="w-2 h-2 bg-red-500 rounded-full"></span>
                              <span className="text-red-400 text-xs font-medium">–ù–æ–≤–æ–µ</span>
                            </div>
                          )}
                        </div>
                        {!notification.is_read && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              markAsRead(notification.id);
                            }}
                            className="text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded bg-blue-500/20 hover:bg-blue-500/30 transition-colors"
                          >
                            ‚úì
                          </button>
                        )}
                      </div>
                    </div>
                  ))
                )}
              </div>
              
              {/* –§—É—Ç–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ" */}
              {notifications.length > 0 && (
                <div className="p-4 border-t border-gray-700 bg-gray-800/50">
                  <button
                    onClick={markAllAsRead}
                    className="w-full py-2 px-4 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 hover:text-blue-300 rounded-lg transition-colors text-sm font-medium flex items-center justify-center gap-2"
                  >
                    <Icon name="check" className="w-4 h-4" />
                    –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                  </button>
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    const StatisticsPage = ({ isOpen, onClose, token, showMediaTab = true }) => {
      const [activeTab, setActiveTab] = useState('games');
      const [gamesStats, setGamesStats] = useState(null);
      const [mediaStats, setMediaStats] = useState(null);
      const [loading, setLoading] = useState(false);
      const [exportLoading, setExportLoading] = useState(false);
      const [exportMessage, setExportMessage] = useState('');

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä
      const loadGamesStats = useCallback(async () => {
        if (!token) return;
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/user/statistics/games`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            console.log('Games statistics received:', data);
            setGamesStats(data);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä:', error);
        } finally {
          setLoading(false);
        }
      }, [token]);

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–¥–∏–∞
      const loadMediaStats = useCallback(async () => {
        if (!token) return;
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/user/statistics/media`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setMediaStats(data);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–¥–∏–∞:', error);
        } finally {
          setLoading(false);
        }
      }, [token]);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      useEffect(() => {
        if (isOpen) {
          if (activeTab === 'games') {
            loadGamesStats();
          } else if (showMediaTab) {
            loadMediaStats();
          }
        }
      }, [isOpen, activeTab, showMediaTab, loadGamesStats, loadMediaStats]);

      // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
      const handleExport = async (format) => {
        if (!token) return;
        
        setExportLoading(true);
        setExportMessage('');
        
        try {
          const type = activeTab; // 'games' –∏–ª–∏ 'media'
          const response = await fetch(`${API_URL}/api/export/${type}?format=${format}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gametracker_${type}_${new Date().toISOString().split('T')[0]}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            setExportMessage(`‚úÖ –§–∞–π–ª ${type}_${new Date().toISOString().split('T')[0]}.${format} —Å–∫–∞—á–∞–Ω`);
            setTimeout(() => setExportMessage(''), 3000);
          } else {
            setExportMessage('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö');
            setTimeout(() => setExportMessage(''), 3000);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
          setExportMessage('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö');
          setTimeout(() => setExportMessage(''), 3000);
        } finally {
          setExportLoading(false);
        }
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-gray-900 rounded-xl w-full max-w-4xl max-h-[70vh] flex flex-col">
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-gray-700 pt-8">
              <div>
                <h2 className="text-2xl font-bold text-white">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                {exportMessage && (
                  <p className="text-sm text-green-400 mt-1">{exportMessage}</p>
                )}
              </div>
              <div className="flex items-center gap-4">
                <ExportDropdown 
                  onExport={handleExport} 
                  loading={exportLoading} 
                />
                <button
                  onClick={onClose}
                  className="p-2 hover:bg-gray-800 rounded-lg transition-colors"
                >
                  <Icon name="x" className="w-6 h-6 text-gray-400" />
                </button>
              </div>
            </div>

            {/* Tabs */}
            {showMediaTab && (
              <div className="flex border-b border-gray-700">
                <button
                  onClick={() => setActiveTab('games')}
                  className={`px-6 py-4 font-medium transition-colors ${
                    activeTab === 'games'
                      ? 'text-purple-400 border-b-2 border-purple-400 bg-purple-500/10'
                      : 'text-gray-400 hover:text-white'
                  }`}
                >
                  üéÆ –ò–≥—Ä—ã
                </button>
                <button
                  onClick={() => setActiveTab('media')}
                  className={`px-6 py-4 font-medium transition-colors ${
                    activeTab === 'media'
                      ? 'text-purple-400 border-b-2 border-purple-400 bg-purple-500/10'
                      : 'text-gray-400 hover:text-white'
                  }`}
                >
                  üé¨ –§–∏–ª—å–º—ã/–°–µ—Ä–∏–∞–ª—ã
                </button>
              </div>
            )}

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              {loading ? (
                <div className="flex items-center justify-center h-64">
                  <Icon name="loader" className="w-8 h-8 animate-spin text-purple-400" />
                </div>
              ) : !showMediaTab || activeTab === 'games' ? (
                <GamesStatsContent stats={gamesStats} />
              ) : (
                <MediaStatsContent stats={mediaStats} />
              )}
            </div>
          </div>
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä
    const GamesStatsContent = ({ stats }) => {
      const [tooltipData, setTooltipData] = useState(null);
      const [tooltipVisible, setTooltipVisible] = useState(false);
      const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });

      if (!stats) return <div className="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
      const chartData = stats.monthlyStats?.map(month => ({
        month: month.month,
        added: month.added || 0,
        completed: month.completed || 0
      })) || [];

      const handleChartHover = (data, index) => {
        if (data) {
          setTooltipData(data);
          setTooltipVisible(true);
        } else {
          setTooltipVisible(false);
        }
      };

      const handleMouseMove = (e) => {
        setTooltipPosition({ x: e.clientX, y: e.clientY });
      };

      return (
        <div className="space-y-6">
          {/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å —á–∏—Å–ª–∞–º–∏ */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 backdrop-blur-xl rounded-xl p-6 border border-blue-500/30">
              <div className="text-3xl mb-2">üìä</div>
              <h3 className="text-sm font-semibold text-gray-300 mb-1">–í—Å–µ–≥–æ –∏–≥—Ä</h3>
              <p className="text-3xl font-bold text-white">{stats.summary?.totalGames || 0}</p>
            </div>
            <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-xl rounded-xl p-6 border border-green-500/30">
              <div className="text-3xl mb-2">‚úÖ</div>
              <h3 className="text-sm font-semibold text-gray-300 mb-1">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</h3>
              <p className="text-3xl font-bold text-white">{stats.summary?.completedGames || 0}</p>
            </div>
            <div className="bg-gradient-to-br from-yellow-500/20 to-orange-500/20 backdrop-blur-xl rounded-xl p-6 border border-yellow-500/30">
              <div className="text-3xl mb-2">üìã</div>
              <h3 className="text-sm font-semibold text-gray-300 mb-1">–í –±–µ–∫–ª–æ–≥–µ</h3>
              <p className="text-3xl font-bold text-white">{stats.general?.backlog?.count || 0}</p>
            </div>
            <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-xl rounded-xl p-6 border border-purple-500/30">
              <div className="text-3xl mb-2">üéÆ</div>
              <h3 className="text-sm font-semibold text-gray-300 mb-1">–ò–≥—Ä–∞—é —Å–µ–π—á–∞—Å</h3>
              <p className="text-3xl font-bold text-white">{stats.general?.playing?.count || 0}</p>
            </div>
          </div>

          {/* –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–µ—Å—è—Ü–∞–º */}
          <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
            <h3 className="text-lg font-semibold text-white mb-4">üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
            <div className="relative" onMouseMove={handleMouseMove}>
              {chartData.length > 0 ? (
                <>
                  <BarChart 
                    data={chartData} 
                    height={300} 
                    onHover={handleChartHover}
                  />
                  <ChartLegend />
                  <ChartTooltip 
                    data={tooltipData} 
                    visible={tooltipVisible} 
                    x={tooltipPosition.x} 
                    y={tooltipPosition.y} 
                  />
                </>
              ) : (
                <div className="h-64 flex items-center justify-center text-gray-400">
                  <div className="text-center">
                    <div className="text-4xl mb-2">üìä</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* –¢–æ–ø-10 –∏–≥—Ä */}
          <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
            <h3 className="text-lg font-semibold text-white mb-4">üèÜ –¢–æ–ø-10 –∏–≥—Ä</h3>
            <div className="space-y-3">
              {stats.topGames && stats.topGames.length > 0 ? (
                stats.topGames.slice(0, 10).map((game, index) => (
                  <div key={game.id} className="flex items-center gap-4 p-3 bg-gray-700/50 rounded-lg">
                    <div className="w-8 h-8 bg-purple-500/20 rounded-full flex items-center justify-center text-sm font-bold text-purple-400">
                      {index + 1}
                    </div>
                    <img src={game.cover} alt={game.name} className="w-12 h-16 object-cover rounded" />
                    <div className="flex-1 min-w-0">
                      <h4 className="text-white font-medium truncate">{game.name}</h4>
                      <p className="text-gray-400 text-sm">{game.board}</p>
                    </div>
                    <div className="flex items-center gap-1">
                      {[...Array(5)].map((_, i) => (
                        <Icon key={i} name="star" className={`w-4 h-4 ${i < game.rating ? 'text-yellow-400' : 'text-gray-600'}`} />
                      ))}
                      <span className="ml-2 text-white font-medium">{game.rating}</span>
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-gray-400 text-center py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–¥–∏–∞
    const MediaStatsContent = ({ stats }) => {
      const [tooltipData, setTooltipData] = useState(null);
      const [tooltipVisible, setTooltipVisible] = useState(false);
      const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });

      if (!stats) return <div className="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
      const chartData = stats.monthlyStats?.map(month => ({
        month: month.month,
        added: month.mediaAdded || 0,
        completed: month.mediaWatched || 0
      })) || [];

      const handleChartHover = (data, index) => {
        if (data) {
          setTooltipData(data);
          setTooltipVisible(true);
        } else {
          setTooltipVisible(false);
        }
      };

      const handleMouseMove = (e) => {
        setTooltipPosition({ x: e.clientX, y: e.clientY });
      };

      return (
        <div className="space-y-6">
          {/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å —á–∏—Å–ª–∞–º–∏ */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 backdrop-blur-xl rounded-xl p-6 border border-blue-500/30">
              <div className="text-3xl mb-2">üé¨</div>
              <h3 className="text-sm font-semibold text-gray-300 mb-1">–í—Å–µ–≥–æ –º–µ–¥–∏–∞</h3>
              <p className="text-3xl font-bold text-white">{stats.summary?.totalMedia || 0}</p>
            </div>
            <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-xl rounded-xl p-6 border border-green-500/30">
              <div className="text-3xl mb-2">üëÄ</div>
              <h3 className="text-sm font-semibold text-gray-300 mb-1">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</h3>
              <p className="text-3xl font-bold text-white">{stats.summary?.watchedMedia || 0}</p>
            </div>
            <div className="bg-gradient-to-br from-yellow-500/20 to-orange-500/20 backdrop-blur-xl rounded-xl p-6 border border-yellow-500/30">
              <div className="text-3xl mb-2">‚≠ê</div>
              <h3 className="text-sm font-semibold text-gray-300 mb-1">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</h3>
              <p className="text-3xl font-bold text-white">{stats.summary?.averageRating?.toFixed(1) || '0.0'}</p>
            </div>
            <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-xl rounded-xl p-6 border border-purple-500/30">
              <div className="text-3xl mb-2">üì∫</div>
              <h3 className="text-sm font-semibold text-gray-300 mb-1">–°–µ—Ä–∏–∞–ª—ã</h3>
              <p className="text-3xl font-bold text-white">{stats.summary?.tvShows || 0}</p>
            </div>
          </div>

          {/* –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–µ—Å—è—Ü–∞–º */}
          <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
            <h3 className="text-lg font-semibold text-white mb-4">üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
            <div className="relative" onMouseMove={handleMouseMove}>
              {chartData.length > 0 ? (
                <>
                  <BarChart 
                    data={chartData} 
                    height={300} 
                    onHover={handleChartHover}
                  />
                  <ChartLegend />
                  <ChartTooltip 
                    data={tooltipData} 
                    visible={tooltipVisible} 
                    x={tooltipPosition.x} 
                    y={tooltipPosition.y} 
                  />
                </>
              ) : (
                <div className="h-64 flex items-center justify-center text-gray-400">
                  <div className="text-center">
                    <div className="text-4xl mb-2">üìä</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* –¢–æ–ø-10 –º–µ–¥–∏–∞ */}
          <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
            <h3 className="text-lg font-semibold text-white mb-4">üèÜ –¢–æ–ø-10 –º–µ–¥–∏–∞</h3>
            <div className="space-y-3">
              {stats.topMedia?.slice(0, 10).map((media, index) => (
                <div key={media.id} className="flex items-center gap-4 p-3 bg-gray-700/50 rounded-lg">
                  <div className="w-8 h-8 bg-purple-500/20 rounded-full flex items-center justify-center text-sm font-bold text-purple-400">
                    {index + 1}
                  </div>
                  <img src={media.poster} alt={media.title} className="w-12 h-16 object-cover rounded" />
                  <div className="flex-1 min-w-0">
                    <h4 className="text-white font-medium truncate">{media.title}</h4>
                    <p className="text-gray-400 text-sm">{media.media_type} ‚Ä¢ {media.board}</p>
                  </div>
                  <div className="flex items-center gap-1">
                    {[...Array(5)].map((_, i) => (
                      <Icon key={i} name="star" className={`w-4 h-4 ${i < media.rating ? 'text-yellow-400' : 'text-gray-600'}`} />
                    ))}
                    <span className="ml-2 text-white font-medium">{media.rating}</span>
                  </div>
                </div>
              )) || <div className="text-gray-400 text-center py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>}
            </div>
          </div>
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥—Ä–∞—Ñ–∏–∫–∞
    const BarChart = ({ data, width = 800, height = 300, onHover }) => {
      const canvasRef = useRef(null);
      const containerRef = useRef(null);
      const [hoveredIndex, setHoveredIndex] = useState(null);
      const [chartDimensions, setChartDimensions] = useState({ width, height });

      // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞
      useEffect(() => {
        const updateDimensions = () => {
          if (containerRef.current) {
            const containerWidth = containerRef.current.offsetWidth;
            const newWidth = Math.min(containerWidth - 32, 800); // 32px –¥–ª—è padding
            setChartDimensions({ width: newWidth, height });
          }
        };

        updateDimensions();
        window.addEventListener('resize', updateDimensions);
        return () => window.removeEventListener('resize', updateDimensions);
      }, [height]);

      const drawChart = useCallback(() => {
        const canvas = canvasRef.current;
        if (!canvas || !data || data.length === 0) return;

        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const { width: chartWidth, height: chartHeight } = chartDimensions;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas —Å —É—á–µ—Ç–æ–º DPR
        canvas.width = chartWidth * dpr;
        canvas.height = chartHeight * dpr;
        canvas.style.width = `${chartWidth}px`;
        canvas.style.height = `${chartHeight}px`;
        ctx.scale(dpr, dpr);

        // –û—á–∏—â–∞–µ–º canvas
        ctx.clearRect(0, 0, chartWidth, chartHeight);

        const padding = 60;
        const innerWidth = chartWidth - padding * 2;
        const innerHeight = chartHeight - padding * 2;
        const barWidth = innerWidth / data.length * 0.8;
        const barSpacing = innerWidth / data.length * 0.2;

        // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        const maxValue = Math.max(...data.map(d => Math.max(d.added || 0, d.completed || 0)));

        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã
        const addedGradient = ctx.createLinearGradient(0, 0, 0, innerHeight);
        addedGradient.addColorStop(0, '#8b5cf6');
        addedGradient.addColorStop(1, '#ec4899');

        const completedGradient = ctx.createLinearGradient(0, 0, 0, innerHeight);
        completedGradient.addColorStop(0, '#06b6d4');
        completedGradient.addColorStop(1, '#3b82f6');

        // –†–∏—Å—É–µ–º –æ—Å–∏
        ctx.strokeStyle = '#374151';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, chartHeight - padding);
        ctx.lineTo(chartWidth - padding, chartHeight - padding);
        ctx.stroke();

        // –†–∏—Å—É–µ–º —Å—Ç–æ–ª–±—Ü—ã
        data.forEach((item, index) => {
          const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
          const addedHeight = ((item.added || 0) / maxValue) * innerHeight;
          const completedHeight = ((item.completed || 0) / maxValue) * innerHeight;

          // –°—Ç–æ–ª–±–µ—Ü "–¥–æ–±–∞–≤–ª–µ–Ω–æ"
          if (item.added > 0) {
            ctx.fillStyle = addedGradient;
            ctx.fillRect(x, chartHeight - padding - addedHeight, barWidth / 2, addedHeight);
          }

          // –°—Ç–æ–ª–±–µ—Ü "–∑–∞–≤–µ—Ä—à–µ–Ω–æ"
          if (item.completed > 0) {
            ctx.fillStyle = completedGradient;
            ctx.fillRect(x + barWidth / 2, chartHeight - padding - completedHeight, barWidth / 2, completedHeight);
          }

          // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
          if (hoveredIndex === index) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fillRect(x, chartHeight - padding - Math.max(addedHeight, completedHeight), barWidth, Math.max(addedHeight, completedHeight));
          }

          // –ü–æ–¥–ø–∏—Å–∏ –º–µ—Å—è—Ü–µ–≤
          ctx.fillStyle = '#9ca3af';
          ctx.font = '12px Inter';
          ctx.textAlign = 'center';
          ctx.fillText(item.month, x + barWidth / 2, chartHeight - padding + 20);
        });

        // –†–∏—Å—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –æ—Å—è—Ö
        ctx.fillStyle = '#6b7280';
        ctx.font = '10px Inter';
        ctx.textAlign = 'right';
        for (let i = 0; i <= 5; i++) {
          const value = Math.round((maxValue / 5) * i);
          const y = chartHeight - padding - (innerHeight / 5) * i;
          ctx.fillText(value.toString(), padding - 10, y + 4);
        }
      }, [data, chartDimensions, hoveredIndex]);

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –º—ã—à–∏
      const handleMouseMove = useCallback((e) => {
        const canvas = canvasRef.current;
        if (!canvas) return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const padding = 60;
        const { width: chartWidth } = chartDimensions;
        const innerWidth = chartWidth - padding * 2;
        const barWidth = innerWidth / data.length * 0.8;
        const barSpacing = innerWidth / data.length * 0.2;

        const index = Math.floor((x - padding) / (barWidth + barSpacing));
        
        if (index >= 0 && index < data.length && x >= padding && x <= chartWidth - padding) {
          setHoveredIndex(index);
          if (onHover) {
            onHover(data[index], index);
          }
        } else {
          setHoveredIndex(null);
          if (onHover) {
            onHover(null, null);
          }
        }
      }, [data, chartDimensions, onHover]);

      const handleMouseLeave = useCallback(() => {
        setHoveredIndex(null);
        if (onHover) {
          onHover(null, null);
        }
      }, [onHover]);

      useEffect(() => {
        drawChart();
      }, [drawChart]);

      return (
        <div ref={containerRef} className="relative w-full">
          <canvas
            ref={canvasRef}
            onMouseMove={handleMouseMove}
            onMouseLeave={handleMouseLeave}
            className="cursor-pointer"
          />
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ª–µ–≥–µ–Ω–¥—ã –≥—Ä–∞—Ñ–∏–∫–∞
    const ChartLegend = () => (
      <div className="flex items-center justify-center gap-6 mt-4">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 bg-gradient-to-r from-purple-500 to-pink-500 rounded"></div>
          <span className="text-sm text-gray-300">–î–æ–±–∞–≤–ª–µ–Ω–æ</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 bg-gradient-to-r from-cyan-500 to-blue-500 rounded"></div>
          <span className="text-sm text-gray-300">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
        </div>
      </div>
    );

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç tooltip
    const ChartTooltip = ({ data, visible, x, y }) => {
      if (!visible || !data) return null;

      return (
        <div
          className="absolute bg-gray-800 border border-gray-600 rounded-lg p-3 shadow-xl z-10 pointer-events-none"
          style={{
            left: x + 10,
            top: y - 10,
            transform: 'translateY(-100%)'
          }}
        >
          <div className="text-white text-sm font-medium">{data.month}</div>
          <div className="text-purple-400 text-xs">–î–æ–±–∞–≤–ª–µ–Ω–æ: {data.added || 0}</div>
          <div className="text-cyan-400 text-xs">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: {data.completed || 0}</div>
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç dropdown –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    const ExportDropdown = ({ onExport, loading }) => {
      const [isOpen, setIsOpen] = useState(false);
      const dropdownRef = useRef(null);

      const handleExport = (format) => {
        onExport(format);
        setIsOpen(false);
      };

      // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
            setIsOpen(false);
          }
        };

        if (isOpen) {
          document.addEventListener('mousedown', handleClickOutside);
        }

        return () => {
          document.removeEventListener('mousedown', handleClickOutside);
        };
      }, [isOpen]);

      return (
        <div ref={dropdownRef} className="relative">
          <button
            onClick={() => setIsOpen(!isOpen)}
            disabled={loading}
            className="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50"
          >
            {loading ? (
              <>
                <Icon name="loader" className="w-4 h-4 animate-spin" />
                –≠–∫—Å–ø–æ—Ä—Ç...
              </>
            ) : (
              <>
                <Icon name="download" className="w-4 h-4" />
                –≠–∫—Å–ø–æ—Ä—Ç
                <Icon name="chevronDown" className="w-4 h-4" />
              </>
            )}
          </button>

          {isOpen && !loading && (
            <div className="absolute right-0 top-full mt-2 w-48 bg-gray-800 rounded-lg border border-gray-700 z-50 elevation-4">
              <div className="py-2">
                <button
                  onClick={() => handleExport('json')}
                  className="w-full px-4 py-2 text-left text-white hover:bg-gray-700 transition-colors flex items-center gap-3"
                >
                  <Icon name="file" className="w-4 h-4 text-green-400" />
                  <div>
                    <div className="font-medium">JSON</div>
                    <div className="text-xs text-gray-400">–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
                  </div>
                </button>
                <button
                  onClick={() => handleExport('csv')}
                  className="w-full px-4 py-2 text-left text-white hover:bg-gray-700 transition-colors flex items-center gap-3"
                >
                  <Icon name="table" className="w-4 h-4 text-blue-400" />
                  <div>
                    <div className="font-medium">CSV</div>
                    <div className="text-xs text-gray-400">–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                  </div>
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞–º–∏
    const TagsManager = ({ isOpen, onClose, token, onTagsUpdate }) => {
      const [tags, setTags] = useState([]);
      const [loading, setLoading] = useState(false);
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [newTagName, setNewTagName] = useState('');
      const [newTagColor, setNewTagColor] = useState('#3B82F6');
      const [creating, setCreating] = useState(false);
      const [deletingTag, setDeletingTag] = useState(null);

      // –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞
      const presetColors = [
        '#3B82F6', '#EF4444', '#10B981', '#F59E0B', 
        '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16',
        '#F97316', '#6366F1', '#14B8A6', '#EAB308'
      ];

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤
      const loadTags = useCallback(async () => {
        if (!token) return;
        setLoading(true);
        try {
          console.log('TagsManager: Loading tags from:', `${API_URL}/api/tags?type=game`);
          const response = await fetch(`${API_URL}/api/tags?type=game`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          console.log('TagsManager: Tags response status:', response.status);
          if (response.ok) {
            const data = await response.json();
            console.log('TagsManager: Tags data:', data);
            setTags(data.tags || []);
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('TagsManager: Error loading tags:', response.status, errorData);
            setTags([]);
          }
        } catch (error) {
          console.error('TagsManager: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–≥–æ–≤:', error);
          // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤
          setTags([]);
        } finally {
          setLoading(false);
        }
      }, [token]);

      // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞
      const createTag = async () => {
        if (!newTagName.trim()) return;
        setCreating(true);
        try {
          const response = await fetch(`${API_URL}/api/tags`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: newTagName.trim(),
              color: newTagColor,
              type: 'game'
            })
          });
          if (response.ok) {
            await loadTags();
            setNewTagName('');
            setShowCreateForm(false);
            if (onTagsUpdate) onTagsUpdate();
          } else {
            const errorData = await response.json();
            alert(errorData.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–≥–∞');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–≥–∞:', error);
        } finally {
          setCreating(false);
        }
      };

      // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
      const deleteTag = async (tagId) => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
        setDeletingTag(tagId);
        try {
          const response = await fetch(`${API_URL}/api/tags/${tagId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            await loadTags();
            if (onTagsUpdate) onTagsUpdate();
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–∞:', error);
        } finally {
          setDeletingTag(null);
        }
      };

      useEffect(() => {
        if (isOpen) {
          loadTags();
        }
      }, [isOpen, loadTags]);

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-gray-900 rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-gray-700">
              <h2 className="text-2xl font-bold text-white">üè∑Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏</h2>
              <button
                onClick={onClose}
                className="p-2 hover:bg-gray-800 rounded-lg transition-colors"
              >
                <Icon name="x" className="w-6 h-6 text-gray-400" />
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              {/* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è */}
              <div className="mb-6">
                <button
                  onClick={() => setShowCreateForm(!showCreateForm)}
                  className="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg transition-colors flex items-center gap-2"
                >
                  <Icon name="plus" className="w-4 h-4" />
                  –°–æ–∑–¥–∞—Ç—å —Ç–µ–≥
                </button>
              </div>

              {/* –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è */}
              {showCreateForm && (
                <div className="mb-6 p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                  <h3 className="text-lg font-semibold text-white mb-4">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ–≥</h3>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-300 mb-2">
                        –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞
                      </label>
                      <input
                        type="text"
                        value={newTagName}
                        onChange={(e) => setNewTagName(e.target.value)}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞"
                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-purple-500 focus:outline-none text-white"
                        maxLength={50}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-300 mb-2">
                        –¶–≤–µ—Ç —Ç–µ–≥–∞
                      </label>
                      <div className="flex flex-wrap gap-2">
                        {presetColors.map(color => (
                          <button
                            key={color}
                            onClick={() => setNewTagColor(color)}
                            className={`w-8 h-8 rounded-full border-2 transition-all ${
                              newTagColor === color 
                                ? 'border-white scale-110' 
                                : 'border-gray-600 hover:border-gray-400'
                            }`}
                            style={{ backgroundColor: color }}
                          />
                        ))}
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <button
                        onClick={createTag}
                        disabled={!newTagName.trim() || creating}
                        className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center gap-2"
                      >
                        {creating ? (
                          <>
                            <Icon name="loader" className="w-4 h-4 animate-spin" />
                            –°–æ–∑–¥–∞–Ω–∏–µ...
                          </>
                        ) : (
                          <>
                            <Icon name="check" className="w-4 h-4" />
                            –°–æ–∑–¥–∞—Ç—å
                          </>
                        )}
                      </button>
                      <button
                        onClick={() => {
                          setShowCreateForm(false);
                          setNewTagName('');
                        }}
                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors"
                      >
                        –û—Ç–º–µ–Ω–∞
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* –°–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤ */}
              <div>
                <h3 className="text-lg font-semibold text-white mb-4">
                  –í–∞—à–∏ —Ç–µ–≥–∏ ({tags.length})
                </h3>
                {loading ? (
                  <div className="flex items-center justify-center py-8">
                    <Icon name="loader" className="w-6 h-6 animate-spin text-purple-400" />
                  </div>
                ) : tags.length === 0 ? (
                  <div className="text-center py-8">
                    <div className="text-4xl mb-2">üè∑Ô∏è</div>
                    <p className="text-gray-400">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ç–µ–≥–æ–≤</p>
                    <p className="text-sm text-gray-500 mt-1">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–µ–≥ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä</p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {tags.map(tag => (
                      <div
                        key={tag.id}
                        className="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border border-gray-700"
                      >
                        <div className="flex items-center gap-3">
                          <div
                            className="w-4 h-4 rounded-full"
                            style={{ backgroundColor: tag.color }}
                          />
                          <span className="text-white font-medium">{tag.name}</span>
                        </div>
                        <button
                          onClick={() => deleteTag(tag.id)}
                          disabled={deletingTag === tag.id}
                          className="p-1 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded transition-colors disabled:opacity-50"
                        >
                          {deletingTag === tag.id ? (
                            <Icon name="loader" className="w-4 h-4 animate-spin" />
                          ) : (
                            <Icon name="trash" className="w-4 h-4" />
                          )}
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };


    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–æ–≤ –∫ –∏–≥—Ä–µ
    const TagModal = ({ game, token, onTagAdded, isOpen, onClose }) => {
      const [tags, setTags] = useState([]);
      const [loading, setLoading] = useState(false);
      const [addingTag, setAddingTag] = useState(null);
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [newTagName, setNewTagName] = useState('');
      const [newTagColor, setNewTagColor] = useState('#3B82F6');
      const [isCreating, setIsCreating] = useState(false);

      const predefinedColors = [
        '#3B82F6', '#EF4444', '#10B981', '#F59E0B', 
        '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16',
        '#F97316', '#6366F1', '#14B8A6', '#EAB308'
      ];

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤
      const loadTags = useCallback(async () => {
        if (!token) return;
        setLoading(true);
        try {
          console.log('Loading tags from:', `${API_URL}/api/tags?type=game`);
          const response = await fetch(`${API_URL}/api/tags?type=game`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          console.log('Tags response status:', response.status);
          if (response.ok) {
            const data = await response.json();
            console.log('Tags data:', data);
            setTags(data.tags || []);
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('Error loading tags:', response.status, errorData);
            setTags([]);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–≥–æ–≤:', error);
          // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤
          setTags([]);
        } finally {
          setLoading(false);
        }
      }, [token]);

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞ –∫ –∏–≥—Ä–µ
      const addTagToGame = async (tagId) => {
        setAddingTag(tagId);
        try {
          const response = await fetch(`${API_URL}/api/games/${game.id}/tags/${tagId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            onClose();
            if (onTagAdded) onTagAdded();
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞:', error);
        } finally {
          setAddingTag(null);
        }
      };

      // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞
      const createTag = async () => {
        if (!newTagName.trim()) return;
        
        setIsCreating(true);
        try {
          const response = await fetch(`${API_URL}/api/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ name: newTagName.trim(), color: newTagColor, type: 'game' })
          });
          
          if (response.ok) {
            const data = await response.json();
            setTags(prev => [...prev, data.tag]);
            setNewTagName('');
            setNewTagColor('#3B82F6');
            setShowCreateForm(false);
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–≥ –∫ –∏–≥—Ä–µ
            await addTagToGame(data.tag.id);
          } else {
            throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–≥–∞');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–≥–∞:', error);
        } finally {
          setIsCreating(false);
        }
      };

      useEffect(() => {
        if (isOpen) {
          loadTags();
        }
      }, [isOpen, loadTags]);

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ (–∏—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ)
      const availableTags = tags.filter(tag => 
        !game.tags || !game.tags.some(gameTag => gameTag.id === tag.id)
      );

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4" onClick={onClose}>
          <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-white">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏</h2>
              <button onClick={onClose} className="p-2 hover:bg-gray-800 rounded-lg">
                <Icon name="x" className="w-5 h-5 text-gray-400" />
              </button>
            </div>
            
            <div className="mb-4">
              <p className="text-gray-400 text-sm">–ò–≥—Ä–∞: {game.name}</p>
            </div>

            {!showCreateForm ? (
              <div className="space-y-4">
                {/* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ–≥–∏ */}
                {availableTags.length > 0 && (
                  <div>
                    <p className="text-gray-400 text-sm mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–µ–≥:</p>
                    <div className="space-y-2 max-h-40 overflow-y-auto">
                      {availableTags.map(tag => (
                        <button
                          key={tag.id}
                          onClick={() => addTagToGame(tag.id)}
                          disabled={addingTag === tag.id}
                          className="w-full px-4 py-3 text-left text-white hover:bg-gray-800 rounded-lg border border-gray-700 transition-colors flex items-center gap-3 disabled:opacity-50"
                        >
                          <div
                            className="w-4 h-4 rounded-full flex-shrink-0"
                            style={{ backgroundColor: tag.color }}
                          />
                          <span className="text-sm font-medium">{tag.name}</span>
                          {addingTag === tag.id && (
                            <Icon name="loader" className="w-4 h-4 animate-spin ml-auto text-purple-400" />
                          )}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞ */}
                <div className="border-t border-gray-700 pt-4">
                  <button
                    onClick={() => setShowCreateForm(true)}
                    className="w-full py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors flex items-center justify-center gap-2"
                  >
                    <Icon name="plus" className="w-4 h-4" />
                    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ–≥
                  </button>
                </div>

                {availableTags.length === 0 && (
                  <div className="text-center py-8">
                    <div className="text-4xl mb-2">üè∑Ô∏è</div>
                    <p className="text-gray-400">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–≥–æ–≤</p>
                    <p className="text-sm text-gray-500 mt-1">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–≥</p>
                  </div>
                )}
              </div>
            ) : (
              /* –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞ */
              <div className="space-y-4">
                <div>
                  <label className="text-gray-400 text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞:</label>
                  <input
                    type="text"
                    value={newTagName}
                    onChange={(e) => setNewTagName(e.target.value)}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞"
                    className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1"
                    maxLength={50}
                  />
                </div>
                
                <div>
                  <label className="text-gray-400 text-sm">–¶–≤–µ—Ç —Ç–µ–≥–∞:</label>
                  <div className="flex flex-wrap gap-2 mt-2">
                    {predefinedColors.map(color => (
                      <button
                        key={color}
                        onClick={() => setNewTagColor(color)}
                        className={`w-8 h-8 rounded-full border-2 transition-all ${
                          newTagColor === color ? 'border-white scale-110' : 'border-gray-600'
                        }`}
                        style={{ backgroundColor: color }}
                      />
                    ))}
                  </div>
                </div>
                
                <div className="flex gap-2">
                  <button
                    onClick={createTag}
                    disabled={!newTagName.trim() || isCreating}
                    className="flex-1 py-2 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg transition-colors"
                  >
                    {isCreating ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å —Ç–µ–≥'}
                  </button>
                  <button
                    onClick={() => {
                      setShowCreateForm(false);
                      setNewTagName('');
                      setNewTagColor('#3B82F6');
                    }}
                    className="flex-1 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const HistoryLog = ({ isOpen, onClose, gameId, gameName, token }) => {
      const [history, setHistory] = useState([]);
      const [loading, setLoading] = useState(false);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
      const loadHistory = useCallback(async () => {
        if (!token || !gameId) return;
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/user/history/game/${gameId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setHistory(data.history || []);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        } finally {
          setLoading(false);
        }
      }, [token, gameId]);

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π –¥–∞—Ç—ã
      const formatRelativeDate = (dateString) => {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMinutes < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (diffMinutes < 60) return `${diffMinutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
        if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
        if (diffDays === 1) return '–≤—á–µ—Ä–∞';
        if (diffDays < 7) return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} –Ω–µ–¥ –Ω–∞–∑–∞–¥`;
        if (diffDays < 365) return `${Math.floor(diffDays / 30)} –º–µ—Å –Ω–∞–∑–∞–¥`;
        return `${Math.floor(diffDays / 365)} –≥ –Ω–∞–∑–∞–¥`;
      };

      // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è
      const getActionIcon = (action) => {
        switch (action) {
          case 'created': return '‚ûï';
          case 'moved': return 'üîÑ';
          case 'updated': return '‚úèÔ∏è';
          case 'deleted': return '‚ùå';
          default: return 'üìù';
        }
      };

      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è
      const getActionColor = (action) => {
        switch (action) {
          case 'created': return 'text-green-400';
          case 'moved': return 'text-blue-400';
          case 'updated': return 'text-yellow-400';
          case 'deleted': return 'text-red-400';
          default: return 'text-gray-400';
        }
      };

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      const formatChange = (action, oldValue, newValue) => {
        switch (action) {
          case 'created':
            return `–°–æ–∑–¥–∞–Ω–æ: ${newValue}`;
          case 'moved':
            return `–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ: ${oldValue} ‚Üí ${newValue}`;
          case 'updated':
            return `–ò–∑–º–µ–Ω–µ–Ω–æ: ${oldValue} ‚Üí ${newValue}`;
          case 'deleted':
            return `–£–¥–∞–ª–µ–Ω–æ: ${oldValue}`;
          default:
            return `${oldValue} ‚Üí ${newValue}`;
        }
      };

      useEffect(() => {
        if (isOpen) {
          loadHistory();
        }
      }, [isOpen, loadHistory]);

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-gray-900 rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-gray-700">
              <div>
                <h2 className="text-2xl font-bold text-white">üìú –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
                <p className="text-gray-400 text-sm mt-1">{gameName}</p>
              </div>
              <button
                onClick={onClose}
                className="p-2 hover:bg-gray-800 rounded-lg transition-colors"
              >
                <Icon name="x" className="w-6 h-6 text-gray-400" />
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              {loading ? (
                <div className="flex items-center justify-center py-8">
                  <Icon name="loader" className="w-6 h-6 animate-spin text-purple-400" />
                  <span className="ml-2 text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</span>
                </div>
              ) : history.length === 0 ? (
                <div className="text-center py-8">
                  <div className="text-4xl mb-2">üìú</div>
                  <p className="text-gray-400">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>
                  <p className="text-sm text-gray-500 mt-1">–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {history.map((item, index) => (
                    <div key={item.id} className="flex items-start gap-4 p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                      {/* Timeline line */}
                      <div className="flex flex-col items-center">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${getActionColor(item.action)}`}>
                          {getActionIcon(item.action)}
                        </div>
                        {index < history.length - 1 && (
                          <div className="w-0.5 h-8 bg-gray-600 mt-2"></div>
                        )}
                      </div>

                      {/* Content */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <span className={`text-sm font-medium ${getActionColor(item.action)}`}>
                            {formatChange(item.action, item.old_value, item.new_value)}
                          </span>
                        </div>
                        <p className="text-xs text-gray-400">
                          {formatRelativeDate(item.created_at)}
                        </p>
                        {item.old_value && item.new_value && item.action !== 'created' && item.action !== 'deleted' && (
                          <div className="mt-2 p-2 bg-gray-700/50 rounded text-xs">
                            <div className="text-red-400 line-through">{item.old_value}</div>
                            <div className="text-green-400">{item.new_value}</div>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ –∏–≥—Ä—ã
    const GameModal = ({ game, onClose, onUpdate, onReact, isViewingFriend, user, token, onRemoveTag, onFilterByTag, onOpenTagModal }) => {
      const { touchOffset, isMobile, handleTouchStart, handleTouchMove, handleTouchEnd } = useSwipeToClose(onClose);
      const [removingTag, setRemovingTag] = useState(null);
      
      const handleRemoveTag = async (tagId, gameId) => {
        setRemovingTag(tagId);
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
          onRemoveTag(tagId, gameId);
          setRemovingTag(null);
        }, 300);
      };
      
      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] md:p-4" onClick={onClose}>
          <div 
            className={`bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 max-h-[90vh] overflow-y-auto elevation-3 ${isMobile ? 'mobile-fullscreen-modal' : ''}`}
            style={isMobile ? { transform: `translateY(${touchOffset}px)`, transition: touchOffset === 0 ? 'transform 0.3s ease' : 'none' } : {}}
            onClick={e => e.stopPropagation()}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
          >
            {isMobile && <div className="swipe-indicator"></div>}
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-bold text-white">{game.name}</h2>
              <button onClick={onClose} className="p-2 hover:bg-gray-800 rounded-lg">
                <Icon name="x" className="w-5 h-5 text-gray-400" />
              </button>
            </div>
            <div className="space-y-4">
              {!isViewingFriend ? (
                <Fragment>
                  <div>
                    <p className="text-gray-400 text-sm mb-2">–†–µ–π—Ç–∏–Ω–≥:</p>
                    <div className="flex gap-2">
                      {[1, 2, 3, 4, 5].map(star => (
                        <button 
                          key={star} 
                          onClick={() => onUpdate(game.id, { rating: star })} 
                          className="transition-all duration-200 hover:scale-110 active:scale-95"
                        >
                          <Icon 
                            name="star" 
                            className={`w-8 h-8 transition-all duration-300 ${
                              star <= (game.rating || 0) 
                                ? 'text-yellow-400 drop-shadow-lg' 
                                : 'text-gray-600 hover:text-gray-400'
                            }`} 
                          />
                        </button>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="text-gray-400 text-sm">–ó–∞–º–µ—Ç–∫–∏:</label>
                    <textarea defaultValue={game.notes || ''} onBlur={(e) => onUpdate(game.id, { notes: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" rows="3" placeholder="–¢–≤–æ–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è..." />
                  </div>
                </Fragment>
              ) : (
                <Fragment>
                  {game.rating && 
                    <div>
                      <p className="text-gray-400 text-sm mb-2">–†–µ–π—Ç–∏–Ω–≥ –æ—Ç {user.username}:</p>
                      <div className="flex gap-1">
                        {[...Array(5)].map((_, i) => (<Icon key={i} name="star" className={`w-6 h-6 ${i < game.rating ? 'text-yellow-400' : 'text-gray-600'}`} />))}
                      </div>
                    </div>
                  }
                  {game.notes &&
                    <div>
                      <p className="text-gray-400 text-sm mb-1">–ó–∞–º–µ—Ç–∫–∏ –æ—Ç {user.username}:</p>
                      <p className="text-white bg-gray-800 p-3 rounded-lg border border-gray-700">{game.notes}</p>
                    </div>
                  }
                  {(!game.notes && !game.rating) && <p className="text-gray-400">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Å—Ç–∞–≤–∏–ª –æ—Ç–∑—ã–≤–∞.</p>}
                  <div className="pt-2">
                    <p className="text-gray-400 text-sm mb-2">–í–∞—à–∞ —Ä–µ–∞–∫—Ü–∏—è:</p>
                    <div className="flex flex-wrap gap-2">
                      {REACTION_EMOJIS.map(emoji => {
                        const userReaction = game.reactions?.find(r => r.user_id === user.id && r.emoji === emoji);
                        return (
                          <button
                            key={emoji}
                            onClick={() => onReact(game.id, emoji)}
                            className={`text-2xl transform hover:scale-125 transition-all duration-200 p-2 rounded-full ${
                              userReaction 
                                ? 'bg-purple-500/30 border-2 border-purple-400/50 shadow-lg shadow-purple-500/25' 
                                : 'hover:bg-gray-700/50 border border-transparent'
                            }`}
                            title={userReaction ? `–£–±—Ä–∞—Ç—å —Ä–µ–∞–∫—Ü–∏—é ${emoji}` : `–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é ${emoji}`}
                          >
                            {emoji}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </Fragment>
              )}
              
              
              {game.reactions && game.reactions.length > 0 && (
                <div>
                  <p className="text-gray-400 text-sm mb-3">–í—Å–µ —Ä–µ–∞–∫—Ü–∏–∏:</p>
                  <div className="space-y-2">
                    {Object.entries(groupReactions(game.reactions)).map(([emoji, data]) => (
                      <div key={emoji} className="bg-gray-800/50 rounded-lg p-3 border border-gray-700">
                        <div className="flex items-center gap-3 mb-2">
                          <span className="text-xl">{emoji}</span>
                          <span className="text-white font-medium">{data.count} {data.count === 1 ? '—Ä–µ–∞–∫—Ü–∏—è' : data.count < 5 ? '—Ä–µ–∞–∫—Ü–∏–∏' : '—Ä–µ–∞–∫—Ü–∏–π'}</span>
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {data.users.map((username, idx) => (
                            <div key={idx} className="flex items-center gap-2 bg-gray-700/50 px-2 py-1 rounded-full">
                              <Avatar 
                                src={game.reactions.find(r => r.username === username)?.user?.avatar} 
                                size="xs" 
                              />
                              <span className="text-xs text-gray-300">{username}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* –¢–µ–≥–∏ */}
              {game.tags && game.tags.length > 0 && (
                <div>
                  <p className="text-gray-400 text-sm mb-3">–¢–µ–≥–∏:</p>
                  <div className="flex flex-wrap gap-2">
                    {game.tags.map((tag, i) => (
                      <div 
                        key={tag.id} 
                        className={`flex items-center gap-2 text-sm px-3 py-1 rounded-full text-white font-medium transition-all duration-300 cursor-pointer hover:opacity-80 ${
                          removingTag === tag.id ? 'opacity-0 scale-0 transform rotate-12' : 'opacity-100 scale-100'
                        }`}
                        style={{ backgroundColor: tag.color + '40', border: `1px solid ${tag.color}` }}
                        onClick={() => onFilterByTag && onFilterByTag(tag.id, tag.name)}
                      >
                        <span>{tag.name}</span>
                        {!isViewingFriend && onRemoveTag && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              handleRemoveTag(tag.id, game.id);
                            }}
                            className="text-red-400 hover:text-red-300 transition-colors"
                            title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥"
                            disabled={removingTag === tag.id}
                          >
                            <Icon name="x" className="w-3 h-3" />
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞ */}
              {!isViewingFriend && (
                <div className="flex justify-center">
                  <button
                    onClick={() => {
                      onOpenTagModal(game);
                    }}
                    className="flex items-center gap-2 px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg transition-colors"
                  >
                    <Icon name="tag" className="w-4 h-4" />
                    –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥
                  </button>
                </div>
              )}
              
              <div className="flex gap-2 mt-4">
                <a 
                  href={game.videoId ? `https://www.youtube.com/watch?v=${game.videoId}` : `https://www.youtube.com/results?search_query=${encodeURIComponent(game.name + ' trailer')}`} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="flex-1 flex items-center justify-center gap-2 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">
                  <Icon name="youtube" className="w-6 h-6" />
                  –¢—Ä–µ–π–ª–µ—Ä
                </a>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const GameKanban = () => {
      const [user, setUser] = useState(null);
      const [showAuth, setShowAuth] = useState(true);
      const [authMode, setAuthMode] = useState('login');
      const [loading, setLoading] = useState(false);
      const [boardsLoading, setBoardsLoading] = useState(false);
      const [error, setError] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [showSearch, setShowSearch] = useState(false);
      const [searching, setSearching] = useState(false);
      const [myGamesSearchQuery, setMyGamesSearchQuery] = useState('');
      const [myGamesSearchResults, setMyGamesSearchResults] = useState([]);
      const [myGamesSearching, setMyGamesSearching] = useState(false);
      const [showMyGamesSearch, setShowMyGamesSearch] = useState(false);
      const [showProfile, setShowProfile] = useState(false);
      const [showUserHub, setShowUserHub] = useState(false);
      const [showStatistics, setShowStatistics] = useState(false);
      const [showTagsManager, setShowTagsManager] = useState(false);
      const [showHistoryLog, setShowHistoryLog] = useState(false);
      const [historyGame, setHistoryGame] = useState(null);
      const [showTagModal, setShowTagModal] = useState(false);
      const [selectedGameForTag, setSelectedGameForTag] = useState(null);
      const [showMobileMenu, setShowMobileMenu] = useState(false);
      const [showCardMenu, setShowCardMenu] = useState(null);
      const [selectedCard, setSelectedCard] = useState(null);
      const [expandedBoards, setExpandedBoards] = useState({});
      const [selectedTag, setSelectedTag] = useState(null);
      const [showMobileActionMenu, setShowMobileActionMenu] = useState(false);
      const [showMoveMenu, setShowMoveMenu] = useState(false);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
      
      // Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      const [toast, setToast] = useState({ message: '', type: 'info', isVisible: false });

      
      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      const showToast = (message, type = 'info') => {
        setToast({ message, type, isVisible: true });
      };

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
      const toggleExpand = (boardId) => {
        setExpandedBoards(prev => ({ ...prev, [boardId]: !prev[boardId] }));
      };

      const openCardMenu = (card) => {
        setSelectedCard(card);
        setShowCardMenu(card.id);
      };

      const closeCardMenu = () => {
        setShowCardMenu(null);
        setSelectedCard(null);
      };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π
      const handleMobileCardClick = (card) => {
        if (!isMobile || viewingUser) return;
        setSelectedCard(card);
        setShowMobileActionMenu(true);
      };

      const closeMobileActionMenu = () => {
        setShowMobileActionMenu(false);
        setShowMoveMenu(false);
        setSelectedCard(null);
      };

      const handleMoveToBoard = (targetBoardId) => {
        if (selectedCard && targetBoardId !== selectedCard.board_id) {
          // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
          console.log(`Moving ${selectedCard.name} to board ${targetBoardId}`);
          closeMobileActionMenu();
        }
      };

      const openEditModal = () => {
        setShowMobileActionMenu(false);
        setSelectedGame(selectedCard);
      };
      
      const hideToast = () => {
        setToast(prev => ({ ...prev, isVisible: false }));
      };
      const [allUsers, setAllUsers] = useState([]);
      const [userSearchQuery, setUserSearchQuery] = useState('');
      const [friends, setFriends] = useState([]);
      const [friendRequests, setFriendRequests] = useState([]);
      const [sentRequests, setSentRequests] = useState([]);
      const [selectedGame, setSelectedGame] = useState(null);
      const [viewingUser, setViewingUser] = useState(null);
      const [showAddToMyBoard, setShowAddToMyBoard] = useState(false);
      const [cardToAdd, setCardToAdd] = useState(null);
      const [friendshipStatus, setFriendshipStatus] = useState('none');
      const [userNickname, setUserNickname] = useState('');
      const [editingNickname, setEditingNickname] = useState(false);
      const [uploadingAvatar, setUploadingAvatar] = useState(false);
      const fileInputRef = useRef(null);
      const [theme, setTheme] = useState('default');
      const [confirmingDeleteFriend, setConfirmingDeleteFriend] = useState(null);
      const [confirmingAddFriend, setConfirmingAddFriend] = useState(null);
      const dragItem = useRef(null);
      const [expandedColumns, setExpandedColumns] = useState({});
      const [formData, setFormData] = useState({ username: '', email: '', password: '' });
      const [profileData, setProfileData] = useState({ username: '', bio: '', theme: 'default', currentPassword: '', newPassword: '' });
      const [privacySettings, setPrivacySettings] = useState({
          is_profile_public: true,
          show_activity: true,
          show_stats: true,
          allow_friend_requests: true
      });
      const [imageForCrop, setImageForCrop] = useState(null);
      const [gameForReview, setGameForReview] = useState(null);
      const [targetBoardForAdd, setTargetBoardForAdd] = useState(null); // –ù–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï

      const canvasRef = useRef(null);
      const gameInstance = useRef(null);

      const [boards, setBoards] = useState({
        backlog: { id: 'backlog', title: '–ë–µ–∫–ª–æ–≥', emoji: 'üìã', color: 'from-blue-500/20 to-cyan-500/20', borderColor: 'border-blue-500/30', accentColor: '#3B82F6', cards: [] },
        playing: { id: 'playing', title: '–ò–≥—Ä–∞—é', emoji: 'üéÆ', color: 'from-orange-500/20 to-amber-500/20', borderColor: 'border-orange-500/30', accentColor: '#F59E0B', cards: [] },
        completed: { id: 'completed', title: '–ü—Ä–æ—à—ë–ª', emoji: '‚úÖ', color: 'from-green-500/20 to-emerald-500/20', borderColor: 'border-green-500/30', accentColor: '#10B981', cards: [] },
        dropped: { id: 'dropped', title: '–ë—Ä–æ—Å–∏–ª', emoji: '‚ùå', color: 'from-gray-500/20 to-slate-500/20', borderColor: 'border-gray-500/30', accentColor: '#6B7280', cards: [] }
      });
      
      // Debounce –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      const updateDebounceRef = useRef(null);
      
      useEffect(() => {
        const shouldRunGame = !showAuth && !viewingUser;

        if (shouldRunGame && canvasRef.current) {
            const initializeGame = () => {
                if (canvasRef.current && typeof window.GameRunner !== 'undefined' && !gameInstance.current) {
                    gameInstance.current = window.GameRunner.init(canvasRef.current);
                }
            };

            let script = document.getElementById('game-runner-script');
            if (!script) {
                script = document.createElement('script');
                script.src = 'game.js'; 
                script.id = 'game-runner-script';
                script.async = true;
                script.onload = initializeGame;
                document.body.appendChild(script);
            } else {
                initializeGame();
            }
        }
        return () => {
            if (gameInstance.current) {
                gameInstance.current.destroy();
                gameInstance.current = null;
            }
            const reloadHint = document.getElementById('game-reload-hint');
            if(reloadHint) reloadHint.style.display = 'flex';
        };
      }, [showAuth, viewingUser]);

      const loadBoards = useCallback(async (token, userId = null, tagId = null) => {
        setBoardsLoading(true);
        try {
          let url = userId ? `${API_URL}/api/user/${userId}/boards` : `${API_URL}/api/user/boards`;
          if (tagId) {
            url = `${API_URL}/api/user/games/by-tag/${tagId}`;
          }
          const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (response.ok) {
            const data = await response.json();
            if (userId) {
              setViewingUser(data.user);
              setFriendshipStatus(data.friendship);
              setUserNickname(data.nickname || '');
            } else {
               setViewingUser(null);
            }
            if (data.boards) {
              setBoards(prev => ({
                backlog: { ...prev.backlog, cards: data.boards.backlog || [] },
                playing: { ...prev.playing, cards: data.boards.playing || [] },
                completed: { ...prev.completed, cards: data.boards.completed || [] },
                dropped: { ...prev.dropped, cards: data.boards.dropped || [] }
              }));
            } else if (data.games) {
              // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–≥—Ä—ã –ø–æ —Ç–µ–≥—É, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Ö –ø–æ –¥–æ—Å–∫–∞–º
              const boards = { backlog: [], playing: [], completed: [], dropped: [] };
              data.games.forEach(game => {
                if (boards[game.board]) boards[game.board].push(game);
              });
              setBoards(prev => ({
                backlog: { ...prev.backlog, cards: boards.backlog },
                playing: { ...prev.playing, cards: boards.playing },
                completed: { ...prev.completed, cards: boards.completed },
                dropped: { ...prev.dropped, cards: boards.dropped }
              }));
            }
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
        } finally {
          setBoardsLoading(false);
        }
      }, []);

      useEffect(() => {
        const token = localStorage.getItem('token');
        const savedUser = localStorage.getItem('user');
        if (token && savedUser) {
          const parsedUser = JSON.parse(savedUser);
          setUser(parsedUser);
          setTheme(parsedUser.theme || 'default');
          setShowAuth(false);
          loadBoards(token);
        }
      }, [loadBoards]);
      
      useEffect(() => {
        document.body.className = theme;
      }, [theme]);

      const loadFriends = useCallback(async () => {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
          const response = await fetch(`${API_URL}/api/friends`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setFriends(data.friends || []);
            setFriendRequests(data.requests || []);
            setSentRequests(data.sentRequests || []);
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', err);
        }
      }, []);
      
      useEffect(() => {
        if(user) {
            loadFriends();
        }
      }, [user, loadFriends])

      const loadAllUsers = useCallback(async (query = '') => {
        const token = localStorage.getItem('token');
        try {
          const url = query 
            ? `${API_URL}/api/users?q=${encodeURIComponent(query)}` 
            : `${API_URL}/api/users`;
          const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (response.ok) {
            const data = await response.json();
            setAllUsers(data.users || []);
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err);
        }
      }, []);

      const handleAuth = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const endpoint = authMode === 'login' ? '/api/auth/login' : '/api/auth/register';
          const response = await fetch(`${API_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          const data = await response.json();
          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            setUser(data.user);
            setTheme(data.user.theme || 'default');
            setPrivacySettings({
                is_profile_public: data.user.is_profile_public ?? true,
                show_activity: data.user.show_activity ?? true,
                show_stats: data.user.show_stats ?? true,
                allow_friend_requests: data.user.allow_friend_requests ?? true
            });
            setShowAuth(false);
            loadBoards(data.token);
            showToast(authMode === 'login' ? '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
          } else {
            setError(data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            showToast(data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
          }
        } catch (err) {
          setError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
          showToast('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = () => {
                setImageForCrop(reader.result);
            };
            reader.readAsDataURL(file);
        }
      };
      
      const handleAvatarUpdate = async (croppedImage) => {
          setImageForCrop(null);
          setUploadingAvatar(true);
          try {
              const token = localStorage.getItem('token');
              const response = await fetch(`${API_URL}/api/profile/avatar`, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ avatar: croppedImage })
              });
              if (response.ok) {
                  const data = await response.json();
                  setUser(data.user);
                  localStorage.setItem('user', JSON.stringify(data.user));
                  alert('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!');
              } else {
                  alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞');
              }
          } catch (err) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', err);
              alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞');
          } finally {
              setUploadingAvatar(false);
          }
      };

      const handleSearch = async (query) => {
        setSearchQuery(query);
        if (query.length < 3) {
          setSearchResults([]);
          return;
        }
        setSearching(true);
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/games/search?q=${encodeURIComponent(query)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.ok) {
            const data = await response.json();
            setSearchResults(data.games || []);
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
        } finally {
          setSearching(false);
        }
      };

      // Debounce —Ñ—É–Ω–∫—Ü–∏—è
      const debounce = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      };

      // –ü–æ–∏—Å–∫ –ø–æ —Å–≤–æ–∏–º –∏–≥—Ä–∞–º —Å debounce
      const searchMyGames = useCallback(async (query) => {
        if (query.length < 3) {
          setMyGamesSearchResults([]);
          setShowMyGamesSearch(false);
          return;
        }
        setMyGamesSearching(true);
        setShowMyGamesSearch(true);
        try {
          const response = await fetch(`${API_URL}/api/user/games/search?q=${encodeURIComponent(query)}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          if (response.ok) {
            const data = await response.json();
            setMyGamesSearchResults(data.games || []);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —Å–≤–æ–∏–º –∏–≥—Ä–∞–º:', error);
        } finally {
          setMyGamesSearching(false);
        }
      }, []);

      // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Å–≤–æ–∏–º –∏–≥—Ä–∞–º
      const debouncedSearchMyGames = useCallback(
        debounce((query) => {
          searchMyGames(query);
        }, 300),
        [searchMyGames]
      );

      const addGameToBoard = async (game, boardId) => {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/user/boards/${boardId}/games`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ game })
          });
          
          if (response.ok) {
            await loadBoards(token);
            setShowSearch(false);
            setSearchQuery('');
            setSearchResults([]);
            setTargetBoardForAdd(null); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤—É—é –¥–æ—Å–∫—É
          } else {
            const data = await response.json();
            alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä—ã: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } catch (err) {
          alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä—ã');
        }
      };

      const deleteCard = async (e, cardId) => {
        e.stopPropagation();
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/user/games/${cardId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          loadBoards(token);
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
        }
      };

      const addCardToMyBoard = async (card, targetBoardId) => {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/user/games`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({
              name: card.name,
              board_id: targetBoardId,
              cover: card.cover,
              description: card.description,
              rating: card.rating,
              tags: card.tags
            })
          });
          
          if (response.ok) {
            await loadBoards(token);
            setShowAddToMyBoard(false);
            setCardToAdd(null);
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            alert('–ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ –≤–∞—à—É –¥–æ—Å–∫—É!');
          } else {
            throw new Error('Failed to add game');
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä—ã:', err);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        }
      };

      const updateGame = useCallback(async (gameId, updates) => {
        // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º UI –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
        setSelectedGame(prev => prev && prev.id === gameId ? { ...prev, ...updates } : prev);
        
        setBoards(prevBoards => {
            const newBoards = JSON.parse(JSON.stringify(prevBoards));
            for (const boardId in newBoards) {
                const cardIndex = newBoards[boardId].cards.findIndex(c => c.id === gameId);
                if (cardIndex > -1) {
                    newBoards[boardId].cards[cardIndex] = { ...newBoards[boardId].cards[cardIndex], ...updates };
                    break;
                }
            }
            return newBoards;
        });
        
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/user/games/${gameId}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(updates)
          });
           // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –ª–µ–Ω—Ç—É
           if(updates.board) {
              loadBoards(token);
           }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err);
          loadBoards(localStorage.getItem('token'));
        }
      }, [loadBoards]);
      
      const submitDeepReview = useCallback(async (gameId, answers) => {
          const token = localStorage.getItem('token');
          try {
             const response = await fetch(`${API_URL}/api/games/${gameId}/deep-review`, {
                 method: 'POST',
                 headers: {
                     'Authorization': `Bearer ${token}`,
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify({ answers })
             });
             if(response.ok) {
                await loadBoards(token); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫–∏, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∏ –ª–µ–Ω—Ç—É –∏ –∫–∞—Ä—Ç–æ—á–∫—É
                setGameForReview(null);
             } else {
                 throw new Error('Failed to submit review');
             }
          } catch(err) {
              console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞:', err);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤');
          }
      }, [loadBoards]);

      const handleDeleteReview = useCallback(async (gameId) => {
          if (!window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤?")) return;
          const token = localStorage.getItem('token');
          try {
             await fetch(`${API_URL}/api/games/${gameId}/deep-review`, {
                 method: 'DELETE',
                 headers: { 'Authorization': `Bearer ${token}` }
             });
             // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
             setBoards(prevBoards => {
                const newBoards = JSON.parse(JSON.stringify(prevBoards));
                const card = newBoards.completed.cards.find(c => c.id === gameId);
                if (card) card.deep_review_answers = null;
                return newBoards;
            });
            setSelectedGame(prev => ({...prev, deep_review_answers: null}));
          } catch(err) {
              console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞:', err);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤');
              loadBoards(token);
          }
      }, [loadBoards]);

      const addReaction = async (gameId, emoji) => {
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/games/${gameId}/reactions`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ emoji })
          });
          loadBoards(token, viewingUser?.id);
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏:', err);
        }
      };

      // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–∞ —Å –∏–≥—Ä—ã
      const removeTagFromGame = async (tagId, gameId) => {
        try {
          // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º UI –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
          setSelectedGame(prev => {
            if (!prev) return prev;
            return {
              ...prev,
              tags: prev.tags ? prev.tags.filter(tag => tag.id !== tagId) : []
            };
          });
          
          const response = await fetch(`${API_URL}/api/games/${gameId}/tags/${tagId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          
          if (response.ok) {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            loadBoards(localStorage.getItem('token'), viewingUser?.id);
          } else {
            throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–∞');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–∞:', error);
          // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          loadBoards(localStorage.getItem('token'), viewingUser?.id);
        }
      };

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä –ø–æ —Ç–µ–≥—É
      const filterGamesByTag = async (tagId, tagName) => {
        if (selectedTag && selectedTag.id === tagId) {
          // –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω —ç—Ç–æ—Ç —Ç–µ–≥, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
          setSelectedTag(null);
          loadBoards(localStorage.getItem('token'));
        } else {
          // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–µ–≥—É
          setSelectedTag({ id: tagId, name: tagName });
          loadBoards(localStorage.getItem('token'), null, tagId);
        }
      };

      // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞
      const openTagModal = (game) => {
        setSelectedGameForTag(game);
        setShowTagModal(true);
      };

      const friendAction = async (friendId, action) => {
        const token = localStorage.getItem('token');
        let endpoint = '';
        let method = 'POST';
        let body = { friendId: Number(friendId) }; 
        switch(action) {
            case 'request': endpoint = '/api/friends/request'; break;
            case 'accept': endpoint = '/api/friends/accept'; break;
            case 'reject': endpoint = '/api/friends/reject'; break;
            case 'remove': 
                endpoint = `/api/friends/${friendId}`; 
                method = 'DELETE'; 
                body = undefined;
                break;
            default: return;
        }

        try {
            const response = await fetch(`${API_URL}${endpoint}`, {
                method,
                headers: { 
                  'Authorization': `Bearer ${token}`, 
                  'Content-Type': 'application/json' 
                },
                body: body ? JSON.stringify(body) : null
            });
            if(!response.ok) {
              const err = await response.json();
              throw new Error(err.error || "Friend action failed")
            }
            await loadFriends();
            if (viewingUser && viewingUser.id == friendId) {
                await loadBoards(token, friendId);
            }
             if (showUserHub) {
                loadAllUsers(userSearchQuery);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
            if (updateNotificationsCallback) {
                updateNotificationsCallback();
            }
        } catch(err) {
            console.error(`–û—à–∏–±–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è '${action}':`, err);
        }
      };
      
      const updateNickname = async (friendId, nickname) => {
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_URL}/api/friends/${friendId}/nickname`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nickname })
          });
          setUserNickname(nickname);
          setEditingNickname(false);
          loadFriends();
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏:', err);
        }
      };
      
      const handleDragStart = (e, card, boardId, index) => {
        console.log('Drag start:', card.name, boardId, index);
        dragItem.current = { card, sourceBoardId: boardId, sourceIndex: index };
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.currentTarget.outerHTML);
        setTimeout(() => {
          e.currentTarget.classList.add('dragging-card');
        }, 0);
      };

      const handleDragOver = (e) => e.preventDefault();
      
      const handleDragEnterColumn = (e) => e.currentTarget.classList.add('drag-over-column');
      const handleDragLeaveColumn = (e) => e.currentTarget.classList.remove('drag-over-column');
      const handleDragEnterCard = (e) => e.currentTarget.classList.add('drag-over-card');
      const handleDragLeaveCard = (e) => e.currentTarget.classList.remove('drag-over-card');

      const handleDrop = (e, targetBoardId, targetIndex) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Drop:', targetBoardId, targetIndex, dragItem.current);

        if (!dragItem.current) return;
        const { card: draggedCard, sourceBoardId, sourceIndex } = dragItem.current;
        if (sourceBoardId === targetBoardId && sourceIndex === targetIndex) return;

        // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        setBoards(prevBoards => {
            const newBoards = JSON.parse(JSON.stringify(prevBoards));
            const [movedItem] = newBoards[sourceBoardId].cards.splice(sourceIndex, 1);
            if (targetIndex === undefined) {
                newBoards[targetBoardId].cards.push(movedItem);
            } else {
                newBoards[targetBoardId].cards.splice(targetIndex, 0, movedItem);
            }
            return newBoards;
        });
        
        if (sourceBoardId !== targetBoardId) {
            updateGame(draggedCard.id, { board: targetBoardId });
        } else {
            const orderedIds = boards[targetBoardId].cards.map(c => c.id);
            updateBoardOrder(targetBoardId, orderedIds);
        }

        dragItem.current = null;
      };

      const handleDragEnd = () => {
        document.querySelectorAll('.dragging-card').forEach(el => el.classList.remove('dragging-card'));
        document.querySelectorAll('.drag-over-column').forEach(el => el.classList.remove('drag-over-column'));
        document.querySelectorAll('.drag-over-card').forEach(el => el.classList.remove('drag-over-card'));
        dragItem.current = null;
      };

      const handleLogout = () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        setUser(null);
        setShowAuth(true);
        setViewingUser(null);
        setTheme('default');
      };

      const updateProfile = async () => {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`${API_URL}/api/profile`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({...profileData, theme})
          });
          if (response.ok) {
            const data = await response.json();
            setUser(data.user);
            setTheme(data.user.theme);
            localStorage.setItem('user', JSON.stringify(data.user));
            if (data.token) {
              localStorage.setItem('token', data.token);
            }
            setShowProfile(false);
            setProfileData({ username: '', bio: '', currentPassword: '', newPassword: '' });
            showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
          } else {
            const errorData = await response.json();
            showToast(errorData.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
          }
        } catch (err) {
          showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
        }
      };

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
      const updatePrivacySettings = async (setting, value) => {
          try {
              const newSettings = { ...privacySettings, [setting]: value };
              setPrivacySettings(newSettings);
              
              const response = await fetch(`${API_URL}/api/profile`, {
                  method: 'PUT',
                  headers: {
                      'Authorization': `Bearer ${localStorage.getItem('token')}`,
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ [setting]: value })
              });
              
              if (!response.ok) {
                  // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
                  setPrivacySettings(privacySettings);
                  alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏');
              }
          } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:', error);
              setPrivacySettings(privacySettings);
              alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏');
          }
      };
      
      const FriendActionButton = ({ targetUser }) => {
        if (!user || user.id === targetUser.id) return null;
        if (friendshipStatus === 'friends') {
            return <button onClick={() => setConfirmingDeleteFriend(targetUser)} className="flex items-center gap-1 p-2 bg-green-500/20 hover:bg-red-500/20 rounded-lg border border-green-500/30 hover:border-red-500/30 transition-all"><Icon name="userCheck" className="w-4 h-4 md:w-5 md:h-5 text-green-400" /></button>;
        }
        if (friendshipStatus === 'request_sent') {
            return <button onClick={() => friendAction(targetUser.id, 'reject')} className="flex items-center gap-1 p-2 bg-yellow-500/20 rounded-lg border border-yellow-500/30"><Icon name="userClock" className="w-4 h-4 md:w-5 md:h-5 text-yellow-400" /></button>;
        }
        if (friendshipStatus === 'request_received') {
            return (
                <div className="flex gap-2">
                    <button onClick={() => setConfirmingAddFriend(targetUser)} className="flex items-center gap-1 p-2 bg-green-500/20 hover:bg-green-500/30 rounded-lg border border-green-500/30"><Icon name="check" className="w-4 h-4 md:w-5 md:h-5 text-green-400" /></button>
                    <button onClick={() => friendAction(targetUser.id, 'reject')} className="flex items-center gap-1 p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg border border-red-500/30"><Icon name="x" className="w-4 h-4 md:w-5 md:h-5 text-red-400" /></button>
                </div>
            );
        }
        return <button onClick={() => friendAction(targetUser.id, 'request')} className="flex items-center gap-1 p-2 bg-purple-500/20 hover:bg-purple-500/30 rounded-lg border border-purple-500/30 transition-all"><Icon name="userPlus" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" /></button>;
    };
    
    const UserListFriendButton = ({ targetUser }) => {
        const isFriend = friends.some(f => f.id === targetUser.id);
        const isRequestReceived = friendRequests.some(r => r.id === targetUser.id);
        const isRequestSent = sentRequests.includes(targetUser.id);

        if (isFriend) {
            return <button onClick={() => setConfirmingDeleteFriend(targetUser)} className="p-2 bg-green-500/20 hover:bg-red-500/20 rounded-lg transition-all"><Icon name="userCheck" className="w-5 h-5 text-green-400" /></button>;
        }
        if (isRequestReceived) {
            return (<div className="flex gap-2">
                <button onClick={() => setConfirmingAddFriend(targetUser)} className="p-2 bg-green-500/20 hover:bg-green-500/30 rounded-lg"><Icon name="check" className="w-5 h-5 text-green-400" /></button>
                <button onClick={() => friendAction(targetUser.id, 'reject')} className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg"><Icon name="x" className="w-5 h-5 text-red-400" /></button>
            </div>);
        }
        if (isRequestSent) {
            return <button onClick={() => friendAction(targetUser.id, 'reject')} className="p-2 bg-yellow-500/20 hover:bg-red-500/20 rounded-lg"><Icon name="userClock" className="w-5 h-5 text-yellow-400" /></button>;
        }
        return <button onClick={() => friendAction(targetUser.id, 'request')} className="p-2 bg-purple-500/20 hover:bg-purple-500/30 rounded-lg"><Icon name="userPlus" className="w-5 h-5 text-purple-400" /></button>;
    };

      const toggleColumnExpansion = (boardId) => {
        setExpandedColumns(prev => ({...prev, [boardId]: !prev[boardId]}));
      };

      if (showAuth) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
            <div className="bg-gray-900/90 backdrop-blur-xl rounded-2xl p-8 w-full max-w-md border border-purple-500/30 shadow-2xl">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4 animate-pulse">üéÆ</div>
                <h1 className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 mb-2">GameTracker</h1>
                <p className="text-gray-400 text-lg">–¢–≤–æ–π –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
              </div>
              <div className="flex gap-2 mb-6">
                <button onClick={() => { setAuthMode('login'); setError(''); }} className={`flex-1 py-3 rounded-lg font-semibold transition-all ${authMode === 'login' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>–í—Ö–æ–¥</button>
                <button onClick={() => { setAuthMode('register'); setError(''); }} className={`flex-1 py-3 rounded-lg font-semibold transition-all ${authMode === 'register' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
              </div>
              {error && <div className="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-sm">{error}</div>}
              <div className="space-y-4">
                <input type="text" placeholder="–õ–æ–≥–∏–Ω" value={formData.username} onChange={(e) => setFormData({ ...formData, username: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />
                <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" value={formData.password} onChange={(e) => setFormData({ ...formData, password: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />
                {authMode === 'register' && <input type="email" placeholder="Email" value={formData.email} onChange={(e) => setFormData({ ...formData, email: e.target.value })} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" />}
                <button onClick={handleAuth} disabled={loading} className={`w-full py-3 bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 text-white font-bold rounded-lg hover:from-purple-600 hover:via-pink-600 hover:to-blue-600 transition-all transform hover:scale-105 shadow-xl disabled:opacity-50 flex items-center justify-center gap-2 ${loading ? 'btn-loading' : ''}`}>
                  {loading ? <><Icon name="loader" className="w-5 h-5" />–ó–∞–≥—Ä—É–∑–∫–∞...</> : (authMode === 'login' ? 'üöÄ –í–æ–π—Ç–∏' : '‚ú® –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è')}
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className={`min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-blue-900 ${theme} flex flex-col`}>
          {/* Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
          <Toast 
            message={toast.message} 
            type={toast.type} 
            isVisible={toast.isVisible} 
            onClose={hideToast} 
          />
          
          {imageForCrop && <AvatarCropModal src={imageForCrop} onCancel={() => setImageForCrop(null)} onComplete={handleAvatarUpdate} />}
          {gameForReview && <DeepReviewModal game={gameForReview} existingAnswers={gameForReview.deep_review_answers} onClose={() => setGameForReview(null)} onSubmit={submitDeepReview} />}
          <StatisticsPage 
            isOpen={showStatistics} 
            onClose={() => setShowStatistics(false)} 
            token={localStorage.getItem('token')}
            showMediaTab={false}
          />
          
          <TagsManager 
            isOpen={showTagsManager} 
            onClose={() => setShowTagsManager(false)} 
            token={localStorage.getItem('token')}
            onTagsUpdate={() => {
              // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–≥–∏ –≤ –∏–≥—Ä–∞—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
              if (localStorage.getItem('token')) {
                loadBoards(localStorage.getItem('token'));
              }
            }}
          />
          
          <HistoryLog 
            isOpen={showHistoryLog} 
            onClose={() => setShowHistoryLog(false)} 
            gameId={historyGame?.id}
            gameName={historyGame?.name}
            token={localStorage.getItem('token')}
          />
          <header className="hidden md:block bg-gray-900/50 backdrop-blur-xl border-b border-purple-500/30 sticky top-0 z-50 flex-shrink-0">
            <div className="container mx-auto px-4 py-4">
              <div className="flex items-center justify-between flex-wrap gap-4">
                <div className="flex items-center gap-4 flex-wrap">
                  <button onClick={() => { window.location.href = './index.html'; }} className="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 active:scale-95 transition-transform cursor-pointer">üéÆ GameTracker</button>
                  {selectedTag && (
                    <div className="flex items-center gap-2">
                      <span className="text-gray-400">|</span>
                      <div className="flex items-center gap-2 px-3 py-1 bg-purple-500/20 border border-purple-500/30 rounded-full">
                        <span className="text-sm text-purple-400">–§–∏–ª—å—Ç—Ä:</span>
                        <span className="text-sm text-white font-medium">{selectedTag.name}</span>
                        <button
                          onClick={() => filterGamesByTag(selectedTag.id, selectedTag.name)}
                          className="text-purple-400 hover:text-purple-300 transition-colors"
                          title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä"
                        >
                          <Icon name="x" className="w-3 h-3" />
                        </button>
                      </div>
                    </div>
                  )}
                  {!viewingUser && (
                    <div className="relative flex items-center gap-2">
                      {/* –ö—Ä–∞—Å–∏–≤–∞—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */}
                      <div className="h-8 w-px bg-gradient-to-b from-transparent via-purple-400/80 to-transparent opacity-80"></div>
                      <a href="./movies.html" className="inline-flex items-center gap-2 active:scale-95 transition-transform">
                        <svg className="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                          <defs>
                            <linearGradient id="camGradHeaderReact" x1="0" y1="0" x2="1" y2="1">
                              <stop offset="0%" stopColor="#a78bfa"/>
                              <stop offset="100%" stopColor="#8b5cf6"/>
                            </linearGradient>
                          </defs>
                          <path fill="url(#camGradHeaderReact)" d="M4 7a3 3 0 0 0-3 3v4a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-.764l3.553 2.132A1 1 0 0 0 22 14.5v-5a1 1 0 0 0-1.447-.868L17 10.764V10a3 3 0 0 0-3-3H11l-.553-1.106A2 2 0 0 0 8.658 5H6a2 2 0 0 0-1.789 1.106L4 7Zm7 9a4 4 0 1 1 0-8 4 4 0 0 1 0 8Zm0-2.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
                        </svg>
                        <span className="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400">MovieTracker</span>
                      </a>
                      {showSearch && (
                        <div className="absolute top-full mt-2 left-0 w-80 md:w-96 bg-gray-800/95 backdrop-blur-xl rounded-lg border border-purple-500/30 p-4 z-50 elevation-4">
                          <div className="flex items-center gap-2 mb-3">
                            <input type="text" value={searchQuery} onChange={(e) => handleSearch(e.target.value)} placeholder="–ü–æ–∏—Å–∫ –∏–≥—Ä—ã..." className="flex-1 px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white text-sm" autoFocus />
                            <button onClick={() => { setShowSearch(false); setSearchQuery(''); setSearchResults([]); setTargetBoardForAdd(null); }} className="p-2 hover:bg-gray-700 rounded-lg">
                              <Icon name="x" className="w-5 h-5 text-gray-400" />
                            </button>
                          </div>
                          <div className="space-y-2 max-h-80 overflow-y-auto">
                            {searching ? (
                              <div className="flex items-center justify-center py-8">
                                <Icon name="loader" className="w-6 h-6 text-purple-400" />
                              </div>
                            ) : searchResults.length > 0 ? (
                              searchResults.map(game => (
                                <div key={game.id} className="flex items-center gap-3 p-2 hover:bg-gray-700 rounded-lg">
                                  {game.cover ? <img src={game.cover} alt={game.name} className="w-10 h-14 object-cover rounded" /> : <div className="w-10 h-14 bg-gray-700 rounded flex items-center justify-center text-xl">üéÆ</div>}
                                  <div className="flex-1 min-w-0">
                                    <p className="text-white font-semibold text-sm truncate">{game.name}</p>
                                    {game.genres && game.genres.length > 0 && <p className="text-xs text-gray-400 truncate">{game.genres.slice(0, 2).join(', ')}</p>}
                                  </div>
                                  {targetBoardForAdd ? (
                                    <button onClick={() => addGameToBoard(game, targetBoardForAdd)} className="p-2 bg-purple-500/80 hover:bg-purple-500 rounded-lg"><Icon name="plus" className="w-5 h-5 text-white" /></button>
                                  ) : (
                                    <select onChange={(e) => e.target.value && addGameToBoard(game, e.target.value)} className="px-2 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white cursor-pointer" defaultValue="">
                                        <option value="" disabled>+</option>
                                        {Object.values(boards).map(b => <option key={b.id} value={b.id}>{b.emoji} {b.title}</option>)}
                                    </select>
                                  )}
                                </div>
                              ))
                            ) : searchQuery.length >= 3 ? (
                              <p className="text-gray-400 text-center py-4 text-sm">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                            ) : (
                              <p className="text-gray-400 text-center py-4 text-sm">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</p>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2 md:gap-3">
                  <div className="flex items-center gap-2 px-3 md:px-4 py-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg border border-purple-500/30">
                    <Avatar src={viewingUser ? viewingUser.avatar : user?.avatar} size="sm" />
                    <div>
                      <span className="text-white font-semibold text-sm md:text-base block">{viewingUser ? (userNickname || viewingUser.username) : user?.username}</span>
                      {viewingUser && userNickname && <span className="text-xs text-gray-400">@{viewingUser.username}</span>}
                    </div>
                  </div>
                  {viewingUser ? (
                    <Fragment>
                      {friendshipStatus === 'friends' && (
                        <button onClick={() => setEditingNickname(true)} className="p-2 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg border border-blue-500/30">
                          <Icon name="tag" className="w-4 h-4 md:w-5 md:h-5 text-blue-400" />
                        </button>
                      )}
                      <FriendActionButton targetUser={viewingUser} />
                      <button onClick={() => { setViewingUser(null); loadBoards(localStorage.getItem('token')); }} className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700">
                        <Icon name="x" className="w-4 h-4 md:w-5 md:h-5 text-gray-400" />
                      </button>
                    </Fragment>
                  ) : (
                    <Fragment>
                      <button onClick={() => setShowStatistics(true)} className="p-2 hover:bg-gray-800 rounded-lg border border-purple-500/30" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä">
                        <Icon name="barChart" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" />
                      </button>
                      <button onClick={() => setShowProfile(true)} className="p-2 hover:bg-gray-800 rounded-lg border border-purple-500/30">
                        <Icon name="settings" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" />
                      </button>
                      <button onClick={() => { setShowUserHub(true); loadAllUsers(); }} className="p-2 hover:bg-gray-800 rounded-lg border border-purple-500/30 relative">
                        <Icon name="users" className="w-4 h-4 md:w-5 md:h-5 text-purple-400" />
                        {friendRequests.length > 0 && <span className="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white"></span>}
                      </button>
                    </Fragment>
                  )}
                  <NotificationsPanel 
                    token={localStorage.getItem('token')} 
                    onNavigateToUser={(userId) => {
                      setViewingUser({ id: userId });
                      loadBoards(localStorage.getItem('token'), userId);
                    }}
                    onNavigateToGame={(gameId) => {
                      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–≥—Ä–µ
                      console.log('Navigate to game:', gameId);
                    }}
                  />
                </div>
              </div>
            </div>
          </header>

          {/* –ú–æ–±–∏–ª—å–Ω—ã–π Header */}
          <header className="md:hidden bg-gray-900/50 backdrop-blur-xl border-b border-purple-500/30 sticky top-0 z-50">
            <div className="flex items-center justify-between px-4 py-3">
              {/* –õ–µ–≤–∞—è —á–∞—Å—Ç—å */}
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => setShowMobileMenu(true)} 
                  className="p-2 hover:bg-gray-800/50 rounded-lg"
                >
                  <Icon name="menu" className="w-6 h-6 text-white" />
                </button>
                <div className="flex items-center gap-2">
                  <span className="text-2xl">üéÆ</span>
                  <span className="text-lg font-bold text-white">GameTracker</span>
                </div>
              </div>

              {/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å */}
              <div className="flex items-center gap-2">
                <button className="p-2 relative hover:bg-gray-800/50 rounded-lg">
                  <Icon name="bell" className="w-5 h-5 text-purple-400" />
                  {friendRequests.length > 0 && (
                    <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                  )}
                </button>
                <button 
                  onClick={() => setShowMobileMenu(true)} 
                  className="p-1 hover:bg-gray-800/50 rounded-lg"
                >
                  <Avatar src={user?.avatar} size="sm" />
                </button>
              </div>
            </div>
          </header>

          {/* –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é (Sidebar) */}
          {showMobileMenu && (
            <>
              {/* Backdrop */}
              <div 
                className="fixed inset-0 bg-black/60 z-40"
                onClick={() => setShowMobileMenu(false)}
              />
              
              {/* Sidebar */}
              <div className="fixed top-0 left-0 h-full w-72 bg-gray-900 z-50 p-6 overflow-y-auto transform transition-transform">
                {/* –ü—Ä–æ—Ñ–∏–ª—å */}
                <div className="flex items-center gap-3 mb-6 pb-6 border-b border-gray-700">
                  <Avatar src={user?.avatar} size="lg" />
                  <div>
                    <p className="text-white font-semibold">{user?.username}</p>
                    <p className="text-sm text-gray-400">{user?.email}</p>
                  </div>
                </div>

                {/* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π */}
                <div className="mb-6">
                  <p className="text-xs text-gray-500 mb-2">–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø</p>
                  <button 
                    onClick={() => {window.location.href = '/index.html'; setShowMobileMenu(false);}}
                    className="w-full flex items-center gap-3 px-3 py-2 rounded-lg mb-2 bg-purple-500/20 text-purple-400"
                  >
                    üéÆ <span>GameTracker</span>
                  </button>
                  <button 
                    onClick={() => {window.location.href = '/movies.html'; setShowMobileMenu(false);}}
                    className="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-800"
                  >
                    üé¨ <span>MovieTracker</span>
                  </button>
                </div>

                {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
                <div className="space-y-2 mb-6">
                  <button 
                    onClick={() => {setShowUserHub(true); setShowMobileMenu(false);}} 
                    className="w-full flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-800 rounded-lg"
                  >
                    üë• <span>–î—Ä—É–∑—å—è</span>
                    {friendRequests.length > 0 && (
                      <span className="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{friendRequests.length}</span>
                    )}
                  </button>
                  <button 
                    onClick={() => {setShowStatistics(true); setShowMobileMenu(false);}} 
                    className="w-full flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-800 rounded-lg"
                  >
                    üìä <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                  </button>
                  <button 
                    onClick={() => {setShowProfile(true); setShowMobileMenu(false);}} 
                    className="w-full flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-800 rounded-lg"
                  >
                    ‚öôÔ∏è <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                  </button>
                </div>

                {/* –í—ã—Ö–æ–¥ */}
                <button 
                  onClick={() => {handleLogout(); setShowMobileMenu(false);}} 
                  className="w-full flex items-center gap-3 px-3 py-2 text-red-400 hover:bg-red-500/10 rounded-lg"
                >
                  üö™ <span>–í—ã–π—Ç–∏</span>
                </button>
              </div>
            </>
          )}

          <main className="flex-grow">
              {showProfile && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 modal-enter-active">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 max-h-[90vh] overflow-y-auto elevation-3">
                      <h2 className="text-2xl font-bold text-white mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                      <div className="space-y-4">
                      <div className="flex flex-col items-center gap-3">
                          <Avatar src={user?.avatar} size="xl" />
                          <input type="file" ref={fileInputRef} onChange={handleFileSelect} accept="image/*" className="hidden" />
                          <button onClick={() => fileInputRef.current?.click()} disabled={uploadingAvatar} className="flex items-center gap-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-all disabled:opacity-50">
                          {uploadingAvatar ? <Icon name="loader" className="w-4 h-4" /> : <Icon name="upload" className="w-4 h-4" />}
                          {uploadingAvatar ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä'}
                          </button>
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                          <input type="text" value={profileData.username} onChange={(e) => setProfileData({ ...profileData, username: e.target.value })} placeholder={user?.username} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–û —Å–µ–±–µ:</label>
                          <textarea value={profileData.bio} onChange={(e) => setProfileData({ ...profileData, bio: e.target.value })} placeholder={user?.bio || "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" rows="3" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:</label>
                          <div className="flex gap-2 mt-1">
                              <button onClick={() => setTheme('default')} className={`flex-1 py-2 rounded-lg text-sm ${theme === 'default' ? 'bg-purple-500 text-white' : 'bg-gray-800'}`}>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                              <button onClick={() => setTheme('liquid-eye')} className={`flex-1 py-2 rounded-lg text-sm ${theme === 'liquid-eye' ? 'bg-white text-black' : 'bg-gray-800'}`}>Liquid Eye</button>
                          </div>
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å (–¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è):</label>
                          <input type="password" value={profileData.currentPassword} onChange={(e) => setProfileData({ ...profileData, currentPassword: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      <div>
                          <label className="text-gray-400 text-sm">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                          <input type="password" value={profileData.newPassword} onChange={(e) => setProfileData({ ...profileData, newPassword: e.target.value })} className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mt-1" />
                      </div>
                      
                      {/* –°–µ–∫—Ü–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ */}
                      <div className="mt-6">
                          <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                              <Icon name="shield" className="w-5 h-5 text-blue-400" />
                              –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å
                          </h3>
                          <div className="space-y-4">
                              {/* –ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å */}
                              <div className="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                                  <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-1">
                                          <span className="text-white font-medium">–ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                                          <Icon name="globe" className="w-4 h-4 text-green-400" />
                                      </div>
                                      <p className="text-xs text-gray-400">–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à–∏ –¥–æ—Å–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
                                  </div>
                                  <label className="relative inline-flex items-center cursor-pointer">
                                      <input 
                                          type="checkbox" 
                                          checked={privacySettings.is_profile_public}
                                          onChange={(e) => updatePrivacySettings('is_profile_public', e.target.checked)}
                                          className="sr-only peer"
                                      />
                                      <div className="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                  </label>
                              </div>

                              {/* –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å */}
                              <div className="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                                  <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-1">
                                          <span className="text-white font-medium">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
                                          <Icon name="activity" className="w-4 h-4 text-blue-400" />
                                      </div>
                                      <p className="text-xs text-gray-400">–î—Ä—É–∑—å—è –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à–∏ –Ω–µ–¥–∞–≤–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –ª–µ–Ω—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                                  </div>
                                  <label className="relative inline-flex items-center cursor-pointer">
                                      <input 
                                          type="checkbox" 
                                          checked={privacySettings.show_activity}
                                          onChange={(e) => updatePrivacySettings('show_activity', e.target.checked)}
                                          className="sr-only peer"
                                      />
                                      <div className="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                  </label>
                              </div>

                              {/* –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É */}
                              <div className="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                                  <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-1">
                                          <span className="text-white font-medium">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</span>
                                          <Icon name="barChart" className="w-4 h-4 text-purple-400" />
                                      </div>
                                      <p className="text-xs text-gray-400">–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä –∏ —Ñ–∏–ª—å–º–æ–≤</p>
                                  </div>
                                  <label className="relative inline-flex items-center cursor-pointer">
                                      <input 
                                          type="checkbox" 
                                          checked={privacySettings.show_stats}
                                          onChange={(e) => updatePrivacySettings('show_stats', e.target.checked)}
                                          className="sr-only peer"
                                      />
                                      <div className="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                  </label>
                              </div>

                              {/* –ü—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è */}
                              <div className="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                                  <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-1">
                                          <span className="text-white font-medium">–ü—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è</span>
                                          <Icon name="userPlus" className="w-4 h-4 text-green-400" />
                                      </div>
                                      <p className="text-xs text-gray-400">–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤–∞–º –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è</p>
                                  </div>
                                  <label className="relative inline-flex items-center cursor-pointer">
                                      <input 
                                          type="checkbox" 
                                          checked={privacySettings.allow_friend_requests}
                                          onChange={(e) => updatePrivacySettings('allow_friend_requests', e.target.checked)}
                                          className="sr-only peer"
                                      />
                                      <div className="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                  </label>
                              </div>
                          </div>
                      </div>
                      <div className="mt-6">
                          <button 
                              onClick={() => setShowTagsManager(true)} 
                              className="w-full py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-lg transition-colors flex items-center justify-center gap-2 mb-4"
                          >
                              <Icon name="tag" className="w-4 h-4" />
                              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏
                          </button>
                      </div>
                      <div className="mt-4 pt-4 border-t border-gray-700">
                        <button onClick={handleLogout} className="w-full py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg flex items-center justify-center gap-2">
                          <Icon name="logout" className="w-4 h-4" />
                          –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                        </button>
                      </div>
                      <div className="flex gap-2 mt-6">
                          <button onClick={updateProfile} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg hover:from-purple-600 hover:to-pink-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                          <button onClick={() => setShowProfile(false)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                      </div>
                      </div>
                  </div>
                  </div>
              )}
              
              {editingNickname && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 elevation-3">
                      <h2 className="text-xl font-bold text-white mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–∫—É –¥–ª—è {viewingUser?.username}</h2>
                      <input type="text" value={userNickname} onChange={(e) => setUserNickname(e.target.value)} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ—É—á—à–∏–π –¥—Ä—É–≥, –ö–æ–ª–ª–µ–≥–∞..." className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mb-4" />
                      <div className="flex gap-2">
                      <button onClick={() => updateNickname(viewingUser.id, userNickname)} className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                      <button onClick={() => setEditingNickname(false)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg">–û—Ç–º–µ–Ω–∞</button>
                      </div>
                  </div>
                  </div>
              )}

              {showUserHub && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-3xl border border-purple-500/30 max-h-[80vh] flex flex-col elevation-3">
                      <div className="flex justify-between items-center mb-4 flex-shrink-0">
                      <h2 className="text-2xl font-bold text-white">–°–æ–æ–±—â–µ—Å—Ç–≤–æ</h2>
                      <button onClick={() => setShowUserHub(false)} className="p-2 hover:bg-gray-800 rounded-lg"><Icon name="x" className="w-5 h-5 text-gray-400" /></button>
                      </div>
                      
                      <div className="overflow-y-auto">
                          {friendRequests.length > 0 && (
                              <div className="mb-6">
                                  <h3 className="text-lg font-bold text-white mb-3">–ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è ({friendRequests.length})</h3>
                                  <div className="space-y-3">
                                      {friendRequests.map(req => (
                                          <div key={req.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                                              <Avatar src={req.avatar} size="md" />
                                              <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), req.id); setShowUserHub(false); }}>
                                                  <p className="text-white font-semibold">{req.username}</p>
                                              </div>
                                              <UserListFriendButton targetUser={req} />
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          )}

                          {friends.length > 0 && (
                          <div className="mb-6">
                              <h3 className="text-lg font-bold text-white mb-3">–ú–æ–∏ –¥—Ä—É–∑—å—è ({friends.length})</h3>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {friends.map(friend => (
                                  <div key={friend.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg group">
                                  <Avatar src={friend.avatar} size="md" />
                                  <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), friend.id); setShowUserHub(false); }}>
                                      <p className="text-white font-semibold">{friend.nickname || friend.username}</p>
                                      {friend.nickname && <p className="text-xs text-gray-400">@{friend.username}</p>}
                                  </div>
                                  <button onClick={() => setConfirmingDeleteFriend(friend)} className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="x" className="w-5 h-5 text-red-400" /></button>
                                  </div>
                              ))}
                              </div>
                          </div>
                          )}

                          <div>
                          <h3 className="text-lg font-bold text-white mb-3">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                          <input type="text" value={userSearchQuery} onChange={(e) => { setUserSearchQuery(e.target.value); loadAllUsers(e.target.value); }} placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white mb-4" />
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {allUsers.map(u => (
                              <div key={u.id} className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                                  <Avatar src={u.avatar} size="md" />
                                  <div className="flex-1 cursor-pointer" onClick={() => { loadBoards(localStorage.getItem('token'), u.id); setShowUserHub(false); }}>
                                  <p className="text-white font-semibold">{u.username}</p>
                                  </div>
                                  <UserListFriendButton targetUser={u} />
                              </div>
                              ))}
                          </div>
                          </div>
                      </div>
                  </div>
                  </div>
              )}

              {selectedGame && (
                <GameModal 
                  game={selectedGame} 
                  onClose={() => setSelectedGame(null)} 
                  onUpdate={updateGame}
                  onReact={addReaction}
                  isViewingFriend={!!viewingUser}
                  user={user}
                  token={localStorage.getItem('token')}
                  onRemoveTag={removeTagFromGame}
                  onFilterByTag={filterGamesByTag}
                  onOpenTagModal={openTagModal}
                />
              )}
              
              {confirmingDeleteFriend && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-red-500/30">
                      <h2 className="text-xl font-bold text-white mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
                      <p className="text-gray-300 mb-6">
                      –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <span className="font-bold text-white">{confirmingDeleteFriend.username}</span> –∏–∑ –¥—Ä—É–∑–µ–π?
                      </p>
                      <div className="flex gap-2">
                      <button onClick={() => { friendAction(confirmingDeleteFriend.id, 'remove'); setConfirmingDeleteFriend(null); }}
                          className="flex-1 py-2 bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold rounded-lg hover:from-red-600 hover:to-orange-600">
                          –£–¥–∞–ª–∏—Ç—å
                      </button>
                      <button onClick={() => setConfirmingDeleteFriend(null)} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                      </div>
                  </div>
                  </div>
              )}

              {confirmingAddFriend && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                  <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-green-500/30">
                      <h2 className="text-xl font-bold text-white mb-4">–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è</h2>
                      <p className="text-gray-300 mb-6">
                      –ü—Ä–∏–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç <span className="font-bold text-white">{confirmingAddFriend.username}</span>?
                      </p>
                      <div className="flex gap-2">
                      <button onClick={() => { friendAction(confirmingAddFriend.id, 'accept'); setConfirmingAddFriend(null); }}
                          className="flex-1 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-lg hover:from-green-600 hover:to-emerald-600">
                          –ü—Ä–∏–Ω—è—Ç—å
                      </button>
                      <button onClick={() => {friendAction(confirmingAddFriend.id, 'reject'); setConfirmingAddFriend(null); }} className="flex-1 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                      </div>
                  </div>
                  </div>
              )}

              <div className="container mx-auto px-4 py-6">
                  {viewingUser && (
                  <div className="mb-6 bg-gradient-to-r from-purple-900/50 to-blue-900/50 backdrop-blur-xl rounded-xl p-6 border border-purple-500/30">
                      <div className="flex items-center gap-4">
                      <Avatar src={viewingUser.avatar} size="lg" />
                      <div className="flex-1">
                          <h2 className="text-3xl font-bold text-white">{userNickname || viewingUser.username}</h2>
                          {userNickname && <p className="text-gray-400">@{viewingUser.username}</p>}
                          {viewingUser.bio && <p className="text-gray-300 mt-2">{viewingUser.bio}</p>}
                      </div>
                      </div>
                  </div>
                  )}

                  {/* –ü–æ–∏—Å–∫ –ø–æ —Å–≤–æ–∏–º –∏–≥—Ä–∞–º */}
                  {!viewingUser && (
                    <>
                      {/* –ú–æ–±–∏–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ */}
                      <div className="md:hidden px-4 mb-4">
                        <div className="relative">
                          <Icon 
                            name="search" 
                            className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" 
                          />
                          <input
                            type="text"
                            placeholder="–ù–∞–π—Ç–∏ –≤ –º–æ–∏—Ö –∏–≥—Ä–∞—Ö..."
                            value={myGamesSearchQuery}
                            onChange={(e) => {
                              setMyGamesSearchQuery(e.target.value);
                              debouncedSearchMyGames(e.target.value);
                            }}
                            className="w-full pl-10 pr-4 py-2.5 bg-gray-800/80 border border-gray-700 rounded-lg text-white text-sm placeholder-gray-500 focus:border-purple-500 focus:outline-none"
                          />
                        </div>
                      </div>

                      {/* –î–µ—Å–∫—Ç–æ–ø–Ω—ã–π –ø–æ–∏—Å–∫ */}
                      <div className="hidden md:block mb-6">
                        <div className="relative">
                          <input
                            type="text"
                            placeholder="–ù–∞–π—Ç–∏ –≤ –º–æ–∏—Ö –∏–≥—Ä–∞—Ö..."
                            value={myGamesSearchQuery}
                            onChange={(e) => {
                              setMyGamesSearchQuery(e.target.value);
                              debouncedSearchMyGames(e.target.value);
                            }}
                            className="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500 backdrop-blur-xl"
                          />
                        {myGamesSearchQuery && (
                          <button
                            onClick={() => {
                              setMyGamesSearchQuery('');
                              setMyGamesSearchResults([]);
                              setShowMyGamesSearch(false);
                            }}
                            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors"
                          >
                            <Icon name="x" className="w-5 h-5" />
                          </button>
                        )}
                        {myGamesSearching && (
                          <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
                            <Icon name="loader" className="w-5 h-5 text-purple-400 animate-spin" />
                          </div>
                        )}
                      </div>
                    </div>
                    </>
                  )}

                  <div className="hidden md:grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  {boardsLoading ? (
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω—ã –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
                    <>
                      <ColumnSkeleton />
                      <ColumnSkeleton />
                      <ColumnSkeleton />
                      <ColumnSkeleton />
                    </>
                  ) : showMyGamesSearch ? (
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ —Å–≤–æ–∏–º –∏–≥—Ä–∞–º
                    <div className="col-span-full">
                      <div className="mb-4 flex items-center justify-between">
                        <h3 className="text-lg font-semibold text-white">
                          –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ ({myGamesSearchResults.length})
                        </h3>
                        <button
                          onClick={() => {
                            setMyGamesSearchQuery('');
                            setMyGamesSearchResults([]);
                            setShowMyGamesSearch(false);
                          }}
                          className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center gap-2"
                        >
                          <Icon name="x" className="w-4 h-4" />
                          –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫
                        </button>
                      </div>
                      
                      {/* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ */}
                      <div className="md:hidden space-y-3">
                        {myGamesSearchResults.map(game => (
                          <div key={game.id} className="bg-gray-800/80 rounded-xl p-3 border border-gray-700">
                            <div className="flex gap-3">
                              <img 
                                src={game.cover} 
                                alt={game.name}
                                className="w-16 h-24 object-cover rounded-lg flex-shrink-0"
                              />
                              <div className="flex-1 min-w-0">
                                <h3 className="text-white font-semibold text-sm line-clamp-2 mb-1">
                                  {game.name}
                                </h3>
                                <p className="text-gray-400 text-xs mb-2">
                                  {boards[game.board_id]?.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞'}
                                </p>
                                <div className="flex gap-1">
                                  <button
                                    onClick={() => {
                                      setSelectedGame(game);
                                      setShowMyGamesSearch(false);
                                    }}
                                    className="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg transition-colors"
                                  >
                                    –û—Ç–∫—Ä—ã—Ç—å
                                  </button>
                                  <button
                                    onClick={() => deleteCard(null, game.id)}
                                    className="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded-lg transition-colors"
                                  >
                                    –£–¥–∞–ª–∏—Ç—å
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>

                      {/* –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ */}
                      <div className="hidden md:grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {myGamesSearchResults.map(game => (
                          <div key={game.id} className="bg-gray-800/50 backdrop-blur-xl rounded-lg p-4 border border-gray-700 hover:border-purple-500/50 transition-colors">
                            <div className="flex items-start gap-3">
                              <img 
                                src={game.cover} 
                                alt={game.name}
                                className="w-12 h-16 object-cover rounded-lg flex-shrink-0"
                                onError={(e) => { e.target.src = '/placeholder-game.png'; }}
                              />
                              <div className="flex-1 min-w-0">
                                <h4 className="text-white font-semibold text-sm truncate" 
                                    dangerouslySetInnerHTML={{ 
                                      __html: game.name.replace(
                                        new RegExp(`(${myGamesSearchQuery})`, 'gi'), 
                                        '<mark class="bg-yellow-400 text-black px-1 rounded">$1</mark>'
                                      )
                                    }}
                                />
                                <div className="flex items-center gap-2 mt-1">
                                  <span className="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">
                                    {game.board === 'backlog' ? 'üìã –ë–µ–∫–ª–æ–≥' :
                                     game.board === 'playing' ? 'üéÆ –ò–≥—Ä–∞—é' :
                                     game.board === 'completed' ? '‚úÖ –ü—Ä–æ—à—ë–ª' :
                                     game.board === 'dropped' ? '‚ùå –ë—Ä–æ—Å–∏–ª' : game.board}
                                  </span>
                                  {game.rating && (
                                    <div className="flex gap-0.5">
                                      {[...Array(5)].map((_, i) => (
                                        <Icon key={i} name="star" className={`w-3 h-3 ${i < game.rating ? 'text-yellow-400' : 'text-gray-600'}`} />
                                      ))}
                                    </div>
                                  )}
                                </div>
                                {game.notes && (
                                  <p className="text-xs text-gray-300 mt-2 line-clamp-2">
                                    {game.notes.length > 100 ? `${game.notes.substring(0, 100)}...` : game.notes}
                                  </p>
                                )}
                              </div>
                            </div>
                          </div>
                        ))}
                        {myGamesSearchResults.length === 0 && !myGamesSearching && (
                          <div className="col-span-full text-center py-8">
                            <div className="text-4xl mb-2">üîç</div>
                            <p className="text-gray-400">–ò–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p className="text-sm text-gray-500 mt-1">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</p>
                          </div>
                        )}
                      </div>
                    </div>
                  ) : viewingUser && viewingUser.is_profile_public === false && friendshipStatus !== 'friends' ? (
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–º–æ–∫ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
                    <div className="col-span-full flex flex-col items-center justify-center py-16">
                      <div className="text-6xl mb-4">üîí</div>
                      <h3 className="text-xl font-semibold text-white mb-2">–ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π</h3>
                      <p className="text-gray-400 text-center max-w-md">
                        {viewingUser.username} –æ–≥—Ä–∞–Ω–∏—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–µ–º—É –ø—Ä–æ—Ñ–∏–ª—é. 
                        –¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –µ–≥–æ –¥–æ—Å–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
                      </p>
                    </div>
                  ) : (
                    Object.values(boards).map(board => {
                      const isExpanded = !!expandedColumns[board.id];
                      const visibleCards = isExpanded ? board.cards : board.cards.slice(0, GAMES_PER_COLUMN);

                      return (
                      <div key={board.id} 
                          onDragOver={handleDragOver}
                          onDragEnter={handleDragEnterColumn}
                          onDragLeave={handleDragLeaveColumn}
                          onDrop={(e) => !viewingUser && handleDrop(e, board.id, undefined)} 
                          className={`bg-gradient-to-br ${board.color} backdrop-blur-xl rounded-xl p-5 border ${board.borderColor} flex flex-col transition-colors elevation-1 board-column`}>
                          <div className="flex items-center justify-between mb-4">
                            <h2 className="text-lg md:text-2xl font-extrabold text-white flex items-center gap-2 tracking-wide whitespace-nowrap">
                                <span className="text-xl md:text-2xl">{board.emoji}</span>
                                <span className="hidden sm:inline">{board.title}</span>
                            </h2>
                            <div className="flex items-center gap-2">
                                {!viewingUser && (
                                <button 
                                    onClick={() => { setTargetBoardForAdd(board.id); setShowSearch(true); }}
                                    className="p-1.5 bg-white/10 hover:bg-white/20 rounded-full transition-colors">
                                    <Icon name="plus" className="w-4 h-4 text-white"/>
                                </button>
                                )}
                            </div>
                          </div>
                          
                          <div className="space-y-3 flex-grow min-h-[100px]">
                          {visibleCards.map((card, index) => (
                              <div key={card.id} 
                                  draggable={!viewingUser}
                                  onDragStart={(e) => handleDragStart(e, card, board.id, index)}
                                  onDragEnd={handleDragEnd}
                                  onDrop={(e) => !viewingUser && handleDrop(e, board.id, index)}
                                  onDragEnter={handleDragEnterCard}
                                  onDragLeave={handleDragLeaveCard}
                                  className="bg-gray-800/80 rounded-xl border border-gray-700 hover:border-purple-500 hover:-translate-y-1 transition-all duration-200 cursor-pointer flex gap-3 p-2 group relative elevation-1 hover:elevation-2 shadow-transition game-card" 
                                  onClick={() => setSelectedGame(card)}>
                                  
                                  {/* –¶–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å–ª–µ–≤–∞ */}
                                  <div 
                                    className="w-1 rounded-l-xl flex-shrink-0" 
                                    style={{ backgroundColor: board.accentColor }}
                                  ></div>
                              
                              <div className="relative flex-shrink-0">
                                  {card.cover ? 
                                      <img src={card.cover} alt={card.name} className="w-24 h-32 md:w-20 md:h-28 object-cover rounded-lg flex-shrink-0" /> : 
                                      <div className="w-24 h-32 md:w-20 md:h-28 bg-gray-700 rounded-lg flex items-center justify-center text-2xl flex-shrink-0">üéÆ</div>
                                  }
                              </div>
                              <div className="flex flex-col justify-between flex-grow min-w-0 py-1">
                                  <div>
                                      <h3 className="text-white font-semibold text-base md:text-sm line-clamp-2">{card.name}</h3>
                                      {/* –†–µ–π—Ç–∏–Ω–≥ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º */}
                                      {card.rating && (
                                          <div className="flex gap-0.5 mt-1">
                                              {[...Array(5)].map((_, i) => (
                                                  <Icon 
                                                      key={i} 
                                                      name="star" 
                                                      className={`w-3 h-3 ${i < card.rating ? 'text-yellow-400' : 'text-gray-500'}`} 
                                                  />
                                              ))}
                                          </div>
                                      )}
                                  </div>
                                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity self-end flex-shrink-0 z-10">
                                    </div>
                              </div>
                              {!viewingUser ? (
                                  <button onClick={(e) => deleteCard(e, card.id)} className="absolute top-1 right-1 p-1.5 bg-red-600/80 hover:bg-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity self-start flex-shrink-0 z-10">
                                      <Icon name="trash" className="w-3 h-3 text-white" />
                                  </button>
                              ) : (
                                  <button onClick={(e) => {
                                      e.stopPropagation();
                                      setCardToAdd(card);
                                      setShowAddToMyBoard(true);
                                  }} className="absolute top-1 right-1 p-1.5 bg-green-600/80 hover:bg-green-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity self-start flex-shrink-0 z-10" title="–î–æ–±–∞–≤–∏—Ç—å –∫ —Å–µ–±–µ">
                                      <Icon name="plus" className="w-3 h-3 text-white" />
                                  </button>
                              )}
                              </div>
                          ))}
                          
                          {board.cards.length === 0 && (
                            <div className="flex flex-col items-center justify-center py-12 text-center">
                              <div className="w-16 h-16 mb-4 flex items-center justify-center">
                                {board.id === 'backlog' && (
                                  <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                      <linearGradient id="backlogGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor: '#8B5CF6', stopOpacity: 0.8}} />
                                        <stop offset="100%" style={{stopColor: '#3B82F6', stopOpacity: 0.6}} />
                                      </linearGradient>
                                    </defs>
                                    <path d="M9 12H15M9 16H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H17C18.1046 3 19 3.89543 19 5V19C19 20.1046 18.1046 21 17 21Z" stroke="url(#backlogGrad)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                  </svg>
                                )}
                                {board.id === 'playing' && (
                                  <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                      <linearGradient id="playingGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor: '#F59E0B', stopOpacity: 0.8}} />
                                        <stop offset="100%" style={{stopColor: '#EF4444', stopOpacity: 0.6}} />
                                      </linearGradient>
                                    </defs>
                                    <path d="M8 5L20 12L8 19V5Z" stroke="url(#playingGrad)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                    <circle cx="8" cy="12" r="2" fill="url(#playingGrad)" opacity="0.3"/>
                                  </svg>
                                )}
                                {board.id === 'completed' && (
                                  <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                      <linearGradient id="completedGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor: '#10B981', stopOpacity: 0.8}} />
                                        <stop offset="100%" style={{stopColor: '#059669', stopOpacity: 0.6}} />
                                      </linearGradient>
                                    </defs>
                                    <path d="M20 6L9 17L4 12" stroke="url(#completedGrad)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                    <circle cx="20" cy="6" r="2" fill="url(#completedGrad)" opacity="0.3"/>
                                  </svg>
                                )}
                                {board.id === 'dropped' && (
                                  <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                      <linearGradient id="droppedGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor: '#6B7280', stopOpacity: 0.8}} />
                                        <stop offset="100%" style={{stopColor: '#374151', stopOpacity: 0.6}} />
                                      </linearGradient>
                                    </defs>
                                    <path d="M18 6L6 18M6 6L18 18" stroke="url(#droppedGrad)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                    <circle cx="12" cy="12" r="10" stroke="url(#droppedGrad)" strokeWidth="1" fill="none" opacity="0.3"/>
                                  </svg>
                                )}
                              </div>
                              <p className="text-gray-400 text-lg mb-2">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ</p>
                              <p className="text-gray-500 text-sm mb-4">
                                {board.id === 'backlog' && '–î–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏'}
                                {board.id === 'playing' && '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–≥—Ä—ã –≤ –∫–æ—Ç–æ—Ä—ã–µ –∏–≥—Ä–∞–µ—Ç–µ'}
                                {board.id === 'completed' && '–°—é–¥–∞ –ø–æ–ø–∞–¥—É—Ç –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã üéâ'}
                                {board.id === 'dropped' && '–ò–≥—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∑–∞—à–ª–∏'}
                              </p>
                              {!viewingUser && board.id === 'backlog' && (
                                <button 
                                  onClick={() => setShowSearch(true)}
                                  className="px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg text-white text-sm transition-colors"
                                >
                                  + –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∏–≥—Ä—É
                                </button>
                              )}
                            </div>
                          )}
                          </div>

                          {board.cards.length > GAMES_PER_COLUMN && (
                              <button onClick={() => toggleColumnExpansion(board.id)} className="w-full text-center mt-3 py-1.5 text-xs font-semibold text-purple-300 bg-purple-500/10 hover:bg-purple-500/20 rounded-lg flex items-center justify-center gap-1">
                              {isExpanded ? '–°–≤–µ—Ä–Ω—É—Ç—å' : `–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ ${board.cards.length - GAMES_PER_COLUMN}`}
                              <Icon name={isExpanded ? 'chevronUp' : 'chevronDown'} className="w-3 h-3" />
                              </button>
                          )}
                      </div>
                      );
                    })
                  )}
                  </div>

                  {/* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∫–æ–ª–æ–Ω–æ–∫ */}
                  <div className="md:hidden">
                    {Object.values(boards).map(board => (
                      <div key={board.id} className="mb-6">
                        {/* –ó–ê–ì–û–õ–û–í–û–ö –ö–û–õ–û–ù–ö–ò */}
                        <div className="flex items-center justify-between px-4 mb-3">
                          <div className="flex items-center gap-2">
                            <span className="text-2xl">{board.emoji}</span>
                            <h2 className="text-lg font-bold text-white">{board.title}</h2>
                          </div>
                          {!viewingUser && (
                            <button 
                              onClick={() => {setTargetBoardForAdd(board.id); setShowSearch(true);}}
                              className="p-1.5 bg-white/10 hover:bg-white/20 rounded-full"
                            >
                              <Icon name="plus" className="w-4 h-4 text-white" />
                            </button>
                          )}
                        </div>

                        {/* –ö–ê–†–¢–û–ß–ö–ò */}
                        <div className="px-4 space-y-3">
                          {board.cards.slice(0, expandedBoards[board.id] ? undefined : 3).map(card => (
                            <div 
                              key={card.id} 
                              className="bg-gray-800/80 rounded-xl p-3 border-l-4 cursor-pointer hover:bg-gray-700/80 transition-colors" 
                              style={{borderColor: board.accentColor}}
                              onClick={() => handleMobileCardClick(card)}
                            >
                              <div className="flex gap-3">
                                {/* Cover - –º–µ–Ω—å—à–µ —Ä–∞–∑–º–µ—Ä–æ–º */}
                                <img 
                                  src={card.cover || 'https://placehold.co/64x96/1f2937/ffffff?text=üéÆ'} 
                                  className="w-16 h-24 object-cover rounded-lg flex-shrink-0"
                                  alt={card.name}
                                />
                                
                                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                                <div className="flex-1 min-w-0">
                                  {/* –ù–∞–∑–≤–∞–Ω–∏–µ */}
                                  <h3 className="text-white font-semibold text-sm line-clamp-2 mb-1">
                                    {card.name}
                                  </h3>
                                  
                                  {/* –†–µ–π—Ç–∏–Ω–≥ */}
                                  {card.rating && (
                                    <div className="flex gap-0.5 mb-2">
                                      {[...Array(5)].map((_, i) => (
                                        <Icon 
                                          key={i} 
                                          name="star" 
                                          className={`w-3 h-3 ${i < card.rating ? 'text-yellow-400' : 'text-gray-600'}`} 
                                        />
                                      ))}
                                    </div>
                                  )}
                                  
                                  {/* –†–µ–∞–∫—Ü–∏–∏ */}
                                  {card.reactions?.length > 0 && (
                                    <div className="flex gap-1 flex-wrap">
                                      {Object.entries(groupReactions(card.reactions)).map(([emoji, data]) => (
                                        <ReactionGroup
                                          key={emoji}
                                          emoji={emoji}
                                          count={data.count}
                                          users={data.users}
                                          onReactionClick={(emoji) => addReaction(card.id, emoji)}
                                        />
                                      ))}
                                    </div>
                                  )}
                                </div>
                                
                                {/* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é (3 —Ç–æ—á–∫–∏) */}
                                <button 
                                  onClick={(e) => {e.stopPropagation(); openCardMenu(card);}}
                                  className="self-start p-1 hover:bg-white/10 rounded"
                                >
                                  <Icon name="moreVertical" className="w-5 h-5 text-gray-400" />
                                </button>
                              </div>
                            </div>
                          ))}
                          
                          {board.cards.length === 0 && (
                            <div className="flex flex-col items-center justify-center py-12 text-center">
                              <div className="w-16 h-16 mb-4 flex items-center justify-center">
                                {board.id === 'backlog' && (
                                  <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                      <linearGradient id="backlogGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor: '#8B5CF6', stopOpacity: 0.8}} />
                                        <stop offset="100%" style={{stopColor: '#3B82F6', stopOpacity: 0.6}} />
                                      </linearGradient>
                                    </defs>
                                    <path d="M9 12H15M9 16H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H17C18.1046 3 19 3.89543 19 5V19C19 20.1046 18.1046 21 17 21Z" stroke="url(#backlogGrad)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                  </svg>
                                )}
                                {board.id === 'playing' && (
                                  <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                      <linearGradient id="playingGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor: '#F59E0B', stopOpacity: 0.8}} />
                                        <stop offset="100%" style={{stopColor: '#EF4444', stopOpacity: 0.6}} />
                                      </linearGradient>
                                    </defs>
                                    <path d="M8 5L20 12L8 19V5Z" stroke="url(#playingGrad)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                    <circle cx="8" cy="12" r="2" fill="url(#playingGrad)" opacity="0.3"/>
                                  </svg>
                                )}
                                {board.id === 'completed' && (
                                  <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                      <linearGradient id="completedGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor: '#10B981', stopOpacity: 0.8}} />
                                        <stop offset="100%" style={{stopColor: '#059669', stopOpacity: 0.6}} />
                                      </linearGradient>
                                    </defs>
                                    <path d="M20 6L9 17L4 12" stroke="url(#completedGrad)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                    <circle cx="20" cy="6" r="2" fill="url(#completedGrad)" opacity="0.3"/>
                                  </svg>
                                )}
                                {board.id === 'dropped' && (
                                  <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                      <linearGradient id="droppedGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor: '#6B7280', stopOpacity: 0.8}} />
                                        <stop offset="100%" style={{stopColor: '#374151', stopOpacity: 0.6}} />
                                      </linearGradient>
                                    </defs>
                                    <path d="M18 6L6 18M6 6L18 18" stroke="url(#droppedGrad)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                    <circle cx="12" cy="12" r="10" stroke="url(#droppedGrad)" strokeWidth="1" fill="none" opacity="0.3"/>
                                  </svg>
                                )}
                              </div>
                              <p className="text-gray-400 text-lg mb-2">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ</p>
                              <p className="text-gray-500 text-sm mb-4">
                                {board.id === 'backlog' && '–î–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏'}
                                {board.id === 'playing' && '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–≥—Ä—ã –≤ –∫–æ—Ç–æ—Ä—ã–µ –∏–≥—Ä–∞–µ—Ç–µ'}
                                {board.id === 'completed' && '–°—é–¥–∞ –ø–æ–ø–∞–¥—É—Ç –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã üéâ'}
                                {board.id === 'dropped' && '–ò–≥—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∑–∞—à–ª–∏'}
                              </p>
                              {!viewingUser && board.id === 'backlog' && (
                                <button 
                                  onClick={() => setShowSearch(true)}
                                  className="px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg text-white text-sm transition-colors"
                                >
                                  + –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∏–≥—Ä—É
                                </button>
                              )}
                            </div>
                          )}
                          
                          {board.cards.length > 3 && !expandedBoards[board.id] && (
                            <button 
                              onClick={() => toggleExpand(board.id)}
                              className="w-full py-2 text-sm text-purple-400 hover:text-purple-300"
                            >
                              –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë {board.cards.length - 3} ‚Üí
                            </button>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  {!viewingUser && <ActivityFeed 
                    token={localStorage.getItem('token')} 
                    boardType="games" 
                    onNavigateToUser={(userId) => {
                      setViewingUser({ id: userId });
                      loadBoards(localStorage.getItem('token'), userId);
                    }}
                  />}

                  {!viewingUser && (
                    <div className="mt-8">
                      <div id="game-container" style={{
                          border: '2px solid #8b5cf6',
                          borderRadius: '12px',
                          overflow: 'hidden',
                          boxShadow: '0 0 20px rgba(139, 92, 246, 0.5)',
                          background: '#111',
                          position: 'relative',
                          width: '100%',
                          maxWidth: '900px',
                          margin: '0 auto'
                      }}>
                          <div id="game-reload-hint" className="absolute inset-0 bg-black flex items-center justify-center text-center text-gray-400 p-4 z-20">
                              <div>
                                  <p className="text-lg">–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
                                  <p className="text-sm mt-2">–ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ <a href="#" onClick={(e) => { e.preventDefault(); window.location.reload(); }} className="text-purple-400 underline">–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>.</p>
                              </div>
                          </div>

                          <canvas id="gameCanvas" ref={canvasRef} style={{ width: '100%', display: 'block', position: 'relative', zIndex: 1 }}></canvas>
                          
                          <div id="game-overlay" style={{ display: 'none', zIndex: 10 }}>
                              <h2 id="overlay-title"></h2>
                              <p id="final-score"></p>
                              <div id="high-scores" style={{ marginTop: '20px', display: 'none' }}>
                                   <p id="friend-record"><strong>–†–µ–∫–æ—Ä–¥ –¥—Ä—É–∑–µ–π:</strong> –ó–∞–≥—Ä—É–∑–∫–∞...</p>
                                   <p id="global-record"><strong>–û–±—â–∏–π —Ä–µ–∫–æ—Ä–¥:</strong> –ó–∞–≥—Ä—É–∑–∫–∞...</p>
                              </div>
                              <button id="restart-button"></button>
                          </div>
                      </div>
                    </div>
                  )}

              </div>
          </main>

          {/* Floating Action Button –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */}
          {!viewingUser && (
            <button
              onClick={() => setShowSearch(true)}
              className="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full shadow-lg flex items-center justify-center z-30 active:scale-95 transition-transform"
            >
              <Icon name="plus" className="w-7 h-7 text-white" />
            </button>
          )}

          {/* –ú–æ–±–∏–ª—å–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ –ø–æ–∏—Å–∫–∞ */}
          {showSearch && (
            <div className="md:hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
              <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-bold text-white">–ü–æ–∏—Å–∫ –∏–≥—Ä—ã</h2>
                  <button onClick={() => { setShowSearch(false); setSearchQuery(''); setSearchResults([]); setTargetBoardForAdd(null); }} className="p-2 hover:bg-gray-800 rounded-lg">
                    <Icon name="x" className="w-5 h-5 text-gray-400" />
                  </button>
                </div>
                <div className="space-y-4">
                  <div className="relative">
                    <input 
                      type="text" 
                      value={searchQuery} 
                      onChange={(e) => handleSearch(e.target.value)} 
                      placeholder="–ü–æ–∏—Å–∫ –∏–≥—Ä—ã..." 
                      className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none text-white placeholder-gray-500" 
                      autoFocus 
                    />
                  </div>
                  <div className="space-y-2 max-h-60 overflow-y-auto">
                    {searching ? (
                      <div className="flex items-center justify-center py-8">
                        <Icon name="loader" className="w-8 h-8 text-purple-400 animate-spin" />
                      </div>
                    ) : searchResults.length > 0 ? (
                      searchResults.map(game => (
                        <div key={game.id} className="bg-gray-800/50 rounded-lg p-3 border border-gray-700 hover:border-purple-500/50 transition-colors">
                          <div className="flex items-start gap-3">
                            <img 
                              src={game.cover} 
                              alt={game.name}
                              className="w-12 h-16 object-cover rounded-lg flex-shrink-0"
                            />
                            <div className="flex-1 min-w-0">
                              <h3 className="text-white font-semibold text-sm line-clamp-2 mb-1">
                                {game.name}
                              </h3>
                              <p className="text-gray-400 text-xs mb-2">
                                {game.release_date ? new Date(game.release_date).getFullYear() : '–ì–æ–¥ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}
                              </p>
                              <button
                                onClick={() => addGameToBoard(game, targetBoardForAdd || 'backlog')}
                                className="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg transition-colors"
                              >
                                –î–æ–±–∞–≤–∏—Ç—å
                              </button>
                            </div>
                          </div>
                        </div>
                      ))
                    ) : searchQuery.length >= 3 && !searching && (
                      <div className="text-center py-8">
                        <div className="text-4xl mb-2">üîç</div>
                        <p className="text-gray-400">–ò–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        <p className="text-sm text-gray-500 mt-1">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Bottom Sheet –¥–ª—è –º–µ–Ω—é –∫–∞—Ä—Ç–æ—á–∫–∏ */}
          {showCardMenu && selectedCard && (
            <>
              {/* Backdrop */}
              <div 
                className="fixed inset-0 bg-black/60 z-40"
                onClick={closeCardMenu}
              />
              
              {/* Bottom Sheet */}
              <div className="fixed bottom-0 left-0 right-0 bg-gray-900 rounded-t-3xl z-50 p-6 transform transition-transform">
                {/* Handle (–ø–æ–ª–æ—Å–∫–∞ –¥–ª—è drag) */}
                <div className="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-4"></div>
                
                {/* –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã */}
                <h3 className="text-white font-bold text-lg mb-4 text-center">
                  {selectedCard.name}
                </h3>
                
                {/* –î–µ–π—Å—Ç–≤–∏—è */}
                <div className="space-y-2">
                  <button 
                    onClick={() => {setSelectedGame(selectedCard); closeCardMenu();}}
                    className="w-full flex items-center gap-3 px-4 py-3 text-left text-white hover:bg-gray-800 rounded-lg"
                  >
                    üëÅÔ∏è <span>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</span>
                  </button>
                  
                  <button 
                    onClick={() => {/* TODO: open move menu */; closeCardMenu();}}
                    className="w-full flex items-center gap-3 px-4 py-3 text-left text-white hover:bg-gray-800 rounded-lg"
                  >
                    ‚û°Ô∏è <span>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤...</span>
                  </button>
                  
                  <button 
                    onClick={() => {/* TODO: deleteCard(selectedCard.id); */ closeCardMenu();}}
                    className="w-full flex items-center gap-3 px-4 py-3 text-left text-red-400 hover:bg-red-500/10 rounded-lg"
                  >
                    üóëÔ∏è <span>–£–¥–∞–ª–∏—Ç—å</span>
                  </button>
                  
                  <button 
                    onClick={closeCardMenu}
                    className="w-full py-3 text-gray-400 hover:text-white"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            </>
          )}

          {/* –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è */}
          {showMobileActionMenu && selectedCard && (
            <>
              {/* Backdrop */}
              <div 
                className="fixed inset-0 bg-black/60 z-40"
                onClick={closeMobileActionMenu}
              />
              
              {/* Action Menu */}
              <div className="fixed bottom-0 left-0 right-0 bg-gray-900 rounded-t-3xl z-50 p-6 transform transition-transform">
                {/* Handle (–ø–æ–ª–æ—Å–∫–∞ –¥–ª—è drag) */}
                <div className="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-4"></div>
                
                {/* –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã */}
                <h3 className="text-white font-bold text-lg mb-4 text-center">
                  {selectedCard.name}
                </h3>
                
                {/* –î–µ–π—Å—Ç–≤–∏—è */}
                <div className="space-y-3">
                  <button 
                    onClick={openEditModal}
                    className="w-full flex items-center gap-3 px-4 py-3 text-left text-white hover:bg-gray-800 rounded-lg border border-gray-700"
                  >
                    <div className="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                      ‚úèÔ∏è
                    </div>
                    <div>
                      <p className="font-semibold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</p>
                      <p className="text-sm text-gray-400">–ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥, –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤</p>
                    </div>
                  </button>
                  
                  <button 
                    onClick={() => {setShowMoveMenu(true); setShowMobileActionMenu(false);}}
                    className="w-full flex items-center gap-3 px-4 py-3 text-left text-white hover:bg-gray-800 rounded-lg border border-gray-700"
                  >
                    <div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                      ‚û°Ô∏è
                    </div>
                    <div>
                      <p className="font-semibold">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</p>
                      <p className="text-sm text-gray-400">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã</p>
                    </div>
                  </button>
                  
                  <button 
                    onClick={closeMobileActionMenu}
                    className="w-full py-3 text-gray-400 hover:text-white"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            </>
          )}

          {/* –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è */}
          {showMoveMenu && selectedCard && (
            <>
              {/* Backdrop */}
              <div 
                className="fixed inset-0 bg-black/60 z-40"
                onClick={() => {setShowMoveMenu(false); setSelectedCard(null);}}
              />
              
              {/* Move Menu */}
              <div className="fixed bottom-0 left-0 right-0 bg-gray-900 rounded-t-3xl z-50 p-6 transform transition-transform">
                {/* Handle */}
                <div className="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-4"></div>
                
                <h3 className="text-white font-bold text-lg mb-4 text-center">
                  –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å "{selectedCard.name}"
                </h3>
                
                <div className="space-y-2">
                  {Object.values(boards).map(board => (
                    <button 
                      key={board.id}
                      onClick={() => handleMoveToBoard(board.id)}
                      disabled={board.id === selectedCard.board_id}
                      className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg border transition-colors ${
                        board.id === selectedCard.board_id 
                          ? 'bg-gray-700/50 border-gray-600 text-gray-500 cursor-not-allowed' 
                          : 'text-white hover:bg-gray-800 border-gray-700'
                      }`}
                    >
                      <span className="text-2xl">{board.emoji}</span>
                      <div>
                        <p className="font-semibold">{board.title}</p>
                      </div>
                      {board.id === selectedCard.board_id && (
                        <span className="ml-auto text-xs bg-gray-600 px-2 py-1 rounded">–¢–µ–∫—É—â–∞—è</span>
                      )}
                    </button>
                  ))}
                  
                  <button 
                    onClick={() => {setShowMoveMenu(false); setSelectedCard(null);}}
                    className="w-full py-3 text-gray-400 hover:text-white mt-4"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            </>
          )}

          {/* –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–æ–≤ */}
          {showTagModal && selectedGameForTag && (
            <TagModal
              game={selectedGameForTag}
              token={localStorage.getItem('token')}
              onTagAdded={() => {
                loadBoards(localStorage.getItem('token'));
              }}
              isOpen={showTagModal}
              onClose={() => {
                setShowTagModal(false);
                setSelectedGameForTag(null);
              }}
            />
          )}


          {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ —Å–≤–æ—é –¥–æ—Å–∫—É */}
          {showAddToMyBoard && cardToAdd && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
              <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-purple-500/30 elevation-3">
                <h2 className="text-xl font-bold text-white mb-4">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É –∫ —Å–µ–±–µ</h2>
                <div className="mb-4">
                  <div className="flex gap-3 mb-3">
                    {cardToAdd.cover && (
                      <img src={cardToAdd.cover} alt={cardToAdd.name} className="w-16 h-24 object-cover rounded-lg" />
                    )}
                    <div>
                      <h3 className="text-white font-semibold">{cardToAdd.name}</h3>
                      {cardToAdd.description && (
                        <p className="text-gray-400 text-sm mt-1 line-clamp-2">{cardToAdd.description}</p>
                      )}
                    </div>
                  </div>
                </div>
                
                <div className="mb-6">
                  <label className="block text-white font-medium mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å–∫—É:</label>
                  <div className="grid grid-cols-2 gap-3">
                    {Object.values(boards).map(board => (
                      <button
                        key={board.id}
                        onClick={() => addCardToMyBoard(cardToAdd, board.id)}
                        className="p-3 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700 hover:border-purple-500 transition-all text-left"
                      >
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-xl">{board.emoji}</span>
                          <span className="text-white font-medium text-sm">{board.title}</span>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
                
                <div className="flex gap-2">
                  <button 
                    onClick={() => { setShowAddToMyBoard(false); setCardToAdd(null); }}
                    className="flex-1 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const DEEP_REVIEW_QUESTIONS = [
        { block: '–ü–µ—Ä–≤–æ–µ –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –∏ –°—é–∂–µ—Ç', questions: [
            { id: 1, text: "–ß—Ç–æ –≤–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∑–∞—Ü–µ–ø–∏–ª–æ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã?", answers: ["–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ –º–∏—Ä, –≤ –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–∑—É —Ö–æ—á–µ—Ç—Å—è –ø–æ–≥—Ä—É–∑–∏—Ç—å—Å—è", "–∏–Ω—Ç—Ä–∏–≥—É—é—â–∞—è –∑–∞–≤—è–∑–∫–∞ —Å—é–∂–µ—Ç–∞", "–¥–∏–Ω–∞–º–∏—á–Ω—ã–π –≥–µ–π–º–ø–ª–µ–π —Å –ø–µ—Ä–≤—ã—Ö –º–∏–Ω—É—Ç", "–ø–æ—Ç—Ä—è—Å–∞—é—â–∏–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏ –≥—Ä–∞—Ñ–∏–∫–∞", "–Ω–∏—á–µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ, –∏–≥—Ä–∞ —Ä–∞–∑–≥–æ–Ω—è–ª–∞—Å—å –º–µ–¥–ª–µ–Ω–Ω–æ", "—Å–∫—É—á–Ω–æ–µ –∏ –∑–∞—Ç—è–Ω—É—Ç–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ"] },
            { id: 2, text: "–ö–∞–∫ –±—ã –≤—ã –æ–ø–∏—Å–∞–ª–∏ —Å—é–∂–µ—Ç –∏–≥—Ä—ã?", answers: ["–≥–ª—É–±–æ–∫–∏–º –∏ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—ã–º, –∑–∞—Å—Ç–∞–≤–ª—è—é—â–∏–º –∑–∞–¥—É–º–∞—Ç—å—Å—è", "–ø—Ä–æ—Å—Ç—ã–º, –Ω–æ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º –∏ —Ö–æ—Ä–æ—à–æ –ø–æ–¥–∞–Ω–Ω—ã–º", "—ç–ø–∏—á–Ω—ã–º –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–º, —Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏", "–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º, –Ω–æ —Å–ª—É–∂–∞—â–∏–º —Ö–æ—Ä–æ—à–∏–º —Ñ–æ–Ω–æ–º", "–≤—Ç–æ—Ä–∏—á–Ω—ã–º, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ª–∏—à—å –¥–ª—è –≥–∞–ª–æ—á–∫–∏", "—Å–ª–∞–±—ã–º, –Ω–µ–ª–æ–≥–∏—á–Ω—ã–º –∏–ª–∏ –ø–æ–ø—Ä–æ—Å—Ç—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º"] },
            { id: 3, text: "–ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∏?", answers: ["–æ—á–µ–Ω—å –∂–∏–≤—ã–º–∏ –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º–∏—Å—è, –∏–º —Å–æ–ø–µ—Ä–µ–∂–∏–≤–∞–µ—à—å", "—Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–º–∏, —Ö–æ—Ç—å –∏ –Ω–µ–º–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–Ω—ã–º–∏", "–ø—Ä–æ—Å—Ç—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è —Å—é–∂–µ—Ç–∞", "—Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π/–≥–µ—Ä–æ–∏–Ω—è –±—ã–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏", "–Ω–µ–≤–∞–∂–Ω—ã–º–∏ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏", "–ø–ª–æ—Å–∫–∏–º–∏ –∏ –Ω–µ–≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–º–∏, —Å–∫–æ—Ä–µ–µ —Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–∏–º–∏"] },
            { id: 4, text: "–ó–∞–ø–æ–º–Ω–∏–ª—Å—è –ª–∏ –≤–∞–º –º–∏—Ä –∏–≥—Ä—ã (–ª–æÃÅ—Ä)?", answers: ["–¥–∞, —ç—Ç–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –≤—Å–µ–ª–µ–Ω–Ω–∞—è", "–º–∏—Ä –±—ã–ª –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω, –Ω–æ –º–Ω–æ–≥–æ–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞ –∫–∞–¥—Ä–æ–º", "–æ–Ω —Å–ª—É–∂–∏–ª –ª–∏—à—å –∫—Ä–∞—Å–∏–≤–æ–π –¥–µ–∫–æ—Ä–∞—Ü–∏–µ–π", "–º–∏—Ä –¥–æ–≤–æ–ª—å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–ª—è —Å–≤–æ–µ–≥–æ –∂–∞–Ω—Ä–∞", "–≤ –∏–≥—Ä–µ –Ω–µ –±—ã–ª–æ –∞–∫—Ü–µ–Ω—Ç–∞ –Ω–∞ –≥–ª—É–±–æ–∫–∏–π –ª–æ—Ä", "–º–∏—Ä –ø–æ–∫–∞–∑–∞–ª—Å—è –ø—É—Å—Ç—ã–º –∏ –±–µ–∑–∂–∏–∑–Ω–µ–Ω–Ω—ã–º"] },
        ]},
        { block: '–ì–µ–π–º–ø–ª–µ–π –∏ –ú–µ—Ö–∞–Ω–∏–∫–∏', questions: [
            { id: 5, text: "–ö–∞–∫–æ–µ —Å–ª–æ–≤–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –≥–µ–π–º–ø–ª–µ–π?", answers: ["–º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã–º", "–¥–∏–Ω–∞–º–∏—á–Ω—ã–º", "—Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–º", "–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º", "–∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º", "–æ–¥–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º"] },
            { id: 6, text: "–ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã –∏–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏?", answers: ["–ø—Ä–µ–¥–ª–∞–≥–∞–ª–∏ —á—Ç–æ-—Ç–æ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–æ–≤–æ–µ", "—Å–æ—á–µ—Ç–∞–ª–∏ –∑–Ω–∞–∫–æ–º—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏–¥–µ—è–º–∏", "–±—ã–ª–∏ –æ—Ç–ª–∏—á–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–µ–º –∏–¥–µ–π", "–±—ã–ª–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–º–∏, –±–µ–∑ –∏–∑—ã—Å–∫–æ–≤", "–∫–∞–∑–∞–ª–∏—Å—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –∏–ª–∏ –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–º–∏", "–±—ã–ª–∏ —Å–ª–æ–º–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ –ø–ª–æ—Ö–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏"] },
            { id: 7, text: "–ë—ã–ª–æ –ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–≥—Ä–µ —É–¥–æ–±–Ω—ã–º?", answers: ["–∞–±—Å–æ–ª—é—Ç–Ω–æ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–º –∏ –æ—Ç–∑—ã–≤—á–∏–≤—ã–º", "–≤ —Ü–µ–ª–æ–º —É–¥–æ–±–Ω—ã–º, –Ω–æ —Ç—Ä–µ–±–æ–≤–∞–ª–æ –ø—Ä–∏–≤—ã–∫–∞–Ω–∏—è", "–ø—Ä–æ—Å—Ç—ã–º, —Ç–∞–º –Ω–µ–≥–¥–µ –±—ã–ª–æ –æ—à–∏–±–∏—Ç—å—Å—è", "—Å–ø–æ—Ä–Ω—ã–º, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –±—ã–ª–æ –Ω–µ—É–¥–æ–±–Ω–æ", "—á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ", "—É–∂–∞—Å–Ω—ã–º, –∏ —ç—Ç–æ —Å—Ç–∞–ª–æ –≥–ª–∞–≤–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π"] },
            { id: 8, text: "–ù–∞—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–µ–Ω –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å?", answers: ["–ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–¥–∫–∏–¥—ã–≤–∞–ª –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Å–∏—Ç—É–∞—Ü–∏–∏", "–±—ã–ª –æ–¥–Ω–æ–æ–±—Ä–∞–∑–µ–Ω, –Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∑–∞—Ç—è–≥–∏–≤–∞–ª", "–≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –Ω–∞—á–∞–ª –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è", "–Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è, —Ç–∞–∫ –∫–∞–∫ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ–¥–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∫–µ", "–∫ –∫–æ–Ω—Ü—É —Å—Ç–∞–ª –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ —Ä—É—Ç–∏–Ω–Ω—ã–º", "–Ω–∞—Å–∫—É—á–∏–ª —É–∂–µ –≤ –ø–µ—Ä–≤—ã–π —á–∞—Å –∏–∑-–∑–∞ –æ–¥–Ω–æ–æ–±—Ä–∞–∑–∏—è"] },
            { id: 9, text: "–ß—Ç–æ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ (—Ä–∞–∑–≤–∏—Ç–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π)?", answers: ["–ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è –æ—â—É—â–∞–ª–∞—Å—å –ø–ª–∞–≤–Ω–æ–π –∏ –Ω–∞–≥—Ä–∞–∂–¥–∞—é—â–µ–π", "–æ–Ω–∞ –±—ã–ª–∞, –Ω–æ –Ω–µ —Å–∏–ª—å–Ω–æ –≤–ª–∏—è–ª–∞ –Ω–∞ –≥–µ–π–º–ø–ª–µ–π", "–Ω–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ", "–≤ –∏–≥—Ä–µ –Ω–µ –±—ã–ª–æ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏", "–ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è –±—ã–ª–∞ —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ–π –∏ —Ç—Ä–µ–±–æ–≤–∞–ª–∞ –≥—Ä–∏–Ω–¥–∞", "–±—ã–ª–∞ –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π"] },
        ]},
        { block: '–ê—É–¥–∏–æ–≤–∏–∑—É–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ', questions: [
            { id: 10, text: "–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏–≥—Ä—ã?", answers: ["–Ω–∞—Å—Ç–æ—è—â–∏–º —à–µ–¥–µ–≤—Ä–æ–º, –≥–¥–µ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä ‚Äî –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞", "–æ—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω—ã–º –∏ —Å—Ç–∏–ª—å–Ω—ã–º, –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–º –Ω–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É", "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–º, –Ω–æ –±–µ–∑ –æ—Å–æ–±–æ–π ¬´–¥—É—à–∏¬ª", "–Ω–µ–ø–ª–æ—Ö–∏–º, –Ω–æ –Ω–∏—á–µ–º –Ω–µ –≤—ã–¥–µ–ª—è—é—â–∏–º—Å—è", "—Å–ª–∞–±—ã–º –º–µ—Å—Ç–æ–º –∏–≥—Ä—ã", "—É—Å—Ç–∞—Ä–µ–≤—à–∏–º –∏–ª–∏ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–º"] },
            { id: 11, text: "–ù–∞—Å–∫–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –±—ã–ª —Å–∞—É–Ω–¥-–¥–∏–∑–∞–π–Ω?", answers: ["–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω—ã–º, –º—É–∑—ã–∫–∞ –∏ –∑–≤—É–∫–∏ ‚Äî –ø–æ–ª–æ–≤–∏–Ω–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã", "—Ö–æ—Ä–æ—à–∏–º –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º—Å—è", "–ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è–ª —Å–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é, –Ω–µ –±–æ–ª–µ–µ", "—è –ø–æ—á—Ç–∏ –Ω–µ –æ–±—Ä–∞—â–∞–ª –Ω–∞ –Ω–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è", "—Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–∏–º —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º", "–æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ –ø–ª–æ—Ö–∏–º"] },
            { id: 12, text: "–ó–∞–ø–æ–º–Ω–∏–ª—Å—è –ª–∏ –≤–∞–º –∫–∞–∫–æ–π-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞—Å–ø–µ–∫—Ç –¥–∏–∑–∞–π–Ω–∞?", answers: ["–≤–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω —É—Ä–æ–≤–Ω–µ–π/–ª–æ–∫–∞—Ü–∏–π", "–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –≤—Ä–∞–≥–æ–≤", "—É–¥–æ–±–Ω—ã–π –∏ –∫—Ä–∞—Å–∏–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å", "–≤ —Ü–µ–ª–æ–º –≤—Å–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–æ –±–µ–∑ –≤–∞—É-—ç—Ñ—Ñ–µ–∫—Ç–∞", "–Ω–µ—Ç, –Ω–∏—á–µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–µ –∑–∞–ø–æ–º–Ω–∏–ª–æ—Å—å", "–Ω–µ—É–¥–æ–±–Ω—ã–µ –∏–ª–∏ –≤—ã–∑—ã–≤–∞—é—â–∏–µ –Ω–µ–¥–æ—É–º–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–∏–∑–∞–π–Ω–∞"] },
            { id: 13, text: "–ö–∞–∫ –æ–±—Å—Ç–æ—è–ª–∏ –¥–µ–ª–∞ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π (–±–∞–≥–∏, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)?", answers: ["–∏–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –∏–¥–µ–∞–ª—å–Ω–æ", "–±—ã–ª–∏ –º–µ–ª–∫–∏–µ, –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥–∏", "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –º–µ—à–∞–ª–∏", "–∏–≥—Ä–∞ –±—ã–ª–∞ –ø–ª–æ—Ö–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞", "–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–æ—Å—å –≤ –º—É—á–µ–Ω–∏–µ –∏–∑-–∑–∞ –±–∞–≥–æ–≤", "–∏–≥—Ä–∞ —á–∞—Å—Ç–æ –≤—ã–ª–µ—Ç–∞–ª–∞ –∏–ª–∏ –∏–º–µ–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏"] },
        ]},
        { block: '–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', questions: [
            { id: 14, text: "–ö–∞–∫ –±—ã –≤—ã –æ–ø–∏—Å–∞–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏–≥—Ä—ã?", answers: ["—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π ‚Äî –±—Ä–æ—Å–∞—é—â–µ–π –≤—ã–∑–æ–≤, –Ω–æ –Ω–µ –¥—É—à–∞—â–µ–π", "–≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π –ø–æ–¥ —Å–µ–±—è", "–¥–æ–≤–æ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π, –º–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏, –Ω–µ –Ω–∞–ø—Ä—è–≥–∞—è—Å—å", "–æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–π, –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π —Ö–∞—Ä–¥–∫–æ—Ä–∞", "–Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π –∏–∑-–∑–∞ –Ω–µ—É–¥–æ–±–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∫", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π, –Ω–∏–∫–∞–∫–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∏–≥—Ä–∞ –Ω–µ –±—Ä–æ—Å–∏–ª–∞"] },
            { id: 15, text: "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–≥—Ä—ã –≤–∞—à–∏–º –æ–∂–∏–¥–∞–Ω–∏—è–º?", answers: ["–∏–¥–µ–∞–ª—å–Ω–æ–π, –∏–≥—Ä–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –≤–æ–≤—Ä–µ–º—è", "—Ö–æ—Ç–µ–ª–æ—Å—å –±—ã, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –ø–æ–¥–ª–∏–Ω–Ω–µ–µ", "—ç—Ç–æ –∏–≥—Ä–∞-—Å–µ—Ä–≤–∏—Å –±–µ–∑ —á–µ—Ç–∫–æ–≥–æ –∫–æ–Ω—Ü–∞", "–æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–π, –æ–Ω–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ", "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞—Ç—è–Ω—É—Ç–æ–π", "–Ω–µ–æ–ø—Ä–∞–≤–¥–∞–Ω–Ω–æ –¥–ª–∏–Ω–Ω–æ–π"] },
            { id: 16, text: "–ö–∞–∫ –≤ –∏–≥—Ä–µ –æ—â—É—â–∞–µ—Ç—Å—è —Ç–µ–º–ø –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –≥–µ–π–º–ø–ª–µ—è?", answers: ["–æ—Ç–ª–∏—á–Ω—ã–º, –∏–≥—Ä–∞ –¥–µ—Ä–∂–∏—Ç –≤ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–∏ –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞", "—Å–ø–æ–∫–æ–π–Ω—ã–º –∏ —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω—ã–º", "–Ω–µ—Ä–æ–≤–Ω—ã–º, —Å –¥–∏–Ω–∞–º–∏—á–Ω—ã–º–∏ –∏ –ø—Ä–æ–≤–∏—Å–∞—é—â–∏–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏", "—Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä—ã–º, –Ω–µ –¥–∞—é—â–∏–º –ø—Ä–æ–Ω–∏–∫–Ω—É—Ç—å—Å—è —Å—é–∂–µ—Ç–æ–º", "—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω—ã–º, –º–µ—Å—Ç–∞–º–∏ –±—ã–ª–æ —Å–∫—É—á–Ω–æ", "—Ä–≤–∞–Ω—ã–º –∏ –Ω–µ–ª–æ–≥–∏—á–Ω—ã–º"] },
        ]},
        { block: '–ò—Ç–æ–≥–æ–≤—ã–µ –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è', questions: [
            { id: 17, text: "–ö–∞–∫–∏–µ —ç–º–æ—Ü–∏–∏ –∏–≥—Ä–∞ –≤—ã–∑—ã–≤–∞–ª–∞ —É –≤–∞—Å —á–∞—â–µ –≤—Å–µ–≥–æ?", answers: ["–≤–æ—Å—Ç–æ—Ä–≥ –∏ —É–¥–∏–≤–ª–µ–Ω–∏–µ", "—Ä–∞–¥–æ—Å—Ç—å –∏ –≤–µ—Å–µ–ª—å–µ", "–∏–Ω—Ç–µ—Ä–µ—Å –∏ –∞–∑–∞—Ä—Ç", "—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ —É–º–∏—Ä–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ", "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏ –¥–∞–∂–µ —Å—Ç—Ä–∞—Ö", "—Å–∫—É–∫—É –∏ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ"] },
            { id: 18, text: "–ß—Ç–æ –≤–∞–º –∑–∞–ø–æ–º–Ω–∏—Ç—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è?", answers: ["—Ñ–∏–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏", "–æ–¥–Ω–∞ –∏–∑ –∏–≥—Ä–æ–≤—ã—Ö –º–µ—Ö–∞–Ω–∏–∫", "–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ –∫—Ä–∞—Å–æ—Ç–∞ –º–∏—Ä–∞", "–ø–æ–±–µ–¥–∞ –Ω–∞–¥ —Å–ª–æ–∂–Ω—ã–º –±–æ—Å—Å–æ–º", "–≤—Ä–µ–º—è, –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–µ —Å –¥—Ä—É–∑—å—è–º–∏", "—Å–æ–∂–∞–ª–µ–Ω–∏–µ –æ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"] },
            { id: 19, text: "–ö–æ–º—É –±—ã –≤—ã –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª–∏ —ç—Ç—É –∏–≥—Ä—É?", answers: ["–∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ–º, —ç—Ç–æ –º–∞—Å—Ç-–ø–ª–µ–π", "–ª—é–±–∏—Ç–µ–ª—è–º –∂–∞–Ω—Ä–∞", "–∏—Å–∫–∞—Ç–µ–ª—è–º –≥–ª—É–±–æ–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏", "–∏–≥—Ä–æ–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è", "—Ö–∞—Ä–¥–∫–æ—Ä–Ω—ã–º –≥–µ–π–º–µ—Ä–∞–º, –∏—â—É—â–∏–º –≤—ã–∑–æ–≤", "–Ω–∏–∫–æ–º—É, –ª—É—á—à–µ –ø—Ä–æ–π—Ç–∏ –º–∏–º–æ"] },
            { id: 20, text: "–ï—Å–ª–∏ –æ–ø–∏—Å–∞—Ç—å –∏–≥—Ä—É –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π, —Ç–æ —ç—Ç–æ...", answers: ["...–Ω–µ–∑–∞–±—ã–≤–∞–µ–º–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ.", "...—É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ –¥–ª—è —É–º–∞.", "...—á–∏—Å—Ç–æ–µ, –Ω–µ–∑–∞–º—É—Ç–Ω–µ–Ω–Ω–æ–µ –≤–µ—Å–µ–ª—å–µ.", "...–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞.", "...–∫—Ä–µ–ø–∫–∏–π —Å–µ—Ä–µ–¥–Ω—è–∫, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ–∏—Ç —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.", "...–ø–æ–ª–Ω–æ–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ."] },
        ]},
    ];
    
    const DeepReviewModal = ({ game, existingAnswers, onClose, onSubmit }) => {
        const [answers, setAnswers] = useState(() => {
            const initial = Array(20).fill(null);
            if (existingAnswers && Array.isArray(existingAnswers) && existingAnswers.length === 20) {
                return existingAnswers;
            }
            return initial;
        });
        const [currentStep, setCurrentStep] = useState(0);

        const handleAnswer = (qIndex, aIndex) => {
            const newAnswers = [...answers];
            newAnswers[qIndex] = aIndex;
            setAnswers(newAnswers);
        };

        const allQuestionsFlat = DEEP_REVIEW_QUESTIONS.flatMap(b => b.questions);
        const currentQuestion = allQuestionsFlat[currentStep];

        const answeredCount = answers.filter(a => a !== null).length;
        const allAnswered = answeredCount === 20;

        return (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                <div className="bg-gray-900 rounded-2xl p-6 w-full max-w-2xl border border-purple-500/30 max-h-[90vh] flex flex-col elevation-3">
                    <h2 className="text-2xl font-bold text-white mb-2">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ –æ {game.name}</h2>
                    <p className="text-gray-400 mb-4 text-sm">–í–æ–ø—Ä–æ—Å {currentStep + 1} –∏–∑ 20</p>
                    
                    <div className="w-full bg-gray-700 rounded-full h-2.5 mb-6">
                        <div className="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style={{ width: `${((currentStep + 1) / 20) * 100}%` }}></div>
                    </div>

                    <div className="flex-grow overflow-y-auto pr-2">
                        <p className="text-white text-lg mb-4">{currentQuestion.text}</p>
                        <div className="flex flex-col space-y-2">
                            {currentQuestion.answers.map((ans, aIndex) => (
                                <button 
                                    key={aIndex}
                                    onClick={() => handleAnswer(currentStep, aIndex)}
                                    className={`text-left p-3 rounded-lg text-sm transition-colors ${answers[currentStep] === aIndex ? 'bg-purple-500/50 text-white' : 'bg-gray-800 hover:bg-gray-700 text-gray-300'}`}
                                >
                                    {ans}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex justify-between items-center mt-6 pt-4 border-t border-gray-700">
                        <button onClick={() => setCurrentStep(s => s - 1)} disabled={currentStep === 0} className="py-2 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700 disabled:opacity-50 flex items-center gap-2">
                            <Icon name="arrowLeft" className="w-4 h-4" /> –ù–∞–∑–∞–¥
                        </button>
                        
                        {currentStep < 19 ? (
                            <button onClick={() => setCurrentStep(s => s + 1)} disabled={answers[currentStep] === null} className="py-2 px-4 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50 flex items-center gap-2">
                                –î–∞–ª–µ–µ <Icon name="arrowRight" className="w-4 h-4" />
                            </button>
                        ) : (
                            <button onClick={() => onSubmit(game.id, answers)} disabled={!allAnswered} className="py-2 px-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-lg disabled:opacity-50">
                                {allAnswered ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å'}
                            </button>
                        )}
                        
                        <button onClick={onClose} className="py-2 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        );
    };
    
    const generateReviewText = (answers) => {
        if (!answers || answers.length < 20) return null;

        const allQuestions = DEEP_REVIEW_QUESTIONS.flatMap(b => b.questions);
        
        const getAnswer = (qId) => {
            const answerIndex = answers[qId - 1];
            if (answerIndex === null) return { text: '', sentiment: 0 };
            
            const text = allQuestions[qId - 1].answers[answerIndex];
            let sentiment = 0;
            if (answerIndex <= 2) sentiment = 1;
            else if (answerIndex >= 4) sentiment = -1;
            
            return { text, sentiment };
        };

        let paragraphs = [];

        const intro = getAnswer(1);
        const plot = getAnswer(2);
        const chars = getAnswer(3);
        let p1 = `–° —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä–∞ —É–≤–ª–µ–∫–∞–µ—Ç, –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å, —Å–≤–æ–µ–π ${intro.text}. `;
        if (intro.sentiment < 0) {
            p1 = `–í–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –æ—Ç —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã –æ–∫–∞–∑–∞–ª–∏—Å—å —Å–º–∞–∑–∞–Ω–Ω—ã–º–∏: –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å ${intro.text}. `;
        }
        
        if (plot.sentiment > 0) {
            p1 += `–°—é–∂–µ—Ç –º–æ–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å –∫–∞–∫ ${plot.text}.`;
        } else {
            p1 += `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∏—Å—Ç–æ—Ä–∏—è –æ–∫–∞–∑–∞–ª–∞—Å—å ${plot.text}.`;
        }

        if (chars.text === "—Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π/–≥–µ—Ä–æ–∏–Ω—è –±—ã–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏") {
             p1 += ` –ß—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Ç–æ –≤—ã–¥–µ–ª–∏—Ç—å –º–æ–∂–Ω–æ –±—ã–ª–æ –ª–∏—à—å –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è.`;
        } else {
             p1 += ` –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –æ—â—É—â–∞–ª–∏—Å—å –∫–∞–∫ ${chars.text}.`;
        }
        paragraphs.push(p1);

        const gameplay = getAnswer(5);
        const mechanics = getAnswer(6);
        const controls = getAnswer(7);
        let p2 = `–í –æ—Å–Ω–æ–≤–µ —Å–≤–æ–µ–π –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å ${gameplay.text}. `;
        
        if (mechanics.sentiment > 0) {
            p2 += `–ü—Ä–∏—è—Ç–Ω–æ —É–¥–∏–≤–∏–ª–æ —Ç–æ, —á—Ç–æ –∏–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ ${mechanics.text}. `;
        } else if (mechanics.sentiment < 0) {
            p2 += `–û–¥–Ω–∞–∫–æ, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –æ–Ω –Ω–µ –±–ª–µ—â–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –º–µ—Ö–∞–Ω–∏–∫–∏ ${mechanics.text}. `;
        }
        
        if (controls.sentiment < 0) {
            p2 += `–ù–µ–∫–æ—Ç–æ—Ä—ã–º –º–∏–Ω—É—Å–æ–º —Å—Ç–∞–ª–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ ${controls.text}.`;
        }
        paragraphs.push(p2);
        
        const visual = getAnswer(10);
        const sound = getAnswer(11);
        const tech = getAnswer(13);
        let p3 = `–í–∏–∑—É–∞–ª—å–Ω–æ –∏–≥—Ä–∞ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ ${visual.text}. `;

        if (sound.sentiment > 0) {
            p3 += `–≠—Ç–æ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω—è–µ—Ç ${sound.text} —Å–∞—É–Ω–¥-–¥–∏–∑–∞–π–Ω. `;
        } else {
            p3 += `–ü—Ä–∏ —ç—Ç–æ–º –∑–≤—É–∫ –≤ –∏–≥—Ä–µ –±—ã–ª ${sound.text}. `;
        }
        
        if (tech.sentiment < 1) {
            p3 += `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –Ω–µ–∏–¥–µ–∞–ª—å–Ω–∞: ${tech.text}.`;
        }
        paragraphs.push(p3);

        const difficulty = getAnswer(14);
        const recommendation = getAnswer(19);
        const summary = getAnswer(20);
        let p4 = `–ü–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç ${difficulty.text}. `;
        
        if (recommendation.sentiment > 0) {
            p4 += `–Ø –±—ã –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞–ª —ç—Ç—É –∏–≥—Ä—É ${recommendation.text}. `;
        } else {
            p4 += `–°–æ–≤–µ—Ç–æ–≤–∞—Ç—å —ç—Ç—É –∏–≥—Ä—É —è –±—ã –Ω–µ —Å—Ç–∞–ª, —Ä–∞–∑–≤–µ —á—Ç–æ ${recommendation.text}. `;
        }
        p4 += `–ü–æ–¥–≤–æ–¥—è –∏—Ç–æ–≥, –¥–ª—è –º–µ–Ω—è —ç—Ç–æ ${summary.text}`;
        paragraphs.push(p4);

        return paragraphs.join('\n\n');
    };
    
    const DisplayDeepReview = ({ answers }) => {
        const [isExpanded, setIsExpanded] = useState(false);
        const reviewText = generateReviewText(answers);
        if (!reviewText) return null;

        const snippet = reviewText.substring(0, 200);

        return (
            <div className="mt-4 pt-4 border-t border-gray-700">
                <h4 className="text-lg font-semibold text-purple-300 mb-2">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤</h4>
                <p className="text-gray-300 whitespace-pre-wrap">
                    {isExpanded ? reviewText : `${snippet}...`}
                </p>
                {reviewText.length > 200 && (
                    <button onClick={() => setIsExpanded(!isExpanded)} className="text-purple-400 hover:text-purple-300 mt-2">
                        {isExpanded ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é'}
                    </button>
                )}
            </div>
        );
    };


    ReactDOM.render(<GameKanban />, document.getElementById('root'));
  </script>
</body>
</html>
